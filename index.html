<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>blustu‚Ñ¢ ‚Äî Internal Panel</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700;1,9..40,300&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
:root {
  --blue:#2198ED;--blue-light:#E8F4FD;--blue-dark:#1478C4;--blue-glow:rgba(33,152,237,.18);
  --white:#FFFFFF;--off-white:#F8F9FC;
  --gray-50:#F4F5F8;--gray-100:#E8EAF0;--gray-200:#CDD1DE;--gray-400:#8B93A8;--gray-600:#4A5168;--gray-900:#0F1120;
  --green:#10B981;--green-light:#ECFDF5;--amber:#F59E0B;--amber-light:#FFFBEB;--red:#EF4444;--red-light:#FEF2F2;
  --sidebar-w:240px;--radius:14px;
  --shadow-sm:0 1px 3px rgba(15,17,32,.06),0 1px 2px rgba(15,17,32,.04);
  --shadow-md:0 4px 16px rgba(15,17,32,.08),0 2px 6px rgba(15,17,32,.05);
  --shadow-lg:0 12px 40px rgba(15,17,32,.12),0 4px 12px rgba(15,17,32,.06);
}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'DM Sans',sans-serif;background:var(--off-white);color:var(--gray-900);display:flex;min-height:100vh;font-size:14px;line-height:1.5;}

/* ‚îÄ‚îÄ AUTH SCREEN ‚îÄ‚îÄ */
#authScreen{position:fixed;inset:0;background:linear-gradient(135deg,#f0f8ff 0%,var(--white) 60%,#f8fbff 100%);z-index:9999;display:flex;align-items:center;justify-content:center;}
#authScreen.hidden{display:none;}
#authScreen::before{content:'';position:fixed;top:-120px;right:-120px;width:400px;height:400px;border-radius:50%;background:radial-gradient(circle,rgba(33,152,237,.12) 0%,transparent 70%);pointer-events:none;}
#authScreen::after{content:'';position:fixed;bottom:-80px;left:-80px;width:280px;height:280px;border-radius:50%;background:radial-gradient(circle,rgba(33,152,237,.08) 0%,transparent 70%);pointer-events:none;}
.auth-box{width:400px;padding:48px 40px;background:var(--white);border:1px solid rgba(33,152,237,.15);border-radius:20px;box-shadow:0 20px 60px rgba(33,152,237,.1),0 4px 16px rgba(15,17,32,.06);}
.auth-logo{margin-bottom:28px;text-align:center;}
.auth-logo-wrap{display:inline-flex;align-items:center;justify-content:center;background:var(--blue);padding:10px 20px;border-radius:12px;box-shadow:0 4px 16px rgba(33,152,237,.35);}
.auth-logo-wrap img{height:28px;filter:brightness(0) invert(1);}
.auth-title{font-family:'DM Serif Display',serif;font-size:24px;color:var(--gray-900);margin-bottom:6px;text-align:center;}
.auth-sub{font-size:13px;color:var(--gray-400);text-align:center;margin-bottom:28px;}
.auth-error{background:var(--red-light);color:var(--red);font-size:12px;font-weight:600;padding:10px 14px;border-radius:8px;margin-bottom:16px;display:none;}

/* ‚îÄ‚îÄ ONBOARDING PORTAL ‚îÄ‚îÄ */
#onboardPortal{position:fixed;inset:0;background:var(--off-white);z-index:9998;display:none;overflow-y:auto;}
#onboardPortal.show{display:block;}
/* Portal buttons need explicit pointer-events to survive any inherited none */
#onboardPortal .btn,
#onboardPortal input,
#onboardPortal textarea,
#onboardPortal select {pointer-events:auto;}
#onboardPortal.show{display:block;}
.portal-wrap{max-width:620px;margin:40px auto;padding:0 20px 60px;}
.portal-header{background:var(--white);border-radius:var(--radius);padding:28px;margin-bottom:20px;border:1px solid var(--gray-100);}
.portal-logo{height:28px;margin-bottom:16px;}
.portal-title{font-family:'DM Serif Display',serif;font-size:22px;margin-bottom:4px;}
.portal-sub{font-size:13px;color:var(--gray-400);}
.portal-section{background:var(--white);border:1px solid var(--gray-100);border-radius:var(--radius);padding:24px;margin-bottom:16px;}
.portal-section-title{font-size:14px;font-weight:700;color:var(--gray-900);margin-bottom:16px;display:flex;align-items:center;gap:8px;}
.portal-section-title span{background:var(--blue);color:white;width:22px;height:22px;border-radius:50%;font-size:11px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.portal-step{display:none;}
.portal-step.active{display:block;}
.creator-grid-card:hover { border-color: var(--blue) !important; box-shadow: var(--shadow-md); transform: translateY(-1px); }
.creator-grid-card.selected { border-color: var(--blue) !important; background: var(--blue-light) !important; }

.portal-progress{display:flex;gap:6px;margin-bottom:24px;}
.portal-progress-dot{flex:1;height:4px;border-radius:2px;background:var(--gray-200);}
.portal-progress-dot.done{background:var(--blue);}
.rate-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{width:var(--sidebar-w);background:var(--white);border-right:1px solid var(--gray-100);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;}
.sidebar-logo{padding:20px 20px 18px;border-bottom:1px solid var(--gray-100);display:flex;flex-direction:column;gap:4px;position:relative;background:linear-gradient(135deg,#0c2340 0%,#133a5e 100%);}
.sidebar-logo img{width:90px;height:auto;cursor:pointer;filter:brightness(0) invert(1);}
.sidebar-logo .tagline{font-size:11px;color:rgba(255,255,255,.45);font-weight:400;}
.logo-tooltip{position:absolute;left:20px;top:calc(100% + 6px);background:var(--gray-900);color:white;font-size:11px;padding:5px 10px;border-radius:6px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity .15s;z-index:200;}
.sidebar-logo:hover .logo-tooltip{opacity:1;}
.sidebar-nav{flex:1;padding:16px 12px;overflow-y:auto;}
.nav-section-label{font-size:10px;font-weight:600;color:var(--gray-400);letter-spacing:.8px;text-transform:uppercase;padding:0 8px;margin:16px 0 6px;}
.nav-section-label:first-child{margin-top:0;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:10px;cursor:pointer;color:var(--gray-600);font-weight:500;font-size:13.5px;transition:all .15s;margin-bottom:2px;border:none;background:none;width:100%;text-align:left;}
.nav-item:hover{background:var(--gray-50);color:var(--gray-900);}
.nav-item.active{background:var(--blue-light);color:var(--blue);font-weight:600;border-left:3px solid var(--blue);padding-left:7px;}
.nav-item .icon{width:18px;height:18px;flex-shrink:0;opacity:.7;}
.nav-item.active .icon{opacity:1;}
.nav-badge{margin-left:auto;background:var(--blue);color:white;font-size:10px;font-weight:700;padding:1px 6px;border-radius:20px;min-width:18px;text-align:center;}
.sidebar-footer{padding:16px 12px;border-top:1px solid var(--gray-100);}
.sidebar-user{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:10px;cursor:pointer;}
.sidebar-user:hover{background:var(--gray-50);}
.user-avatar{width:32px;height:32px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white;flex-shrink:0;}
.user-info .name{font-size:13px;font-weight:600;color:var(--gray-900);}
.user-info .role{font-size:11px;color:var(--gray-400);}
.user-role-badge{font-size:10px;font-weight:700;padding:2px 7px;border-radius:20px;background:var(--blue-light);color:var(--blue);margin-top:2px;display:inline-block;}
.logout-btn{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;font-size:12px;color:var(--red);cursor:pointer;margin-top:6px;width:100%;border:none;background:none;font-family:'DM Sans',sans-serif;}
.logout-btn:hover{background:var(--red-light);}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;}
/* topbar defined in accent section */
.topbar-title{font-family:'DM Serif Display',serif;font-size:18px;color:var(--gray-900);flex:1;}
.topbar-search{display:flex;align-items:center;gap:8px;background:var(--gray-50);border:1px solid var(--gray-100);border-radius:10px;padding:7px 12px;width:220px;}
.topbar-search input{border:none;background:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--gray-900);width:100%;}
.topbar-search input::placeholder{color:var(--gray-400);}
.btn{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;border:none;}
.btn-primary{background:var(--blue);color:white;}
.btn-primary:hover{background:var(--blue-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(26,92,255,.3);}
.btn-ghost{background:transparent;color:var(--gray-600);border:1px solid var(--gray-200);}
.btn-ghost:hover{background:var(--gray-50);color:var(--gray-900);}
.btn-danger{background:var(--red-light);color:var(--red);border:1px solid var(--red-light);}
.btn-danger:hover{background:var(--red);color:white;}
.btn-sm{padding:6px 12px;font-size:12px;}
.btn:disabled{opacity:.45;cursor:not-allowed;transform:none!important;box-shadow:none!important;}
.content{padding:28px;flex:1;}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{display:none;animation:fadeIn .2s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--white);border:1px solid var(--gray-100);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);}
.card-title{font-size:13px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px;}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px;}
.stat-label{font-size:12px;color:var(--gray-400);font-weight:500;margin-bottom:6px;}
.stat-value{font-family:'DM Serif Display',serif;font-size:32px;color:var(--gray-900);line-height:1;}
.stat-change{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:600;margin-top:6px;padding:2px 7px;border-radius:20px;}
.stat-change.up{color:var(--green);background:var(--green-light);}
.stat-change.neutral{color:var(--gray-400);background:var(--gray-100);}

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:20px;margin-bottom:20px;}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
th{text-align:left;font-size:11px;font-weight:700;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px;padding:10px 12px;border-bottom:1px solid var(--gray-100);background:var(--gray-50);}
th:first-child{border-radius:8px 0 0 0;}th:last-child{border-radius:0 8px 0 0;}
td{padding:12px;border-bottom:1px solid var(--gray-100);font-size:13px;color:var(--gray-600);vertical-align:middle;}
tr:last-child td{border-bottom:none;}
tr:hover td{background:var(--gray-50);}

/* ‚îÄ‚îÄ CREATOR ‚îÄ‚îÄ */
.creator-cell{display:flex;align-items:center;gap:10px;}
.creator-avatar{width:34px;height:34px;border-radius:50%;flex-shrink:0;font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;color:white;}
.creator-name{font-weight:600;color:var(--gray-900);font-size:13px;}
.creator-handle{font-size:11px;color:var(--gray-400);}

/* ‚îÄ‚îÄ BADGES ‚îÄ‚îÄ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.badge-green{background:var(--green-light);color:var(--green);}
.badge-blue{background:var(--blue-light);color:var(--blue);}
.badge-amber{background:var(--amber-light);color:var(--amber);}
.badge-red{background:var(--red-light);color:var(--red);}
.badge-gray{background:var(--gray-50);color:var(--gray-400);}
.badge::before{content:'';width:5px;height:5px;border-radius:50%;background:currentColor;}

/* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
.page-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;}
.page-header h1{font-family:'DM Serif Display',serif;font-size:26px;color:var(--gray-900);line-height:1.2;}
.page-header p{font-size:13px;color:var(--gray-400);margin-top:3px;}

/* ‚îÄ‚îÄ PIPELINE ‚îÄ‚îÄ */
.pipeline{display:grid;grid-template-columns:repeat(5,1fr);gap:14px;margin-bottom:24px;}
.pipeline-col-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.pipeline-col-title{font-size:12px;font-weight:700;color:var(--gray-600);display:flex;align-items:center;gap:6px;}
.pipeline-count{background:var(--gray-100);color:var(--gray-600);font-size:10px;font-weight:700;width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;}
.deal-card{background:var(--white);border:1px solid var(--gray-100);border-radius:10px;padding:14px;margin-bottom:8px;cursor:pointer;transition:all .15s;box-shadow:var(--shadow-sm);}
.deal-card:hover{box-shadow:var(--shadow-md);transform:translateY(-2px);border-color:var(--blue-light);}
.deal-brand{font-size:13px;font-weight:600;color:var(--gray-900);margin-bottom:3px;}
.deal-creator{font-size:11px;color:var(--gray-400);margin-bottom:7px;}
.deal-value{font-family:'DM Serif Display',serif;font-size:17px;color:var(--blue);}
.deal-meta{display:flex;align-items:center;justify-content:space-between;margin-top:8px;}
.deal-date{font-size:10px;color:var(--gray-400);}

/* ‚îÄ‚îÄ MEDIA KIT ‚îÄ‚îÄ */
.media-kit-preview{background:var(--gray-900);border-radius:var(--radius);padding:28px;color:white;position:relative;overflow:hidden;}
.media-kit-preview::before{content:'';position:absolute;top:-60px;right:-60px;width:200px;height:200px;border-radius:50%;background:var(--blue);opacity:.15;}
.mk-creator-name{font-family:'DM Serif Display',serif;font-size:24px;margin-bottom:4px;}
.mk-niche{font-size:12px;color:rgba(255,255,255,.5);margin-bottom:20px;}
.mk-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;}
.mk-stat{background:rgba(255,255,255,.06);border-radius:10px;padding:12px;}
.mk-stat-val{font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:2px;}
.mk-stat-label{font-size:10px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.5px;}
.mk-platforms{display:flex;gap:8px;flex-wrap:wrap;}
.mk-platform{background:rgba(255,255,255,.08);border-radius:20px;padding:5px 12px;font-size:11px;font-weight:600;}

/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.form-group{margin-bottom:16px;}
.form-label{display:block;font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:6px;}
.form-input,.form-select,.form-textarea{width:100%;padding:9px 12px;border:1px solid var(--gray-200);border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--gray-900);background:var(--white);outline:none;transition:border-color .15s;}
.form-input:focus,.form-select:focus,.form-textarea:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(26,92,255,.1);}
.form-textarea{min-height:80px;resize:vertical;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-hint{font-size:11px;color:var(--gray-400);margin-top:4px;}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(15,17,32,.5);backdrop-filter:blur(4px);z-index:1000;align-items:center;justify-content:center;}
.modal-overlay.open{display:flex;}
/* Confirm/delete modal always appears above any other open modal */
#confirmModal{z-index:1500;}
.modal{background:var(--white);border-radius:16px;width:520px;max-width:95vw;max-height:92vh;overflow-y:auto;box-shadow:var(--shadow-lg);animation:modalIn .2s ease;}
.modal-wide{width:700px;}
@keyframes modalIn{from{opacity:0;transform:scale(.95) translateY(10px);}to{opacity:1;transform:scale(1) translateY(0);}}
.modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--gray-100);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;background:var(--white);z-index:10;}
.modal-title{font-family:'DM Serif Display',serif;font-size:20px;}
.modal-close{width:28px;height:28px;border-radius:50%;border:none;background:var(--gray-100);cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--gray-600);font-size:16px;transition:background .15s;}
.modal-close:hover{background:var(--gray-200);}
.modal-body{padding:20px 24px;}
.modal-footer{padding:16px 24px 20px;display:flex;gap:10px;justify-content:flex-end;border-top:1px solid var(--gray-100);}

/* ‚îÄ‚îÄ ACTIVITY ‚îÄ‚îÄ */
.activity-item{display:flex;gap:12px;padding:12px 0;border-bottom:1px solid var(--gray-100);}
.activity-item:last-child{border-bottom:none;}
.activity-dot{width:8px;height:8px;border-radius:50%;background:var(--blue);flex-shrink:0;margin-top:5px;}
.activity-text{font-size:13px;color:var(--gray-600);}
.activity-text strong{color:var(--gray-900);font-weight:600;}
.activity-time{font-size:11px;color:var(--gray-400);margin-top:2px;}

/* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
.progress-bar{background:var(--gray-100);border-radius:20px;height:6px;overflow:hidden;}
.progress-fill{height:100%;border-radius:20px;background:var(--blue);transition:width .8s ease;}
.progress-fill.green{background:var(--green);}
.progress-fill.amber{background:var(--amber);}

/* ‚îÄ‚îÄ SCROLLBAR ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--gray-200);border-radius:20px;}

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--gray-100);padding:4px;border-radius:10px;width:fit-content;}
.tab{padding:7px 16px;border-radius:7px;font-size:13px;font-weight:500;cursor:pointer;color:var(--gray-600);border:none;background:none;transition:all .15s;}
.tab.active{background:var(--white);color:var(--gray-900);font-weight:600;box-shadow:var(--shadow-sm);}

/* ‚îÄ‚îÄ PROFILE TABS ‚îÄ‚îÄ */
.profile-tabs{display:flex;gap:0;border-bottom:1px solid var(--gray-100);margin-bottom:20px;}
.profile-tab{padding:10px 18px;font-size:13px;font-weight:500;color:var(--gray-400);cursor:pointer;border-bottom:2px solid transparent;transition:all .15s;border:none;background:none;}
.profile-tab:hover{color:var(--gray-600);}
.profile-tab.active{color:var(--blue);border-bottom-color:var(--blue);font-weight:600;}
.profile-tab-content{display:none;}
.profile-tab-content.active{display:block;}

/* ‚îÄ‚îÄ INBOX ‚îÄ‚îÄ */
.inbox-layout{display:grid;grid-template-columns:300px 1fr;gap:20px;height:calc(100vh - 160px);}
.inbox-list{background:var(--white);border:1px solid var(--gray-100);border-radius:var(--radius);overflow-y:auto;}
.inbox-item{padding:14px 16px;border-bottom:1px solid var(--gray-100);cursor:pointer;transition:background .15s;}
.inbox-item:hover{background:var(--gray-50);}
.inbox-item.active{background:var(--blue-light);}
.inbox-item.unread .inbox-sender{font-weight:700;color:var(--gray-900);}
.inbox-sender{font-size:13px;font-weight:500;color:var(--gray-900);}
.inbox-preview{font-size:12px;color:var(--gray-400);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.inbox-time{font-size:10px;color:var(--gray-400);}
.inbox-unread-dot{width:7px;height:7px;border-radius:50%;background:var(--blue);flex-shrink:0;}
.inbox-pane{background:var(--white);border:1px solid var(--gray-100);border-radius:var(--radius);display:flex;flex-direction:column;overflow:hidden;}
.inbox-email-header{padding:20px 24px;border-bottom:1px solid var(--gray-100);}
.inbox-email-body{padding:20px 24px;flex:1;overflow-y:auto;font-size:13px;color:var(--gray-600);line-height:1.7;}
.inbox-email-actions{padding:16px 24px;border-top:1px solid var(--gray-100);display:flex;gap:8px;}
.inbox-empty{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;color:var(--gray-400);}

/* ‚îÄ‚îÄ ONBOARDING ‚îÄ‚îÄ */
.onboarding-step{display:flex;gap:16px;padding:16px;border:1px solid var(--gray-100);border-radius:var(--radius);margin-bottom:12px;align-items:flex-start;background:var(--white);}
.step-num{width:28px;height:28px;border-radius:50%;background:var(--blue-light);color:var(--blue);font-size:12px;font-weight:700;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.step-num.done{background:var(--green-light);color:var(--green);}
.step-info h4{font-size:13px;font-weight:600;color:var(--gray-900);margin-bottom:3px;}
.step-info p{font-size:12px;color:var(--gray-400);}

/* ‚îÄ‚îÄ DECK CARD ‚îÄ‚îÄ */
.deck-slide{background:var(--gray-900);border-radius:12px;padding:24px;color:white;aspect-ratio:16/9;display:flex;flex-direction:column;justify-content:space-between;position:relative;overflow:hidden;}
.deck-slide::before{content:'';position:absolute;bottom:-40px;right:-40px;width:160px;height:160px;border-radius:50%;background:var(--blue);opacity:.2;}
.deck-slide-label{font-size:10px;text-transform:uppercase;letter-spacing:1px;color:rgba(255,255,255,.4);}
.deck-slide-title{font-family:'DM Serif Display',serif;font-size:20px;line-height:1.3;}
.deck-slide-footer{display:flex;align-items:center;justify-content:space-between;}
.deck-logo{font-family:'DM Serif Display',serif;font-size:14px;opacity:.6;}

/* ‚îÄ‚îÄ CAMPAIGN CARD ‚îÄ‚îÄ */
.campaign-card{background:var(--white);border:1px solid var(--gray-100);border-radius:var(--radius);padding:20px;margin-bottom:16px;cursor:pointer;transition:border-color .15s;}
.campaign-card:hover{border-color:var(--blue-light);}
.campaign-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.campaign-name{font-size:15px;font-weight:600;font-family:'DM Serif Display',serif;color:var(--gray-900);}
.campaign-meta{display:flex;gap:16px;margin-bottom:8px;}
.campaign-meta-item{font-size:11px;color:var(--gray-400);}
.campaign-meta-item strong{color:var(--gray-600);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
#toast{position:fixed;bottom:24px;right:24px;background:var(--gray-900);color:white;padding:12px 20px;border-radius:10px;font-size:13px;font-weight:500;z-index:9999;opacity:0;transform:translateY(10px);transition:all .25s;pointer-events:none;max-width:320px;}
#toast.show{opacity:1;transform:translateY(0);}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state{text-align:center;padding:48px 24px;color:var(--gray-400);}
.empty-state svg{margin:0 auto 12px;display:block;opacity:.35;}
.empty-state h3{font-size:15px;font-weight:600;color:var(--gray-600);margin-bottom:6px;}
.empty-state p{font-size:13px;}

/* ‚îÄ‚îÄ CRM TOOLBAR ‚îÄ‚îÄ */
.crm-toolbar{display:flex;gap:10px;margin-bottom:16px;align-items:center;}
.crm-search{flex:1;display:flex;align-items:center;gap:8px;background:var(--gray-50);border:1px solid var(--gray-100);border-radius:10px;padding:8px 12px;}
.crm-search input{border:none;background:none;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;color:var(--gray-900);width:100%;}
.crm-search input::placeholder{color:var(--gray-400);}

/* ‚îÄ‚îÄ NOTIF DOT ‚îÄ‚îÄ */
.notif-dot{width:7px;height:7px;border-radius:50%;background:var(--red);flex-shrink:0;}

/* ‚îÄ‚îÄ ROLE BADGES ‚îÄ‚îÄ */
.role-badge{display:inline-flex;align-items:center;padding:2px 8px;border-radius:20px;font-size:11px;font-weight:700;letter-spacing:.2px;}
.role-owner{background:#FFF3CD;color:#856404;border:1px solid #FFEAA0;}
.role-admin{background:var(--blue-light);color:var(--blue);border:1px solid rgba(33,152,237,.2);}
.role-manager{background:#EFF6FF;color:#2563EB;}
.role-team{background:var(--green-light);color:var(--green);}
.role-readonly{background:var(--gray-50);color:var(--gray-400);}

/* ‚îÄ‚îÄ PERMISSION DENIED OVERLAY ‚îÄ‚îÄ */
.perm-denied{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:300px;gap:12px;opacity:.65;}
.perm-denied svg{color:var(--gray-400);}
.perm-denied h3{font-size:16px;color:var(--gray-600);font-weight:600;}
.perm-denied p{font-size:13px;color:var(--gray-400);}

/* ‚îÄ‚îÄ USERS ADMIN PAGE ‚îÄ‚îÄ */
.users-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px;margin-bottom:24px;}
.user-card{background:var(--white);border:1px solid var(--gray-100);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow-sm);transition:box-shadow .15s;}
.user-card:hover{box-shadow:var(--shadow-md);}
.user-card-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;}
.user-card-avatar{width:44px;height:44px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;font-size:16px;font-weight:700;color:white;flex-shrink:0;box-shadow:0 2px 8px rgba(33,152,237,.3);}
.user-card-actions{display:flex;gap:8px;margin-top:14px;}

/* ‚îÄ‚îÄ TOPBAR ACCENT ‚îÄ‚îÄ */
.topbar{background:var(--white);border-bottom:1px solid var(--gray-100);padding:0 28px;height:60px;display:flex;align-items:center;gap:16px;position:sticky;top:0;z-index:50;box-shadow:0 1px 0 var(--gray-100);}
.topbar-accent{width:3px;height:28px;background:var(--blue);border-radius:2px;margin-right:4px;flex-shrink:0;}

/* ‚îÄ‚îÄ STAT CARD ACCENT ‚îÄ‚îÄ */
.stat-card{background:var(--white);border:1px solid var(--gray-100);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow-sm);position:relative;overflow:hidden;}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,var(--blue),rgba(33,152,237,.3));opacity:0;transition:opacity .3s;}
.stat-card:hover::before{opacity:1;}
.stat-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;background:var(--blue);border-radius:0 0 var(--radius) var(--radius);transform:scaleX(0);transition:transform .3s;transform-origin:left;}
.stat-card:hover::after{transform:scaleX(1);}

@media(max-width:900px){.stats-grid{grid-template-columns:repeat(2,1fr);}.pipeline{grid-template-columns:repeat(2,1fr);}.grid-2{grid-template-columns:1fr;}}

/* ‚îÄ‚îÄ MOBILE RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:768px){
  body{display:block;}
  .sidebar{position:fixed;top:0;left:0;bottom:0;z-index:200;transform:translateX(-100%);transition:transform .25s ease;box-shadow:var(--shadow-lg);}
  .sidebar.open{transform:translateX(0);}
  .main{margin-left:0;}
  .topbar{padding:0 16px;}
  .topbar-search{display:none;}
  .content{padding:16px;}
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:10px;}
  .grid-2,.grid-3{grid-template-columns:1fr;}
  .pipeline{grid-template-columns:1fr;overflow-x:auto;display:flex;gap:14px;}
  .pipeline>div{min-width:220px;}
  .modal{width:calc(100vw - 24px);max-height:92vh;}
  .form-row{grid-template-columns:1fr;}
  table{font-size:12px;}
  td,th{padding:8px 10px;}
  .page-header{flex-direction:column;gap:10px;align-items:flex-start;}
  .hamburger{display:flex;align-items:center;justify-content:center;width:36px;height:36px;border:1px solid var(--gray-200);border-radius:8px;background:none;cursor:pointer;flex-shrink:0;}
  .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.4);z-index:199;}
  .sidebar-overlay.show{display:block;}
}
@media(min-width:769px){.hamburger{display:none;}.sidebar-overlay{display:none!important;}}

/* ‚îÄ‚îÄ GLOBAL SEARCH OVERLAY ‚îÄ‚îÄ */
.search-overlay{display:none;position:fixed;inset:0;z-index:5000;background:rgba(15,17,32,.5);backdrop-filter:blur(4px);}
.search-overlay.open{display:block;}
.search-box-wrap{max-width:620px;margin:80px auto 0;padding:0 20px;}
.search-input-big{width:100%;padding:14px 18px 14px 46px;font-size:16px;font-family:'DM Sans',sans-serif;border:2px solid var(--blue);border-radius:14px;outline:none;box-shadow:0 8px 32px rgba(33,152,237,.2);background:var(--white);}
.search-icon-big{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:var(--gray-400);}
.search-input-wrap{position:relative;}
.search-results-panel{background:var(--white);border-radius:14px;margin-top:8px;box-shadow:var(--shadow-lg);max-height:60vh;overflow-y:auto;}
.search-group-label{font-size:10px;font-weight:700;color:var(--gray-400);text-transform:uppercase;letter-spacing:.8px;padding:12px 16px 4px;}
.search-result-item{display:flex;align-items:center;gap:12px;padding:10px 16px;cursor:pointer;transition:background .1s;border-bottom:1px solid var(--gray-100);}
.search-result-item:last-child{border-bottom:none;}
.search-result-item:hover{background:var(--gray-50);}
.search-result-icon{width:30px;height:30px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:13px;}
.search-result-main{font-size:13px;font-weight:600;color:var(--gray-900);}
.search-result-sub{font-size:11px;color:var(--gray-400);}
.search-empty{text-align:center;padding:32px;color:var(--gray-400);font-size:13px;}

/* ‚îÄ‚îÄ PROFILE PICTURE ‚îÄ‚îÄ */
.avatar-img{width:100%;height:100%;object-fit:cover;border-radius:50%;}
.avatar-upload-btn{position:absolute;bottom:-2px;right:-2px;width:20px;height:20px;border-radius:50%;background:var(--blue);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.2);}
.avatar-wrap{position:relative;display:inline-flex;}

/* ‚îÄ‚îÄ ANALYTICS TABS ‚îÄ‚îÄ */
.analytics-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;}
.analytics-stat{background:var(--gray-50);border-radius:10px;padding:14px;text-align:center;}
.analytics-stat-val{font-family:'DM Serif Display',serif;font-size:22px;color:var(--blue);margin-bottom:2px;}
.analytics-stat-label{font-size:11px;color:var(--gray-400);}
.breakdown-row{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
.breakdown-label{font-size:12px;color:var(--gray-600);width:80px;flex-shrink:0;}
.breakdown-bar{flex:1;height:6px;background:var(--gray-100);border-radius:4px;overflow:hidden;}
.breakdown-fill{height:100%;border-radius:4px;background:var(--blue);}
.breakdown-pct{font-size:11px;color:var(--gray-400);width:36px;text-align:right;}

/* ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ */
.confirm-modal{max-width:400px;}
.confirm-icon{width:52px;height:52px;border-radius:50%;background:var(--red-light);display:flex;align-items:center;justify-content:center;margin:0 auto 16px;}

</style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
</head>
<body>

<!-- ‚ïê‚ïê SIDEBAR OVERLAY (mobile) ‚ïê‚ïê -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- ‚ïê‚ïê GLOBAL SEARCH OVERLAY ‚ïê‚ïê -->
<div class="search-overlay" id="searchOverlay" onclick="closeSearchOverlay(event)">
  <div class="search-box-wrap">
    <div class="search-input-wrap">
      <svg class="search-icon-big" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input class="search-input-big" id="globalSearchInput" placeholder="Search creators, campaigns, deals‚Ä¶" oninput="doGlobalSearch(this.value)" onkeydown="if(event.key==='Escape')closeSearchOverlay()">
    </div>
    <div class="search-results-panel" id="searchResultsPanel" style="display:none"></div>
  </div>
</div>

<!-- ‚ïê‚ïê CONFIRM DELETE MODAL ‚ïê‚ïê -->
<div class="modal-overlay" id="confirmModal">
  <div class="modal confirm-modal">
    <div class="modal-body" style="text-align:center;padding:32px 24px">
      <div class="confirm-icon">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="M9 6V4h6v2"/></svg>
      </div>
      <div style="font-family:'DM Serif Display',serif;font-size:20px;margin-bottom:8px" id="confirmTitle">Are you sure?</div>
      <div style="font-size:13px;color:var(--gray-400)" id="confirmMsg">This action cannot be undone.</div>
    </div>
    <div class="modal-footer" style="justify-content:center;gap:12px">
      <button class="btn btn-ghost" onclick="closeModal('confirmModal')">Cancel</button>
      <button class="btn btn-danger" id="confirmOkBtn">Delete</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê AUTH SCREEN ‚ïê‚ïê -->
<div id="authScreen">
  <div class="auth-box">
    <div class="auth-logo"><div class="auth-logo-wrap"><img src="https://framerusercontent.com/images/v9Xt5qeVvZgasUVsLzsdDSLGOtg.png" alt="blustu"></div></div>
    <div class="auth-title">Staff Login</div>
    <div class="auth-sub">blustu‚Ñ¢ Internal Panel ‚Äî Authorised staff only</div>
    <div class="auth-error" id="authError">Invalid email or password. Please try again.</div>
    <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="loginEmail" type="email" placeholder="you@blustu.agency" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <div class="form-group"><label class="form-label">Password</label><input class="form-input" id="loginPassword" type="password" placeholder="Password" onkeydown="if(event.key==='Enter')doLogin()"></div>
    <button class="btn btn-primary" id="loginBtn" style="width:100%;justify-content:center;padding:12px" onclick="doLogin()">Sign In</button>
    <div style="margin-top:16px;padding:12px;background:var(--gray-50);border-radius:10px;font-size:12px;color:var(--gray-400);text-align:center">
      Use your staff credentials to sign in
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CREATOR ONBOARDING PORTAL ‚ïê‚ïê -->
<div id="onboardPortal">
  <div class="portal-wrap">
    <div class="portal-header">
      <img src="https://framerusercontent.com/images/v9Xt5qeVvZgasUVsLzsdDSLGOtg.png" class="portal-logo" alt="blustu">
      <div class="portal-title">Welcome to blustu‚Ñ¢</div>
      <div class="portal-sub" id="portalCreatorName">Complete your onboarding to get started</div>
    </div>
    <div class="portal-progress" id="portalProgress">
      <div class="portal-progress-dot done" id="pdot-1"></div>
      <div class="portal-progress-dot" id="pdot-2"></div>
      <div class="portal-progress-dot" id="pdot-3"></div>
      <div class="portal-progress-dot" id="pdot-4"></div>
    </div>

    <!-- Step 1: Socials -->
    <div class="portal-step active" id="pstep-1">
      <div class="portal-section">
        <div class="portal-section-title"><span>1</span>Your Social Platforms</div>
        <div class="form-group"><label class="form-label">TikTok Profile URL</label><input class="form-input" id="ob-tiktok" placeholder="https://tiktok.com/@yourhandle"><div class="form-hint">e.g. https://tiktok.com/@yourhandle</div></div>
        <div class="form-group"><label class="form-label">Instagram Profile URL</label><input class="form-input" id="ob-instagram" placeholder="https://instagram.com/yourhandle"></div>
        <div class="form-group"><label class="form-label">YouTube Channel URL</label><input class="form-input" id="ob-youtube" placeholder="https://youtube.com/@yourchannel"></div>
        <div class="form-group"><label class="form-label">Other Platform <span style="color:var(--gray-400);font-weight:400">(optional)</span></label><input class="form-input" id="ob-other" placeholder="e.g. https://twitter.com/yourhandle"></div>
      </div>
      <div style="margin-top:16px;padding:20px;background:var(--gray-50);border-radius:10px;border:1px solid var(--gray-100)">
        <div style="font-size:13px;font-weight:700;color:var(--gray-900);margin-bottom:4px;display:flex;align-items:center;gap:8px">
          <span style="background:var(--amber);color:white;width:20px;height:20px;border-radius:50%;font-size:10px;display:inline-flex;align-items:center;justify-content:center;flex-shrink:0">‚òÖ</span>
          Your Stats <span style="font-size:11px;font-weight:400;color:var(--gray-400)">(optional)</span>
        </div>
        <div style="font-size:12px;color:var(--gray-400);margin-bottom:14px;margin-top:4px">Helps us build better brand pitches. Can be updated later.</div>
        <div class="rate-grid">
          <div class="form-group"><label class="form-label">Followers (any platform)</label><input class="form-input" id="ob-followers" placeholder="e.g. 45K or 45000"></div>
          <div class="form-group"><label class="form-label">Avg. Views per video</label><input class="form-input" id="ob-avgviews" placeholder="e.g. 12K"></div>
        </div>
        <div class="rate-grid">
          <div class="form-group"><label class="form-label">Engagement Rate (%)</label><input class="form-input" id="ob-engrate" type="number" step="0.1" min="0" max="100" placeholder="e.g. 4.5"></div>
          <div class="form-group"><label class="form-label">Main audience</label><input class="form-input" id="ob-audience" placeholder="e.g. 18-24 UK Female"></div>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end"><button class="btn btn-primary" onclick="portalNext(2)">Continue ‚Üí</button></div>
    </div>

    <!-- Step 2: Rates -->
    <div class="portal-step" id="pstep-2">
      <div class="portal-section">
        <div class="portal-section-title"><span>2</span>Your Rates</div>
        <div style="font-size:12px;color:var(--gray-400);margin-bottom:16px">Enter your comfortable base rates per deliverable. These are shared only with your manager.</div>
        <div class="rate-grid">
          <div class="form-group"><label class="form-label">TikTok Video (base)</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-rate-tiktok" type="number" placeholder="0" min="0"></div></div>
          <div class="form-group"><label class="form-label">Instagram Reel (base)</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-rate-reel" type="number" placeholder="0" min="0"></div></div>
          <div class="form-group"><label class="form-label">Instagram Story</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-rate-story" type="number" placeholder="0" min="0"></div></div>
          <div class="form-group"><label class="form-label">YouTube Integration</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-rate-youtube" type="number" placeholder="0" min="0"></div></div>
          <div class="form-group"><label class="form-label">Long-form / Extended</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-rate-long" type="number" placeholder="0" min="0"></div></div>
        </div>
        <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin:16px 0 12px">Usage / Licensing Fees</div>
        <div class="rate-grid">
          <div class="form-group"><label class="form-label">30-day usage</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-usage-30" type="number" placeholder="0" min="0"></div></div>
          <div class="form-group"><label class="form-label">60-day usage</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-usage-60" type="number" placeholder="0" min="0"></div></div>
          <div class="form-group"><label class="form-label">90-day usage</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-usage-90" type="number" placeholder="0" min="0"></div></div>
          <div class="form-group"><label class="form-label">Perpetual / Long-term</label><div style="display:flex;align-items:center;gap:6px"><span style="color:var(--gray-400);font-size:13px">¬£</span><input class="form-input" id="ob-usage-perp" type="number" placeholder="0" min="0"></div></div>
        </div>
        <div class="form-group"><label class="form-label">Additional fees <span style="color:var(--gray-400);font-weight:400">(optional)</span></label><textarea class="form-textarea" id="ob-extra-fees" placeholder="e.g. Rush fee: +¬£100. Exclusivity: +¬£200/month..."></textarea></div>
      </div>
      <div style="display:flex;justify-content:space-between"><button class="btn btn-ghost" onclick="portalNext(1)">‚Üê Back</button><button class="btn btn-primary" onclick="portalNext(3)">Continue ‚Üí</button></div>
    </div>

    <!-- Step 3: Background -->
    <div class="portal-step" id="pstep-3">
      <div class="portal-section">
        <div class="portal-section-title"><span>3</span>About You</div>
        <div class="form-group"><label class="form-label">Short Bio</label><textarea class="form-textarea" id="ob-bio" placeholder="Tell us about yourself and your content in a few sentences..." style="min-height:100px"></textarea></div>
        <div class="form-group"><label class="form-label">Niche / Content Category</label><input class="form-input" id="ob-niche" placeholder="e.g. Fashion, Lifestyle, Fitness, Food..."></div>
        <div class="form-group"><label class="form-label">Brand Restrictions <span style="color:var(--gray-400);font-weight:400">(optional)</span></label><textarea class="form-textarea" id="ob-restrictions" placeholder="Any brands or categories you won't work with? e.g. alcohol, gambling, fast food..."></textarea></div>
        <div class="form-group"><label class="form-label">Brand Preferences <span style="color:var(--gray-400);font-weight:400">(optional)</span></label><textarea class="form-textarea" id="ob-preferences" placeholder="Types of brands or partnerships you prefer..."></textarea></div>
      </div>
      <div style="display:flex;justify-content:space-between"><button class="btn btn-ghost" onclick="portalNext(2)">‚Üê Back</button><button class="btn btn-primary" onclick="portalNext(4)">Continue ‚Üí</button></div>
    </div>

    <!-- Step 4: Review & Submit -->
    <div class="portal-step" id="pstep-4">
      <div class="portal-section">
        <div class="portal-section-title"><span>4</span>Review & Submit</div>
        <div id="ob-review" style="font-size:13px;color:var(--gray-600);line-height:1.8"></div>
      </div>
      <div style="display:flex;justify-content:space-between"><button class="btn btn-ghost" onclick="portalNext(3)">‚Üê Back</button><button class="btn btn-primary" onclick="submitOnboarding()">Submit Onboarding ‚úì</button></div>
    </div>

    <!-- Step 5: Done -->
    <div class="portal-step" id="pstep-5">
      <div class="portal-section" style="text-align:center;padding:40px">
        <div style="font-size:48px;margin-bottom:16px">üéâ</div>
        <div style="font-family:'DM Serif Display',serif;font-size:22px;margin-bottom:8px">You're all set!</div>
        <div style="font-size:13px;color:var(--gray-400);margin-bottom:24px">Your onboarding has been submitted. Your manager will review your details and get back to you shortly.</div>
        <button class="btn btn-primary" onclick="closePortal()">Back to Dashboard</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê TOAST ‚ïê‚ïê -->
<div id="toast"></div>

<!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
<aside class="sidebar">
  <div class="sidebar-logo">
    <img src="https://framerusercontent.com/images/v9Xt5qeVvZgasUVsLzsdDSLGOtg.png" alt="blustu">
    <div class="tagline">Manager Dashboard</div>
    <div class="logo-tooltip">Blustu Internal Panel</div>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-section-label">Overview</div>
    <button class="nav-item active" onclick="showPage('dashboard',this)" id="nav-dashboard">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
      Dashboard
    </button>
    <div class="nav-section-label">Talent</div>
    <button class="nav-item" onclick="showPage('crm',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v2"/><circle cx="18" cy="9" r="3"/><path d="M21 18v-1a3 3 0 0 0-3-3h-1"/></svg>
      Creator CRM
      <span class="nav-badge" id="crmBadge">25</span>
    </button>
    <button class="nav-item" onclick="showPage('onboarding',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg>
      Creator Onboarding
    </button>
    <button class="nav-item" onclick="showPage('mediakit',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      Media Kits
    </button>
    <button class="nav-item" onclick="showPage('ratekit',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
      Rate Kit
    </button>
    <div class="nav-section-label">Brand Deals</div>
    <button class="nav-item" onclick="showPage('campaigns',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>
      Campaigns
      <span class="nav-badge" id="campaignsBadge">0</span>
    </button>
    <button class="nav-item" onclick="showPage('pitchdecks',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
      Pitch Decks
      <span class="nav-badge" id="pitchBadge">2</span>
    </button>
    <button class="nav-item" onclick="showPage('pipeline',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      Deal Pipeline
    </button>
    <div class="nav-section-label">More</div>
    <button class="nav-item" onclick="showPage('inbox',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
      Inbox
      <span class="nav-badge" id="inboxBadge">5</span>
    </button>
    <button class="nav-item" id="nav-users" onclick="showPage('users',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M20 21a8 8 0 1 0-16 0"/><path d="M16 11l2 2 4-4"/></svg>
      Users &amp; Access
    </button>
    <button class="nav-item" onclick="showPage('reports',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
      Campaign Reports
    </button>
    <button class="nav-item" onclick="showPage('invoice',this)">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      Invoice Generator
    </button>
  </nav>
  <div class="sidebar-footer">
    <div class="sidebar-user" onclick="openModal('profileModal')">
      <div class="user-avatar" id="sidebarAvatar">U</div>
      <div class="user-info"><div class="name" id="sidebarName">Ubayy</div><div class="role" id="sidebarRole">Manager</div></div>
    </div>
    <button class="logout-btn" onclick="doLogout()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      Sign out
    </button>
  </div>
</aside>

<!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
<main class="main">
  <header class="topbar">
    <button class="hamburger" onclick="toggleSidebar()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="topbar-accent"></div>
    <div class="topbar-title" id="topbarTitle">Dashboard</div>
    <div class="topbar-search" onclick="openSearchOverlay()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8B93A8" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
      <input type="text" id="globalSearch" placeholder="Search creators, brands‚Ä¶" readonly onclick="openSearchOverlay()" style="cursor:pointer">
    </div>
    <button class="btn btn-primary" onclick="openModal('addCreatorModal')">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      Add Creator
    </button>
    <button class="btn btn-ghost btn-sm" id="syncBtn" onclick="forceSyncAll()" title="Force sync all data" style="font-size:11px;display:flex;align-items:center;gap:4px">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
      Sync
    </button>
  </header>

  <div class="content">

    <!-- ‚ïê‚ïê DASHBOARD ‚ïê‚ïê -->
    <div class="page active" id="page-dashboard">
      <div class="page-header">
        <div><h1 id="dashGreeting">Good morning, Ubayy. üëã</h1><p>Here's what's happening at blustu‚Ñ¢ today</p></div>
        <button class="btn btn-ghost" onclick="showToast('Calendar view coming soon')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Feb 2026
        </button>
      </div>
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-label">Total Creators</div><div class="stat-value" id="stat-creators">25</div><div class="stat-change up" id="stat-creators-sub">Full roster</div></div>
        <div class="stat-card"><div class="stat-label">Active Campaigns</div><div class="stat-value" id="stat-campaigns">0</div><div class="stat-change neutral" id="stat-campaigns-sub">No campaigns yet</div></div>
        <div class="stat-card"><div class="stat-label">Pipeline Value</div><div class="stat-value" id="stat-pipeline">¬£0</div><div class="stat-change up" id="stat-pipeline-sub">Total deal value</div></div>
        <div class="stat-card"><div class="stat-label">Avg. Engagement</div><div class="stat-value" id="stat-avg-eng">‚Äî</div><div class="stat-change neutral" id="stat-avg-eng-sub">From admin data</div></div>
      </div>
      <div class="grid-2">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div class="card-title">Recent Pipeline Deals</div>
            <button class="btn btn-ghost btn-sm" onclick="showPage('pipeline',document.querySelector('[onclick*=pipeline]'))">View all</button>
          </div>
          <div id="dashRecentDeals"><div style="font-size:13px;color:var(--gray-400);padding:8px 0">No deals added yet.</div></div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:12px">Activity Feed</div>
          <div id="activityFeed">
            <div class="activity-item"><div class="activity-dot"></div><div><div class="activity-text">Dashboard loaded. Welcome back!</div><div class="activity-time">Just now</div></div></div>
            <div class="activity-item"><div class="activity-dot" style="background:var(--green)"></div><div><div class="activity-text">25 creators seeded from full roster</div><div class="activity-time">Today</div></div></div>
            <div class="activity-item"><div class="activity-dot" style="background:var(--blue)"></div><div><div class="activity-text">System updated with new features</div><div class="activity-time">Today</div></div></div>
          </div>
        </div>
      </div>
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div class="card-title">Active Campaigns</div>
          <button class="btn btn-primary btn-sm" onclick="openModal('addCampaignModal')">+ New Campaign</button>
        </div>
        <div id="dashCampaigns"><div class="empty-state" style="padding:24px"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><h3>No campaigns yet</h3><p>Create your first campaign to get started</p></div></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê CRM ‚ïê‚ïê -->
    <div class="page" id="page-crm">
      <div class="page-header">
        <div><h1>Creator CRM</h1><p>Full roster ‚Äî <span id="crm-count">25</span> creators</p></div>
        <button class="btn btn-primary" onclick="openModal('addCreatorModal')">+ Add Creator</button>
      </div>
      <div class="crm-toolbar">
        <div class="crm-search">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8B93A8" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="Search by name, location, niche..." oninput="filterCRM(this.value)" id="crmSearchInput">
        </div>
        <select class="form-select" style="width:140px" onchange="filterCRMStatus(this.value)">
          <option value="">All Status</option>
          <option value="Active">Active</option>
          <option value="Invited">Invited</option>
          <option value="Onboarded">Onboarded</option>
        </select>
      </div>
      <div class="card" style="padding:0;overflow:hidden">
        <div class="table-wrap">
          <table><thead><tr><th>Creator</th><th>Role</th><th>Location</th><th>Onboarding</th><th>Status</th><th>Actions</th></tr></thead>
          <tbody id="crmTableBody"></tbody></table>
        </div>
        <div id="crm-empty" class="empty-state" style="display:none"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="9" cy="7" r="4"/><path d="M3 21v-2a4 4 0 0 1 4-4h4"/></svg><h3>No creators found</h3><p>Try a different search term</p></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê INFLUENCER GRID (campaign picker) ‚ïê‚ïê -->
    <div class="page" id="page-creatorgrid">
      <div class="page-header">
        <div>
          <button class="btn btn-ghost btn-sm" id="gridBackBtn" onclick="closeCreatorGrid()" style="margin-bottom:6px">‚Üê Back</button>
          <h1>Select Creators</h1><p id="gridSubTitle">Choose creators for this campaign</p>
        </div>
        <button class="btn btn-primary" id="gridConfirmBtn" onclick="confirmGridSelection()" disabled>Add Selected (0)</button>
      </div>
      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
        <div class="crm-search" style="flex:1;min-width:200px">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#8B93A8" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          <input type="text" placeholder="Search creators‚Ä¶" oninput="filterCreatorGrid(this.value)" id="gridSearch">
        </div>
        <select class="form-select" style="width:150px" onchange="filterCreatorGrid()" id="gridNicheFilter">
          <option value="">All Niches</option>
        </select>
        <select class="form-select" style="width:160px" onchange="filterCreatorGrid()" id="gridFollowerFilter">
          <option value="">Any Followers</option>
          <option value="0-10k">Under 10K</option>
          <option value="10k-50k">10K ‚Äì 50K</option>
          <option value="50k-100k">50K ‚Äì 100K</option>
          <option value="100k+">100K+</option>
        </select>
      </div>
      <div id="creatorGridBody" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px"></div>
    </div>

    <!-- ‚ïê‚ïê CREATOR PROFILE ‚ïê‚ïê -->
    <div class="page" id="page-creatorprofile">
      <div class="page-header">
        <div style="display:flex;align-items:center;gap:12px">
          <button class="btn btn-ghost btn-sm" onclick="showPage('crm',document.querySelector('[onclick*=crm]'))">‚Üê Back</button>
          <div style="display:flex;align-items:center;gap:12px">
            <div class="avatar-wrap">
              <div class="creator-avatar" id="profile-avatar-circle" style="width:48px;height:48px;font-size:16px;cursor:pointer" onclick="triggerProfilePicUpload()"></div>
              <div class="avatar-upload-btn" onclick="triggerProfilePicUpload()">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              </div>
              <input type="file" id="profilePicFile" accept="image/*" style="display:none" onchange="handleProfilePicUpload(event)">
            </div>
            <div><h1 id="profile-name">Creator</h1><p id="profile-email"></p></div>
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="profile-status-badge"></span>
          <button class="btn btn-danger btn-sm" onclick="confirmDeleteCreator()">Delete</button>
        </div>
      </div>
      <div class="profile-tabs">
        <button class="profile-tab active" onclick="switchProfileTab('overview',this)">Overview</button>
        <button class="profile-tab" onclick="switchProfileTab('socials',this)">Socials & Rates</button>
        <button class="profile-tab" onclick="switchProfileTab('deals',this)">Deals</button>
        <button class="profile-tab" onclick="switchProfileTab('contracts',this)">Contracts</button>
        <button class="profile-tab" onclick="switchProfileTab('notes',this)">Notes</button>
      </div>
      <div class="profile-tab-content active" id="ptab-overview">
        <div class="grid-2">
          <div class="card"><div class="card-title">Creator Info</div><div id="profile-info-body" style="margin-top:12px"></div></div>
          <div class="card"><div class="card-title">Onboarding Status</div><div id="profile-onboarding-body" style="margin-top:12px"></div></div>
        </div>
      </div>
      <div class="profile-tab-content" id="ptab-socials">
        <div id="profile-socials-body"></div>
      </div>
      <div class="profile-tab-content" id="ptab-deals">
        <div class="card"><div class="card-title" style="margin-bottom:12px">Deals</div><div id="profile-deals-body"></div></div>
      </div>
      <div class="profile-tab-content" id="ptab-contracts">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
            <div class="card-title">Contracts</div>
            <button class="btn btn-primary btn-sm" onclick="openUploadContract()">+ Upload Contract</button>
          </div>
          <input type="file" id="contractFileInput" accept=".pdf" style="display:none" onchange="handleContractUpload(event)">
          <div id="profile-contracts-body">
            <div style="font-size:13px;color:var(--gray-400)">No contracts uploaded yet.</div>
          </div>
        </div>
      </div>
      <div class="profile-tab-content" id="ptab-notes">
        <div class="card"><div class="card-title" style="margin-bottom:12px">Internal Notes <span style="font-size:10px;color:var(--gray-400);font-weight:400">(manager only)</span></div>
          <textarea class="form-textarea" id="profile-notes-input" placeholder="Add internal notes about this creator..." style="min-height:160px" oninput="saveProfileNote(this.value)"></textarea>
          <div style="margin-top:8px;font-size:11px;color:var(--gray-400)" id="notes-save-indicator"></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê ONBOARDING PAGE ‚ïê‚ïê -->
    <div class="page" id="page-onboarding">
      <div class="page-header">
        <div><h1>Creator Onboarding</h1><p>Invite creators and track their setup progress</p></div>
        <button class="btn btn-primary" onclick="openModal('inviteCreatorModal')">+ Invite Creator</button>
      </div>

      <!-- Stats pills -->
      <div style="display:flex;gap:10px;margin-bottom:20px;flex-wrap:wrap">
        <div style="flex:1;min-width:120px;background:var(--amber-light);border-radius:12px;padding:14px;text-align:center">
          <div style="font-family:'DM Serif Display',serif;font-size:26px;color:var(--amber)" id="stat-invited">0</div>
          <div style="font-size:11px;color:var(--amber);font-weight:600">Invited</div>
        </div>
        <div style="flex:1;min-width:120px;background:var(--blue-light);border-radius:12px;padding:14px;text-align:center">
          <div style="font-family:'DM Serif Display',serif;font-size:26px;color:var(--blue)" id="stat-onboarded">0</div>
          <div style="font-size:11px;color:var(--blue);font-weight:600">Submitted</div>
        </div>
        <div style="flex:1;min-width:120px;background:var(--green-light);border-radius:12px;padding:14px;text-align:center">
          <div style="font-family:'DM Serif Display',serif;font-size:26px;color:var(--green)" id="stat-active-ob">0</div>
          <div style="font-size:11px;color:var(--green);font-weight:600">Active</div>
        </div>
        <div style="flex:1;min-width:120px;background:var(--gray-50);border-radius:12px;padding:14px;text-align:center">
          <div style="font-family:'DM Serif Display',serif;font-size:26px;color:var(--gray-600)" id="stat-total-ob">0</div>
          <div style="font-size:11px;color:var(--gray-400);font-weight:600">Total Creators</div>
        </div>
      </div>

      <!-- Full onboarding tracker table -->
      <div class="card" style="padding:0;overflow:hidden;margin-bottom:20px">
        <div style="padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;border-bottom:1px solid var(--gray-100)">
          <div class="card-title" style="margin:0;white-space:nowrap">All Creators ‚Äî Onboarding Status</div>
          <div class="crm-search" style="max-width:200px;width:100%;flex-shrink:1">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#8B93A8" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            <input type="text" placeholder="Search creators‚Ä¶" oninput="filterOnboardingTracker(this.value)" id="obSearchInput">
          </div>
        </div>
        <div class="table-wrap">
          <table>
            <thead><tr>
              <th>Creator</th>
              <th>Niche</th>
              <th>Status</th>
              <th>Submitted data</th>
              <th>Action</th>
              <th></th>
            </tr></thead>
            <tbody id="onboarding-tracker-body"><tr><td colspan="6" style="text-align:center;padding:20px;color:var(--gray-400)">Loading‚Ä¶</td></tr></tbody>
          </table>
        </div>
      </div>

      <!-- Pending + Done collapsible lists (kept for quick view) -->
      <div class="grid-2">
        <div class="card">
          <div class="card-title" style="margin-bottom:12px">‚è≥ Pending Invites</div>
          <div id="onboarding-pending-list"><div style="font-size:13px;color:var(--gray-400)">Loading‚Ä¶</div></div>
        </div>
        <div class="card">
          <div class="card-title" style="margin-bottom:12px">‚úÖ Completed Onboarding</div>
          <div id="onboarding-done-list"><div style="font-size:13px;color:var(--gray-400)">Loading‚Ä¶</div></div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê MEDIA KITS ‚ïê‚ïê -->
    <div class="page" id="page-mediakit">
      <div class="page-header">
        <div><h1>Media Kits</h1><p>Generate and share media kits for your talent</p></div>
        <button class="btn btn-primary" onclick="openModal('genKitModal')">+ Generate Kit</button>
      </div>

      <!-- Media Kit Tabs (Rate Kit is now a separate nav page) -->
      <div class="profile-tabs" style="margin-bottom:20px">
        <button class="profile-tab active" id="mktab-btn-kit" onclick="switchMKTab('kit',this)">Media Kit</button>
        <button class="profile-tab" id="mktab-btn-analytics" onclick="switchMKTab('analytics',this)">Analytics</button>
      </div>

      <!-- Tab: Media Kit -->
      <div class="profile-tab-content active" id="mktab-kit">
        <div class="grid-2">
          <div>
            <div style="margin-bottom:10px;font-size:13px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px">Preview</div>
            <div class="media-kit-preview">
              <div><div class="mk-creator-name" id="mk-name">Select a creator</div><div class="mk-niche" id="mk-niche">Generate a kit to preview</div></div>
              <div>
                <div class="mk-stats">
                  <div class="mk-stat"><div class="mk-stat-val" id="mk-stat1">‚Äî</div><div class="mk-stat-label">Followers</div></div>
                  <div class="mk-stat"><div class="mk-stat-val" id="mk-stat-eng">‚Äî</div><div class="mk-stat-label">Eng. Rate</div></div>
                  <div class="mk-stat"><div class="mk-stat-val" id="mk-stat-reach">‚Äî</div><div class="mk-stat-label">Avg. Views</div></div>
                </div>
                <div class="mk-platforms" id="mk-platforms"><div class="mk-platform">üì∏ Instagram</div><div class="mk-platform">üéµ TikTok</div></div>
              </div>
              <div style="position:relative;z-index:1"><div style="font-size:10px;color:rgba(255,255,255,.3);margin-top:16px">Represented by blustu‚Ñ¢ ¬∑ <span id="mk-email">‚Äî</span></div></div>
            </div>
            <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
              <button class="btn btn-primary" style="flex:1" onclick="shareKit()">Share Link</button>
              <button class="btn btn-ghost" onclick="exportKitAsPng('media-kit-export-target','MediaKit')">‚¨á PNG</button>
            </div>
            <!-- Clean export target (no buttons) -->
            <div id="media-kit-export-target" style="display:none"></div>
          </div>
          <div>
            <div class="card" style="margin-bottom:14px">
              <div class="card-title" style="margin-bottom:12px">Edit Kit (Admin)</div>
              <div class="form-group"><label class="form-label">Bio / Tagline</label><input class="form-input" id="mk-edit-bio" placeholder="Creator bio..." oninput="updateKitPreview()"></div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Platform 1</label><input class="form-input" id="mk-edit-p1" value="üì∏ Instagram" oninput="updateKitPreview()"></div>
                <div class="form-group"><label class="form-label">Platform 2</label><input class="form-input" id="mk-edit-p2" value="üéµ TikTok" oninput="updateKitPreview()"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Followers (admin)</label><input class="form-input" id="mk-edit-followers" placeholder="e.g. 45K" oninput="updateKitPreview()"></div>
                <div class="form-group"><label class="form-label">Engagement Rate %</label><input class="form-input" id="mk-edit-eng" placeholder="e.g. 4.2" type="number" step="0.1" oninput="updateKitPreview()"></div>
              </div>
              <div class="form-row">
                <div class="form-group"><label class="form-label">Avg. Views</label><input class="form-input" id="mk-edit-reach" placeholder="e.g. 12K" oninput="updateKitPreview()"></div>
                <div class="form-group"><label class="form-label">Audience</label><input class="form-input" id="mk-edit-audience" placeholder="e.g. 18-24, UK female"></div>
              </div>
              <button class="btn btn-primary btn-sm" onclick="saveKitAdminData()">üíæ Save Admin Data</button>
            </div>
            <div style="margin-bottom:10px;font-size:13px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px">All Media Kits</div>
            <div class="card" style="padding:0;overflow:hidden">
              <table><thead><tr><th>Creator</th><th>Eng. Rate</th><th>Updated</th><th></th></tr></thead><tbody id="mkListBody"></tbody></table>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Analytics -->
      <div class="profile-tab-content" id="mktab-analytics">
        <div class="grid-2">
          <div class="card">
            <div class="card-title" style="margin-bottom:16px">Analytics</div>
            <div class="analytics-grid" id="kit-analytics-display">
              <div class="analytics-stat"><div class="analytics-stat-val" id="ana-views">‚Äî</div><div class="analytics-stat-label">Total Views</div></div>
              <div class="analytics-stat"><div class="analytics-stat-val" id="ana-opens">‚Äî</div><div class="analytics-stat-label">Opens</div></div>
              <div class="analytics-stat"><div class="analytics-stat-val" id="ana-clicks">‚Äî</div><div class="analytics-stat-label">Link Clicks</div></div>
            </div>
            <div style="margin-top:16px;margin-bottom:12px">
              <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:8px">Age Breakdown</div>
              <div id="ana-age-display"></div>
            </div>
            <div style="margin-bottom:12px">
              <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:8px">Gender</div>
              <div id="ana-gender-display"></div>
            </div>
            <div>
              <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:8px">Top Locations</div>
              <div id="ana-location-display"></div>
            </div>
            <button class="btn btn-ghost btn-sm" style="margin-top:12px;width:100%" onclick="openAnalyticsModal()">Edit Analytics Data</button>
            <button class="btn btn-ghost btn-sm" style="margin-top:8px;width:100%" onclick="exportKitAsPng('analytics-export-target','AnalyticsKit')">‚¨á Export PNG</button>
            <div id="analytics-export-target" style="display:none"></div>
          </div>
        </div>
      </div>

    </div>

    <!-- ‚ïê‚ïê RATE KIT ‚ïê‚ïê -->
    <div class="page" id="page-ratekit">
      <div class="page-header">
        <div><h1>Rate Kit</h1><p>Brand-ready rate cards for your creators</p></div>
        <button class="btn btn-ghost" onclick="exportKitAsPng('rateKitExportTarget','RateKit')" id="btn-export-ratekit">‚¨á Export PNG</button>
      </div>
      <div class="grid-2">
        <div>
          <div class="card" style="margin-bottom:14px">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
              <div class="card-title">Rate Card</div>
              <select class="form-select" style="width:200px" id="rateKitSelector" onchange="renderRateKit(this.value)">
                <option value="">Select creator‚Ä¶</option>
              </select>
            </div>
            <div id="rateKitPreview">
              <div style="font-size:13px;color:var(--gray-400)">Select a creator to view their rate card.</div>
            </div>
            <!-- Hidden export target (clean, no UI chrome) -->
            <div id="rateKitExportTarget" style="display:none"></div>
          </div>
        </div>
        <div>
          <div class="card">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
              <div class="card-title">Edit Admin Rates</div>
              <span style="font-size:11px;color:var(--gray-400)">Overrides self-reported</span>
            </div>
            <div id="rateKitEditBody">
              <div style="font-size:13px;color:var(--gray-400)">Select a creator above to edit their rates.</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê CAMPAIGNS ‚ïê‚ïê -->
    <div class="page" id="page-campaigns">
      <div class="page-header">
        <div><h1>Campaigns</h1><p id="campaigns-sub-title">0 campaigns total</p></div>
        <button class="btn btn-primary" onclick="openModal('addCampaignModal')">+ New Campaign</button>
      </div>
      <div class="tabs" id="campaignTabs">
        <button class="tab active" onclick="filterCampaigns('all',this)">All</button>
        <button class="tab" onclick="filterCampaigns('Live',this)">Live</button>
        <button class="tab" onclick="filterCampaigns('Negotiating',this)">Negotiating</button>
        <button class="tab" onclick="filterCampaigns('Completed',this)">Completed</button>
      </div>
      <div id="campaignList">
        <div class="empty-state"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><h3>No campaigns yet</h3><p>Create your first campaign to start tracking brand deals</p><button class="btn btn-primary" style="margin-top:16px" onclick="openModal('addCampaignModal')">+ New Campaign</button></div>
      </div>
    </div>

    <!-- ‚ïê‚ïê PITCH DECKS ‚ïê‚ïê -->
    <div class="page" id="page-pitchdecks">
      <div class="page-header">
        <div><h1>Pitch Decks</h1><p id="pitch-sub">Build and send brand-ready pitch decks</p></div>
        <button class="btn btn-primary" onclick="openModal('addPitchModal')">+ New Pitch</button>
      </div>
      <div id="pitchGrid" class="grid-3"></div>
    </div>

    <!-- ‚ïê‚ïê PIPELINE ‚ïê‚ïê -->
    <div class="page" id="page-pipeline">
      <div class="page-header">
        <div><h1>Deal Pipeline</h1><p id="pipeline-sub">Track every deal from pitch to payment</p></div>
        <button class="btn btn-primary" onclick="openModal('addDealModal')">+ Add Deal</button>
      </div>
      <div class="pipeline" id="pipelineBoard"></div>
    </div>

    <!-- ‚ïê‚ïê INBOX ‚ïê‚ïê -->
    <div class="page" id="page-inbox">
      <div class="page-header">
        <div><h1>Inbox</h1><p>Messages from brands & creators</p></div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="font-size:12px;color:var(--gray-400)">IMAP: Read-only preview</div>
          <button class="btn btn-ghost btn-sm" onclick="openModal('imapModal')">Configure Email</button>
        </div>
      </div>
      <div class="inbox-layout">
        <div class="inbox-list" id="inboxList"></div>
        <div class="inbox-pane" id="inboxPane">
          <div class="inbox-empty">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:12px;opacity:.3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            <div style="font-size:13px;font-weight:500;color:var(--gray-600)">Select a message</div>
            <div style="font-size:12px;color:var(--gray-400);margin-top:4px">Click a conversation to read it</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ‚ïê‚ïê USERS & ACCESS ‚ïê‚ïê -->
    <div class="page" id="page-users">
      <div class="page-header">
        <div><h1>Users &amp; Access</h1><p>Manage staff accounts and permissions</p></div>
        <button class="btn btn-primary" id="btn-add-user" onclick="openModal('addUserModal')">+ Add User</button>
      </div>
      <div id="users-perm-denied" style="display:none" class="perm-denied">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <h3>Access Restricted</h3>
        <p>Only the Owner or Admin can manage user accounts.</p>
      </div>
      <div id="users-content">
        <div class="users-grid" id="usersGrid"></div>
        <div style="background:var(--blue-light);border:1px solid rgba(33,152,237,.2);border-radius:var(--radius);padding:14px;margin-top:20px;display:flex;align-items:flex-start;gap:12px">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2" style="flex-shrink:0;margin-top:1px"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
          <div style="font-size:11px;color:var(--blue);line-height:1.6"><strong>Role system:</strong> Owner has full access. Admin can manage most things. Manager can edit creators &amp; deals. Team has read+edit on assigned data. Read Only can only view.</div>
        </div>
      </div>
    </div>

  </div>
</main>

<!-- ‚ïê‚ïê CAMPAIGN REPORTS PAGE ‚ïê‚ïê -->
<div style="display:none" id="page-reports-wrapper">
<div class="page" id="page-reports">
  <div class="page-header">
    <div><h1>Campaign Reports</h1><p>Client-facing performance dashboards</p></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="exportReportPDF()">Export PDF</button>
      <button class="btn btn-primary" onclick="openModal('newReportModal')">+ New Report</button>
    </div>
  </div>

  <!-- Report selector -->
  <div class="card" style="margin-bottom:20px">
    <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap">
      <div class="form-group" style="min-width:200px;margin:0">
        <select class="form-select" id="reportCampaignSelect" onchange="loadReport(this.value)">
          <option value="">Select a campaign‚Ä¶</option>
        </select>
      </div>
      <button class="btn btn-ghost btn-sm" onclick="loadReport(document.getElementById('reportCampaignSelect').value)">Load Report</button>
    </div>
  </div>

  <div id="reportContent" style="display:none">
    <!-- Report header -->
    <div class="card" style="margin-bottom:20px;background:linear-gradient(135deg,var(--blue) 0%,#1478c4 100%);color:white;border:none" id="reportHeader">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px">
        <div>
          <div style="font-size:11px;font-weight:600;opacity:.7;text-transform:uppercase;letter-spacing:1px;margin-bottom:6px">Campaign Report</div>
          <div style="font-size:24px;font-family:'DM Serif Display',serif" id="reportTitle">Campaign Name</div>
          <div style="font-size:13px;opacity:.8;margin-top:4px" id="reportMeta">Brand ¬∑ Creator ¬∑ Date</div>
        </div>
        <div style="text-align:right">
          <div style="font-size:11px;opacity:.7">Total Value</div>
          <div style="font-size:28px;font-weight:700" id="reportTotalValue">¬£0</div>
        </div>
      </div>
    </div>

    <!-- Report tabs -->
    <div style="display:flex;gap:0;border-bottom:2px solid var(--gray-100);margin-bottom:20px">
      <button class="profile-tab active" onclick="switchReportTab('overview',this)">Overview</button>
      <button class="profile-tab" onclick="switchReportTab('creators',this)">Creators</button>
      <button class="profile-tab" onclick="switchReportTab('content',this)">Content</button>
      <button class="profile-tab" onclick="switchReportTab('audience',this)">Audience</button>
    </div>

    <!-- Overview tab -->
    <div id="rtab-overview" class="profile-tab-content active">
      <!-- KPI Cards -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:16px;margin-bottom:20px" id="reportKPIs"></div>
      <!-- Creator table -->
      <div class="card">
        <div class="card-title" style="margin-bottom:16px">Creator Performance</div>
        <div class="table-wrap">
          <table id="reportCreatorTable">
            <thead><tr>
              <th>Creator</th><th>Posts</th><th>Est. Impressions</th><th>Eng. Rate</th><th>Value</th><th>Status</th>
            </tr></thead>
            <tbody id="reportCreatorTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Creators tab -->
    <div id="rtab-creators" class="profile-tab-content">
      <div id="reportCreatorsDetail"></div>
    </div>

    <!-- Content tab -->
    <div id="rtab-content" class="profile-tab-content">
      <div class="card">
        <div class="card-title" style="margin-bottom:12px">Content Deliverables</div>
        <div id="reportContentDetail"><div style="font-size:13px;color:var(--gray-400)">No content data yet ‚Äî add deliverables to campaign.</div></div>
      </div>
    </div>

    <!-- Audience tab -->
    <div id="rtab-audience" class="profile-tab-content">
      <div class="card">
        <div class="card-title" style="margin-bottom:12px">Audience Insights</div>
        <div id="reportAudienceDetail"><div style="font-size:13px;color:var(--gray-400)">Audience data from creator onboarding will appear here.</div></div>
      </div>
    </div>
  </div>

  <div id="reportEmpty" class="empty-state" style="margin-top:40px">
    <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M3 9h18M9 21V9"/></svg>
    <h3>Select a campaign to view its report</h3>
    <p>Campaign reports are auto-generated from your campaigns and creator data</p>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê INVOICE GENERATOR PAGE ‚ïê‚ïê -->
<div style="display:none" id="page-invoice-wrapper">
<div class="page" id="page-invoice">
  <div class="page-header">
    <div><h1>Invoice Generator</h1><p>Create and export professional invoices</p></div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-ghost" onclick="clearInvoice()">Clear</button>
      <button class="btn btn-primary" onclick="exportInvoicePDF()">Export PDF</button>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:1fr 420px;gap:20px;align-items:start">
    <!-- Invoice form -->
    <div class="card">
      <div class="card-title" style="margin-bottom:20px">Invoice Details</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Invoice Title</label><input class="form-input" id="inv-title" placeholder="Invoice" value="Invoice"></div>
        <div class="form-group"><label class="form-label">Invoice Number</label><input class="form-input" id="inv-number" placeholder="INV-001"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Issue Date</label><input class="form-input" id="inv-issue" type="date"></div>
        <div class="form-group"><label class="form-label">Due Date</label><input class="form-input" id="inv-due" type="date"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Bill To (Client)</label><textarea class="form-textarea" id="inv-billto" placeholder="Client Name&#10;Company&#10;Address&#10;Email" style="min-height:80px"></textarea></div>
        <div class="form-group"><label class="form-label">Pay To (Your Details)</label><textarea class="form-textarea" id="inv-payto" placeholder="blustu‚Ñ¢ Talent Agency&#10;Your Address&#10;bank@blustu.agency" style="min-height:80px" value="blustu‚Ñ¢ Talent Agency"></textarea></div>
      </div>
      <div class="form-group"><label class="form-label">Payment Method</label><input class="form-input" id="inv-payment" placeholder="e.g. Bank Transfer ‚Äî Sort: 00-00-00 Acc: 00000000"></div>

      <div class="card-title" style="margin:20px 0 12px">Line Items</div>
      <div id="inv-items">
        <div class="inv-item-row" style="display:grid;grid-template-columns:1fr 80px 90px 28px;gap:8px;margin-bottom:8px">
          <input class="form-input" placeholder="Description" oninput="updateInvoicePreview()">
          <input class="form-input" placeholder="Qty" type="number" value="1" oninput="updateInvoicePreview()">
          <input class="form-input" placeholder="Rate ¬£" type="number" oninput="updateInvoicePreview()">
          <button class="btn btn-ghost btn-sm" onclick="removeInvItem(this)" style="padding:4px 8px">‚úï</button>
        </div>
      </div>
      <button class="btn btn-ghost btn-sm" style="margin-top:4px" onclick="addInvItem()">+ Add Line Item</button>

      <div class="form-row" style="margin-top:20px">
        <div class="form-group"><label class="form-label">Tax (%)</label><input class="form-input" id="inv-tax" type="number" value="0" placeholder="0" oninput="updateInvoicePreview()"></div>
        <div class="form-group"><label class="form-label">Notes</label><input class="form-input" id="inv-notes" placeholder="Payment terms, thank you note..."></div>
      </div>
      <div class="form-row" style="margin-top:16px">
        <div class="form-group"><label class="form-label">Digital Signature</label><input class="form-input" id="inv-signature" placeholder="Your name / signature"></div>
        <div class="form-group"><label class="form-label">Signature Date</label><input class="form-input" id="inv-sigdate" type="date"></div>
      </div>
    </div>

    <!-- Invoice preview -->
    <div>
      <div style="font-size:11px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Live Preview</div>
      <div id="invoicePreview" style="background:white;border-radius:var(--radius);padding:32px;box-shadow:var(--shadow-md);font-size:12px;line-height:1.6">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:28px">
          <div>
            <div style="font-size:22px;font-family:'DM Serif Display',serif;color:var(--blue)" id="prev-title">Invoice</div>
            <div style="color:var(--gray-400);font-size:11px" id="prev-number">INV-001</div>
          </div>
          <div style="text-align:right;font-size:11px;color:var(--gray-400)">
            <div>blustu‚Ñ¢ Talent Agency</div>
            <div id="prev-dates"></div>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
          <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--gray-400);margin-bottom:4px">Bill To</div><div id="prev-billto" style="white-space:pre-wrap;font-size:11px"></div></div>
          <div><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--gray-400);margin-bottom:4px">Pay To</div><div id="prev-payto" style="white-space:pre-wrap;font-size:11px"></div></div>
        </div>
        <table style="width:100%;border-collapse:collapse;margin-bottom:16px">
          <thead><tr style="background:var(--gray-50)">
            <th style="text-align:left;padding:6px 8px;font-size:10px;text-transform:uppercase;color:var(--gray-400)">Description</th>
            <th style="text-align:right;padding:6px 8px;font-size:10px;text-transform:uppercase;color:var(--gray-400)">Qty</th>
            <th style="text-align:right;padding:6px 8px;font-size:10px;text-transform:uppercase;color:var(--gray-400)">Rate</th>
            <th style="text-align:right;padding:6px 8px;font-size:10px;text-transform:uppercase;color:var(--gray-400)">Amount</th>
          </tr></thead>
          <tbody id="prev-items"></tbody>
        </table>
        <div style="text-align:right;margin-bottom:20px" id="prev-totals"></div>
        <div style="border-top:1px solid var(--gray-100);padding-top:12px;font-size:11px;color:var(--gray-400)" id="prev-footer"></div>
        <div style="margin-top:20px;padding-top:16px;border-top:1px solid var(--gray-100)">
          <div style="font-size:10px;color:var(--gray-400);margin-bottom:4px">Authorised Signature</div>
          <div style="font-family:'DM Serif Display',serif;font-size:16px;color:var(--gray-900)" id="prev-signature"></div>
          <div style="font-size:10px;color:var(--gray-400)" id="prev-sigdate"></div>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê MODALS ‚ïê‚ïê -->

<!-- Add Creator -->
<div class="modal-overlay" id="addCreatorModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Add Creator</div><button class="modal-close" onclick="closeModal('addCreatorModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-row"><div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="nc-name" placeholder="e.g. Alex or Kim"></div><div class="form-group"><label class="form-label">Email</label><input class="form-input" id="nc-email" placeholder="name@blustu.agency"></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Niche</label><select class="form-select" id="nc-niche"><option>Lifestyle</option><option>Fashion</option><option>Fitness</option><option>Food</option><option>Tech</option><option>Travel</option><option>Entertainment</option></select></div><div class="form-group"><label class="form-label">Location</label><input class="form-input" id="nc-loc" placeholder="e.g. UK"></div></div>
      <div class="form-group"><label class="form-label">Role</label><select class="form-select" id="nc-role"><option>Creator</option><option>Creator / Manager</option><option>Creator / Owner</option><option>Meme Page</option></select></div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('addCreatorModal')">Cancel</button><button class="btn btn-primary" onclick="addCreator()">Add to Roster</button></div>
  </div>
</div>

<!-- Creator Quick View -->
<div class="modal-overlay" id="creatorModal">
  <div class="modal">
    <div class="modal-header">
      <div style="display:flex;align-items:center;gap:12px"><div class="creator-avatar" id="cm-avatar" style="width:40px;height:40px;font-size:14px">?</div><div><div class="modal-title" id="cm-name">Creator</div><div style="font-size:12px;color:var(--gray-400)" id="cm-sub"></div></div></div>
      <button class="modal-close" onclick="closeModal('creatorModal')">‚úï</button>
    </div>
    <div class="modal-body">
      <div style="background:var(--blue-light);border-radius:10px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--blue)">‚ÑπÔ∏è Metrics populate after creator completes onboarding and connects their socials.</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px">
        <div style="background:var(--gray-50);border-radius:10px;padding:12px;text-align:center"><div style="font-family:'DM Serif Display',serif;font-size:22px">‚Äî</div><div style="font-size:11px;color:var(--gray-400)">Followers</div></div>
        <div style="background:var(--gray-50);border-radius:10px;padding:12px;text-align:center"><div style="font-family:'DM Serif Display',serif;font-size:22px">‚Äî</div><div style="font-size:11px;color:var(--gray-400)">Eng. Rate</div></div>
        <div style="background:var(--gray-50);border-radius:10px;padding:12px;text-align:center"><div style="font-family:'DM Serif Display',serif;font-size:22px" id="cm-deals">0</div><div style="font-size:11px;color:var(--gray-400)">Active Deals</div></div>
      </div>
      <div id="cm-onboard-info"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('creatorModal')">Close</button><button class="btn btn-ghost" id="cm-invite-btn">Send Onboard Link</button><button class="btn btn-primary" id="cm-profile-btn">Full Profile</button></div>
  </div>
</div>

<!-- Invite Creator -->
<div class="modal-overlay" id="inviteCreatorModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Invite Creator to Onboard</div><button class="modal-close" onclick="closeModal('inviteCreatorModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Select Creator</label><select class="form-select" id="invite-creator-select" onchange="updateInviteLink()"></select></div>
      <div style="background:var(--gray-50);border-radius:10px;padding:14px;margin-top:4px">
        <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin-bottom:8px">Unique Onboarding Link</div>
        <div style="display:flex;gap:8px;align-items:center">
          <input class="form-input" id="invite-link-preview" value="" readonly style="font-size:11px;color:var(--gray-400)">
          <button class="btn btn-ghost btn-sm" onclick="copyInviteLink()">Copy</button>
        </div>
        <div style="font-size:11px;color:var(--gray-400);margin-top:8px">Share this link with the creator. They'll complete their onboarding form via this link.</div>
      </div>
      <div style="margin-top:16px;padding:12px;background:var(--amber-light);border-radius:10px;font-size:12px;color:var(--amber)">
        ‚ö†Ô∏è Full IMAP email send requires server-side setup. For now, copy the link and share it manually or via your email client.
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('inviteCreatorModal')">Cancel</button><button class="btn btn-primary" onclick="sendInvite()">Mark as Invited</button></div>
  </div>
</div>

<!-- Add Campaign -->
<div class="modal-overlay" id="addCampaignModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">New Campaign</div><button class="modal-close" onclick="closeModal('addCampaignModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Brand Name</label><input class="form-input" id="camp-brand" placeholder="e.g. GymShark"></div>
        <div class="form-group">
          <label class="form-label">Creator(s)</label>
          <div style="display:flex;gap:6px;flex-wrap:wrap;align-items:flex-start">
            <select class="form-select" id="camp-creator" style="flex:1;min-width:120px"></select>
            <button class="btn btn-ghost btn-sm" style="white-space:nowrap;flex-shrink:0" onclick="openGridForCampaignModal()">üîç Multi-select</button>
          </div>
          <!-- Multi-creator chips: populated when grid selection > 1 -->
          <div id="camp-creators-chips" style="display:none;margin-top:8px;display:flex;flex-wrap:wrap;gap:6px"></div>
          <input type="hidden" id="camp-creator-ids" value="">
        </div>
      </div>
      <div class="form-row"><div class="form-group"><label class="form-label">Deal Value (¬£)</label><input class="form-input" id="camp-value" type="number" placeholder="800"></div><div class="form-group"><label class="form-label">Deadline</label><input class="form-input" id="camp-deadline" type="date"></div></div>
      <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="camp-status"><option>Negotiating</option><option>Live</option><option>Completed</option><option>Paused</option></select></div>
      <div class="form-group"><label class="form-label">Deliverables</label><input class="form-input" id="camp-deliverables" placeholder="e.g. 1√ó Reel + 3√ó Stories"></div>
      <div class="form-group"><label class="form-label">Progress (%)</label><input class="form-input" id="camp-progress" type="number" min="0" max="100" value="0"></div>
      <div class="form-group"><label class="form-label">Brief / Notes</label><textarea class="form-textarea" id="camp-notes" placeholder="Campaign details, content direction..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('addCampaignModal')">Cancel</button><button class="btn btn-primary" onclick="saveCampaign()">Create Campaign</button></div>
  </div>
</div>

<!-- Edit Campaign -->
<div class="modal-overlay" id="editCampaignModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Edit Campaign</div><button class="modal-close" onclick="closeModal('editCampaignModal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-camp-id">
      <div class="form-row"><div class="form-group"><label class="form-label">Brand</label><input class="form-input" id="edit-camp-brand"></div><div class="form-group"><label class="form-label">Creator</label><select class="form-select" id="edit-camp-creator"></select></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Deal Value (¬£)</label><input class="form-input" id="edit-camp-value" type="number"></div><div class="form-group"><label class="form-label">Deadline</label><input class="form-input" id="edit-camp-deadline" type="date"></div></div>
      <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="edit-camp-status"><option>Negotiating</option><option>Live</option><option>Completed</option><option>Paused</option><option>Cancelled</option></select></div>
      <div class="form-group"><label class="form-label">Deliverables</label><input class="form-input" id="edit-camp-deliverables"></div>
      <div class="form-group"><label class="form-label">Progress (%)</label><input class="form-input" id="edit-camp-progress" type="number" min="0" max="100"></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="edit-camp-notes"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="deleteCampaign()">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('editCampaignModal')">Cancel</button>
      <button class="btn btn-primary" onclick="updateCampaign()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Add Pitch -->
<div class="modal-overlay" id="addPitchModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">New Pitch Deck</div><button class="modal-close" onclick="closeModal('addPitchModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-row"><div class="form-group"><label class="form-label">Target Brand</label><input class="form-input" id="pitch-brand" placeholder="e.g. Nike"></div><div class="form-group"><label class="form-label">Creator</label><select class="form-select" id="pitch-creator"></select></div></div>
      <div class="form-group"><label class="form-label">Campaign Concept</label><input class="form-input" id="pitch-concept" placeholder="e.g. Summer lookbook series"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Proposed Rate (¬£)</label><input class="form-input" id="pitch-rate" type="number" placeholder="1000"></div><div class="form-group"><label class="form-label">Brand Contact Email</label><input class="form-input" id="pitch-email" placeholder="partnerships@brand.com"></div></div>
      <div class="form-group"><label class="form-label">Pitch Message</label><textarea class="form-textarea" id="pitch-message" placeholder="Key selling points, why this creator is perfect..."></textarea></div>
      <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="pitch-status"><option value="Draft">Draft</option><option value="Sent">Sent</option></select></div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('addPitchModal')">Cancel</button><button class="btn btn-ghost" onclick="savePitch('Draft')">Save Draft</button><button class="btn btn-primary" onclick="savePitch('Sent')">Generate & Send</button></div>
  </div>
</div>

<!-- Edit Pitch -->
<div class="modal-overlay" id="editPitchModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Edit Pitch Deck</div><button class="modal-close" onclick="closeModal('editPitchModal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-pitch-id">
      <div class="form-row"><div class="form-group"><label class="form-label">Brand</label><input class="form-input" id="edit-pitch-brand"></div><div class="form-group"><label class="form-label">Creator</label><select class="form-select" id="edit-pitch-creator"></select></div></div>
      <div class="form-group"><label class="form-label">Campaign Concept</label><input class="form-input" id="edit-pitch-concept"></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Proposed Rate (¬£)</label><input class="form-input" id="edit-pitch-rate" type="number"></div><div class="form-group"><label class="form-label">Brand Contact Email</label><input class="form-input" id="edit-pitch-email"></div></div>
      <div class="form-group"><label class="form-label">Pitch Message</label><textarea class="form-textarea" id="edit-pitch-message"></textarea></div>
      <div class="form-group"><label class="form-label">Status</label><select class="form-select" id="edit-pitch-status"><option>Draft</option><option>Sent</option><option>Viewed</option><option>Interested</option><option>Declined</option></select></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="deletePitch()">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('editPitchModal')">Cancel</button>
      <button class="btn btn-primary" onclick="updatePitch()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Add Deal -->
<div class="modal-overlay" id="addDealModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Add Deal to Pipeline</div><button class="modal-close" onclick="closeModal('addDealModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-row"><div class="form-group"><label class="form-label">Brand</label><input class="form-input" id="deal-brand" placeholder="Brand name"></div><div class="form-group"><label class="form-label">Creator</label><select class="form-select" id="deal-creator"></select></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Value (¬£)</label><input class="form-input" id="deal-value" type="number" placeholder="600"></div><div class="form-group"><label class="form-label">Stage</label><select class="form-select" id="deal-stage"><option>Prospect</option><option>Pitched</option><option>Negotiating</option><option>Live</option><option>Delivered</option><option>Completed</option><option>Lost</option></select></div></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="deal-notes" placeholder="Deal context, next steps..."></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('addDealModal')">Cancel</button><button class="btn btn-primary" onclick="saveDeal()">Add Deal</button></div>
  </div>
</div>

<!-- Edit Deal -->
<div class="modal-overlay" id="editDealModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Edit Deal</div><button class="modal-close" onclick="closeModal('editDealModal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="edit-deal-id">
      <div class="form-row"><div class="form-group"><label class="form-label">Brand</label><input class="form-input" id="edit-deal-brand"></div><div class="form-group"><label class="form-label">Creator</label><select class="form-select" id="edit-deal-creator"></select></div></div>
      <div class="form-row"><div class="form-group"><label class="form-label">Value (¬£)</label><input class="form-input" id="edit-deal-value" type="number"></div><div class="form-group"><label class="form-label">Stage</label><select class="form-select" id="edit-deal-stage"><option>Prospect</option><option>Pitched</option><option>Negotiating</option><option>Live</option><option>Delivered</option><option>Completed</option><option>Lost</option></select></div></div>
      <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="edit-deal-notes"></textarea></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" onclick="deleteDeal()">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('editDealModal')">Cancel</button>
      <button class="btn btn-primary" onclick="updateDeal()">Save Changes</button>
    </div>
  </div>
</div>

<!-- Generate Kit -->
<div class="modal-overlay" id="genKitModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Generate Media Kit</div><button class="modal-close" onclick="closeModal('genKitModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-group"><label class="form-label">Creator</label><select class="form-select" id="kit-creator-select" onchange="onKitCreatorChange(this.value)"></select></div>
      <div class="form-group"><label class="form-label">Target Brand / Campaign</label><input class="form-input" id="kit-brand" placeholder="e.g. GymShark Fitness Campaign"></div>
      <div class="form-group"><label class="form-label">Highlight <span style="color:var(--gray-400);font-weight:400">(optional)</span></label><textarea class="form-textarea" id="kit-highlight" placeholder="What should this kit emphasise?"></textarea></div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('genKitModal')">Cancel</button><button class="btn btn-primary" onclick="generateKit()">Generate Kit</button></div>
  </div>
</div>

<!-- IMAP Config -->
<div class="modal-overlay" id="imapModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Configure Email (IMAP)</div><button class="modal-close" onclick="closeModal('imapModal')">‚úï</button></div>
    <div class="modal-body">
      <div style="background:var(--amber-light);border-radius:10px;padding:14px;margin-bottom:16px;font-size:13px;color:var(--amber);line-height:1.6">
        <strong>‚ö†Ô∏è Server-side required:</strong><br>Full IMAP integration requires a backend server to proxy email connections securely. This cannot be done client-side in a browser for security reasons.<br><br>
        Your @blustu.agency emails are Google Workspace accounts. To enable full email in this panel, you would need to set up a Node.js/Python backend with the <code>imapflow</code> or <code>imap</code> library, or use the Gmail API with OAuth2.
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Incoming (IMAP)</label><input class="form-input" value="mail.blustu.agency" readonly></div>
        <div class="form-group"><label class="form-label">Outgoing (SMTP)</label><input class="form-input" value="mail.blustu.agency" readonly></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">IMAP Port</label><input class="form-input" value="993 (SSL)" readonly></div>
        <div class="form-group"><label class="form-label">SMTP Port</label><input class="form-input" value="465 (SSL)" readonly></div>
      </div>
      <div class="form-group"><label class="form-label">Your @blustu.agency Email</label><input class="form-input" id="imap-email" placeholder="you@blustu.agency"></div>
      <div style="font-size:12px;color:var(--gray-400);margin-top:8px">For now, the inbox displays sample messages. Full email access is ready for backend integration.</div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('imapModal')">Close</button><button class="btn btn-primary" onclick="showToast('Backend integration required for live email. See notes above.');closeModal('imapModal')">Save Config</button></div>
  </div>
</div>

<!-- Analytics Edit Modal -->
<div class="modal-overlay" id="analyticsModal">
  <div class="modal modal-wide">
    <div class="modal-header"><div class="modal-title">Edit Analytics Data</div><button class="modal-close" onclick="closeModal('analyticsModal')">‚úï</button></div>
    <div class="modal-body">
      <div style="font-size:12px;color:var(--gray-400);margin-bottom:16px">Enter analytics for: <strong id="ana-kit-name">‚Äî</strong></div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Total Views</label><input class="form-input" id="ana-input-views" type="number" placeholder="0"></div>
        <div class="form-group"><label class="form-label">Opens</label><input class="form-input" id="ana-input-opens" type="number" placeholder="0"></div>
        <div class="form-group" style="display:none"><label class="form-label">Link Clicks</label><input class="form-input" id="ana-input-clicks" type="number" placeholder="0"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Link Clicks</label><input class="form-input" id="ana-input-clicks2" type="number" placeholder="0"></div>
      </div>
      <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin:14px 0 8px">Age Breakdown (% per bracket)</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">13‚Äì17</label><input class="form-input" id="ana-age-1317" type="number" min="0" max="100" placeholder="0"></div>
        <div class="form-group"><label class="form-label">18‚Äì24</label><input class="form-input" id="ana-age-1824" type="number" min="0" max="100" placeholder="0"></div>
        <div class="form-group"><label class="form-label">25‚Äì34</label><input class="form-input" id="ana-age-2534" type="number" min="0" max="100" placeholder="0"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">35‚Äì44</label><input class="form-input" id="ana-age-3544" type="number" min="0" max="100" placeholder="0"></div>
        <div class="form-group"><label class="form-label">45‚Äì54</label><input class="form-input" id="ana-age-4554" type="number" min="0" max="100" placeholder="0"></div>
        <div class="form-group"><label class="form-label">55+</label><input class="form-input" id="ana-age-55" type="number" min="0" max="100" placeholder="0"></div>
      </div>
      <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin:14px 0 8px">Gender Breakdown (%)</div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Female</label><input class="form-input" id="ana-gender-f" type="number" min="0" max="100" placeholder="0"></div>
        <div class="form-group"><label class="form-label">Male</label><input class="form-input" id="ana-gender-m" type="number" min="0" max="100" placeholder="0"></div>
        <div class="form-group"><label class="form-label">Other</label><input class="form-input" id="ana-gender-o" type="number" min="0" max="100" placeholder="0"></div>
      </div>
      <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin:14px 0 8px">Top Locations (e.g. "UK ‚Äì 45%")</div>
      <div class="form-group"><input class="form-input" id="ana-loc-1" placeholder="Country / City ‚Äì %"></div>
      <div class="form-group"><input class="form-input" id="ana-loc-2" placeholder="Country / City ‚Äì %"></div>
      <div class="form-group"><input class="form-input" id="ana-loc-3" placeholder="Country / City ‚Äì %"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('analyticsModal')">Cancel</button><button class="btn btn-primary" onclick="saveAnalytics()">Save Analytics</button></div>
  </div>
</div>

<!-- Add User Modal -->
<div class="modal-overlay" id="addUserModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Add Staff Account</div><button class="modal-close" onclick="closeModal('addUserModal')">‚úï</button></div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="nu-name" placeholder="e.g. Sarah"></div>
        <div class="form-group"><label class="form-label">Email</label><input class="form-input" id="nu-email" type="email" placeholder="sarah@blustu.agency"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label class="form-label">Password</label><input class="form-input" id="nu-pass" type="password" placeholder="Min 8 characters"></div>
        <div class="form-group"><label class="form-label">Role</label><select class="form-select" id="nu-role"><option value="admin">Admin</option><option value="manager">Manager</option><option value="team">Team</option><option value="readonly">Read Only</option></select></div>
      </div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('addUserModal')">Cancel</button><button class="btn btn-primary" onclick="addStaffUser()">Add User</button></div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal-overlay" id="editUserModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Edit User</div><button class="modal-close" onclick="closeModal('editUserModal')">‚úï</button></div>
    <div class="modal-body">
      <input type="hidden" id="eu-email">
      <div class="form-row">
        <div class="form-group"><label class="form-label">Full Name</label><input class="form-input" id="eu-name"></div>
        <div class="form-group"><label class="form-label">Role</label><select class="form-select" id="eu-role"><option value="owner">Owner</option><option value="admin">Admin</option><option value="manager">Manager</option><option value="team">Team</option><option value="readonly">Read Only</option></select></div>
      </div>
      <div class="form-group"><label class="form-label">Reset Password <span style="color:var(--gray-400);font-weight:400">(leave blank to keep current)</span></label><input class="form-input" id="eu-pass" type="password" placeholder="New password"></div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-danger btn-sm" id="eu-delete-btn" onclick="deleteStaffUser()">Delete</button>
      <button class="btn btn-ghost" onclick="closeModal('editUserModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveStaffUser()">Save</button>
    </div>
  </div>
</div>


<div class="modal-overlay" id="profileModal">
  <div class="modal">
    <div class="modal-header"><div class="modal-title">Your Profile</div><button class="modal-close" onclick="closeModal('profileModal')">‚úï</button></div>
    <div class="modal-body">
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:20px">
        <div class="user-avatar" style="width:48px;height:48px;font-size:18px" id="profile-modal-avatar">U</div>
        <div><div style="font-size:16px;font-weight:600" id="profile-modal-name">Ubayy</div><div style="font-size:12px;color:var(--gray-400)" id="profile-modal-email">ubayy@blustu.agency</div></div>
      </div>
      <div class="form-group"><label class="form-label">Display Name</label><input class="form-input" id="profile-modal-display" placeholder="Your name"></div>
    </div>
    <div class="modal-footer"><button class="btn btn-ghost" onclick="closeModal('profileModal')">Close</button><button class="btn btn-primary" onclick="saveProfile()">Save</button></div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   blustu‚Ñ¢ Internal Panel ‚Äî v3.0
   Features: RBAC, persistence, global search, campaign-deal link,
             media kit analytics, profile pictures, mobile support
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* ‚îÄ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Single source of truth for all shared CRM data.
   All staff on all devices see the same data.
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const SUPABASE_URL = 'https://vvtzgqcnquygnmljdptt.supabase.co';
const SUPABASE_KEY = 'sb_publishable_OeYUA2VVPH4uAowVvSWtxA_-jC9OznJ';

// ‚îÄ‚îÄ DB: core Supabase REST wrapper ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const DB = {
  _headers() {
    return {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation'
    };
  },

  async _req(method, table, body, query = '') {
    const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
    const opts = { method, headers: this._headers() };
    if (body !== null && body !== undefined) opts.body = JSON.stringify(body);
    try {
      const r = await fetch(url, opts);
      const text = await r.text();
      if (!r.ok) {
        console.error(`DB ${method} ${table} failed (${r.status}):`, text);
        showToast(`‚ö†Ô∏è Save failed: ${r.status}. Check console.`);
        return null;
      }
      return text ? JSON.parse(text) : [];
    } catch(e) {
      console.error(`DB ${method} ${table} network error:`, e);
      showToast('‚ö†Ô∏è Network error ‚Äî check your connection.');
      return null;
    }
  },

  // Fetch all rows from a table, ordered by id
  async select(table, query = '') {
    return this._req('GET', table, null, query || '?order=id');
  },

  // Upsert one row ‚Äî uses merge-duplicates which is required for UPDATE on conflict
  async upsertOne(table, row) {
    console.log(`[DB] upsertOne ${table} id=${row.id}`);
    const url = `${SUPABASE_URL}/rest/v1/${table}`;
    try {
      const r = await fetch(url, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation,resolution=merge-duplicates',
        },
        body: JSON.stringify([row])
      });
      const text = await r.text();
      console.log(`[DB] upsertOne ${table} => ${r.status}`, text.slice(0, 200));
      if (!r.ok) {
        console.error(`[DB] upsertOne FAILED ${r.status}:`, text);
        showToast('Save error ' + r.status + ' ‚Äî open browser console for details');
        return null;
      }
      return text ? JSON.parse(text) : [];
    } catch(e) {
      console.error(`[DB] upsertOne network error:`, e);
      showToast('Network error ‚Äî check connection');
      return null;
    }
  },

  // Upsert many rows ‚Äî same merge-duplicates Prefer header
  async upsertMany(table, rows) {
    if (!rows || !rows.length) return [];
    const results = [];
    for (let i = 0; i < rows.length; i += 50) {
      const chunk = rows.slice(i, i + 50);
      const url = `${SUPABASE_URL}/rest/v1/${table}`;
      try {
        const r = await fetch(url, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation,resolution=merge-duplicates',
          },
          body: JSON.stringify(chunk)
        });
        const text = await r.text();
        if (r.ok && text) { try { results.push(...JSON.parse(text)); } catch(_){} }
        else if (!r.ok) console.error(`[DB] upsertMany ${table} ${r.status}:`, text.slice(0,200));
      } catch(e) { console.error(`[DB] upsertMany ${table} error:`, e); }
    }
    return results;
  },

  // Delete a single row by its integer id
  async delete(table, id) {
    const numId = parseInt(id, 10);
    console.log(`DB delete ${table} id=${numId} (type: ${typeof numId})`);
    if (isNaN(numId)) { console.error('delete: id is NaN', id); return null; }
    const result = await this._req('DELETE', table, null, `?id=eq.${numId}`);
    console.log(`DB delete ${table} result:`, result);
    return result;
  },

  // Delete rows matching a field=value filter
  async deleteWhere(table, field, value) {
    const numVal = parseInt(value, 10);
    console.log(`DB deleteWhere ${table} ${field}=${numVal}`);
    return this._req('DELETE', table, null, `?${field}=eq.${numVal}`);
  },

  // Upsert a key-value pair in app_data
  async setAppData(key, value) {
    return this._req('POST', 'app_data', [{key, value: JSON.stringify(value)}], '?on_conflict=key');
  },

  async getAppData(key) {
    const rows = await this._req('GET', 'app_data', null, `?key=eq.${encodeURIComponent(key)}`);
    if (rows && rows.length) {
      try { return JSON.parse(rows[0].value); } catch(e) { return null; }
    }
    return null;
  }
};

/* ‚îÄ‚îÄ‚îÄ STORAGE: localStorage cache + Supabase write-through ‚îÄ‚îÄ‚îÄ‚îÄ
   Rule: Always write to Supabase first. Only update UI on success.
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
const Storage = {
  _prefix: 'blustu_',
  get(key, fallback = null) {
    try { const r = localStorage.getItem(this._prefix+key); return r!==null?JSON.parse(r):fallback; } catch(e){return fallback;}
  },
  set(key, value) {
    try { localStorage.setItem(this._prefix+key, JSON.stringify(value)); } catch(e){}
    return value;
  },
  updateEntity(collectionKey, id, updates, idField='id') {
    const arr = this.get(collectionKey, []);
    const idx = arr.findIndex(x=>x[idField]===id);
    if(idx>-1){arr[idx]={...arr[idx],...updates}; this.set(collectionKey,arr);}
    return arr;
  },
  deleteEntity(collectionKey, id, idField='id') {
    const arr = this.get(collectionKey,[]).filter(x=>x[idField]!==id);
    this.set(collectionKey,arr);
    return arr;
  }
};

// ‚îÄ‚îÄ ROLE-BASED ACCESS CONTROL (RBAC) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Roles: owner > admin > manager > team > readonly

// Default staff accounts ‚Äî loaded from localStorage if available
const DEFAULT_STAFF = [
  {email:'ubayy@blustu.agency', pass:'blustu2026', name:'Ubayy', systemRole:'owner'},
  {email:'rayyan@blustu.agency', pass:'blustu2026', name:'Rayyan', systemRole:'manager'},
  {email:'admin@blustu.agency',  pass:'admin2026',  name:'Admin',  systemRole:'admin'},
  {email:'manager@blustu.agency',pass:'manager2026',name:'Manager',systemRole:'manager'},
  {email:'team@blustu.agency',   pass:'team2026',   name:'Team',   systemRole:'team'},
  {email:'ops@blustu.agency',    pass:'ops2026',    name:'Ops',    systemRole:'readonly'},
];

// Role display labels
const ROLE_LABELS = {owner:'Owner',admin:'Admin',manager:'Manager',team:'Team',readonly:'Read Only'};

// Role capabilities ‚Äî what each role can do
const ROLE_CAPS = {
  owner:    {addUser:true,  deleteUser:true, editUser:true, addCreator:true, editCreator:true, deleteCreator:true, viewNotes:true, editNotes:true, addCampaign:true, editCampaign:true, addDeal:true, editDeal:true, addPitch:true, editPitch:true, viewInbox:true, viewPipeline:true},
  admin:    {addUser:true,  deleteUser:false,editUser:true, addCreator:true, editCreator:true, deleteCreator:true, viewNotes:true, editNotes:true, addCampaign:true, editCampaign:true, addDeal:true, editDeal:true, addPitch:true, editPitch:true, viewInbox:true, viewPipeline:true},
  manager:  {addUser:false, deleteUser:false,editUser:false,addCreator:true, editCreator:true, deleteCreator:false,viewNotes:true, editNotes:true, addCampaign:true, editCampaign:true, addDeal:true, editDeal:true, addPitch:true, editPitch:true, viewInbox:true, viewPipeline:true},
  team:     {addUser:false, deleteUser:false,editUser:false,addCreator:false,editCreator:false,deleteCreator:false,viewNotes:false,editNotes:false,addCampaign:false,editCampaign:false,addDeal:false,editDeal:false, addPitch:false,editPitch:false,viewInbox:true, viewPipeline:true},
  readonly: {addUser:false, deleteUser:false,editUser:false,addCreator:false,editCreator:false,deleteCreator:false,viewNotes:false,editNotes:false,addCampaign:false,editCampaign:false,addDeal:false,editDeal:false, addPitch:false,editPitch:false,viewInbox:false,viewPipeline:true},
};

// Check if current user has a capability
function can(cap) {
  if (!currentUser) return false;
  const role = currentUser.systemRole || 'readonly';
  return !!(ROLE_CAPS[role] && ROLE_CAPS[role][cap]);
}

// ‚îÄ‚îÄ PERSISTENCE HELPERS (delegates to Storage layer) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveToStorage(key, value) { return Storage.set(key, value); }
function loadFromStorage(key, fallback) { return Storage.get(key, fallback); }

// ‚îÄ‚îÄ LOAD STAFF FROM STORAGE ‚îÄ‚îÄ
let STAFF = loadFromStorage('staff', DEFAULT_STAFF);
// Ensure owner account always exists and has owner role
const ownerIdx = STAFF.findIndex(s => s.email === 'ubayy@blustu.agency');
if (ownerIdx === -1) {
  STAFF.unshift({email:'ubayy@blustu.agency',pass:'blustu2026',name:'Ubayy',systemRole:'owner'});
} else {
  STAFF[ownerIdx].systemRole = 'owner'; // force owner role
}

const AVATAR_COLORS = ['#6366F1','#EC4899','#14B8A6','#F97316','#A78BFA','#34D399','#2198ED','#F59E0B','#EF4444','#10B981','#8B5CF6','#06B6D4','#84CC16','#E11D48','#0EA5E9','#7C3AED','#D97706','#059669','#DC2626','#2563EB','#9333EA','#16A34A','#CA8A04','#0891B2','#65A30D'];

// ‚îÄ‚îÄ GLOBAL STATE ‚îÄ‚îÄ
let currentUser = null;
let currentCreatorId = null;
let notesSaveTimer = null;
let currentCampaignFilter = 'all';

// ‚îÄ‚îÄ DATA ‚Äî loaded from localStorage with defaults ‚îÄ‚îÄ
// ‚îÄ‚îÄ normaliseCreator: fill in any missing fields from Supabase rows ‚îÄ‚îÄ
// Supabase returns null for columns that haven't been added yet.
// This prevents crashes when rendering creators with incomplete data.
function normaliseCreator(c) {
  return {
    ...c,
    name:     c.name     || 'Unknown',
    email:    c.email    || '',
    role:     c.role     || 'Influencer',
    location: c.location || '‚Äî',
    niche:    c.niche    || 'General',
    status:   c.status   || 'Active',
    notes:    c.notes    || '',
    onboarding: c.onboarding || null,
    profile_image_url: c.profile_image_url || null,
  };
}

function normaliseCreators(arr) {
  return (arr || []).map(normaliseCreator);
}

const DEFAULT_CREATORS = [
  {id:1,name:'Muskan',email:'muskan@blustu.agency',role:'Influencer',location:'üá¶üá∫ Australia',niche:'Lifestyle / Fashion',status:'Active',notes:'',onboarding:null},
  {id:2,name:'Amazing (Imran)',email:'amazing@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Fitness / Student',status:'Active',notes:'',onboarding:null},
  {id:3,name:'Daniel',email:'dreambig@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Food / Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:4,name:'Safwar',email:'safwar@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Fashion / Street',status:'Active',notes:'',onboarding:null},
  {id:5,name:'Jess',email:'jess@blustu.agency',role:'Influencer',location:'üá¶üá∫ Australia',niche:'Lifestyle',status:'Invited',notes:'',onboarding:null},
  {id:6,name:'FM2Breezy',email:'fm2breezy@blustu.agency',role:'Influencer',location:'üá®üá¶ Canada',niche:'Entertainment',status:'Invited',notes:'',onboarding:null},
  {id:7,name:'Ubayy',email:'ubayy@blustu.agency',role:'Influencer / Owner',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:8,name:'Faridah',email:'faridah@blustu.agency',role:'Influencer',location:'üá®üá¶ Canada',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:9,name:'Maham',email:'maham@blustu.agency',role:'Influencer',location:'üá®üá¶ Canada',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:10,name:'Kim',email:'kim@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Fashion',status:'Active',notes:'',onboarding:null},
  {id:11,name:'Simran',email:'simran@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:12,name:'Anita',email:'anita@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:13,name:'Faiza',email:'faiza@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Fashion',status:'Active',notes:'',onboarding:null},
  {id:14,name:'Parmita',email:'parmita@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:15,name:'HBVlogs',email:'hbvlogs@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Vlogs',status:'Active',notes:'',onboarding:null},
  {id:16,name:'Rayyan',email:'rayyan@blustu.agency',role:'Influencer / Manager',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:17,name:'Ridha',email:'ridha@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:18,name:'Faisal',email:'faisal@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Fashion / Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:19,name:'Sanin',email:'sancerelyy@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:20,name:'Maddie',email:'maddie@blustu.agency',role:'Influencer',location:'üá∫üá∏ America',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:21,name:'Humaz',email:'humaz@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:22,name:'MD',email:'md@blustu.agency',role:'Influencer',location:'üá∏üá™ Sweden',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:23,name:'Krantz',email:'krantz@blustu.agency',role:'Influencer',location:'üá¨üáß UK',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:24,name:'Samirah',email:'samirah@blustu.agency',role:'Influencer',location:'üá∫üá∏ America',niche:'Lifestyle',status:'Active',notes:'',onboarding:null},
  {id:25,name:'HoodsNews',email:'hoodsnews@blustu.agency',role:'Meme Page',location:'üåç International',niche:'Meme / Entertainment',status:'Invited',notes:'',onboarding:null},
];

let creators    = normaliseCreators(Storage.get('creators', DEFAULT_CREATORS));
let campaigns   = Storage.get('campaigns',   []);
let pitchDecks  = Storage.get('pitchDecks',  []);
let deals       = Storage.get('deals',       []);
let mediaKits   = Storage.get('mediaKits',   []);
let nextId      = Storage.get('nextId',      {camp:1, pitch:1, deal:1, kit:1});

// ‚îÄ‚îÄ SUPABASE BOOT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function syncAllFromDB() {
  showSyncBanner(true);
  try {
    const [dbC, dbCa, dbP, dbD, dbMk, dbIm, dbSt] = await Promise.all([
      DB.select('creators'), DB.select('campaigns'), DB.select('pitch_decks'),
      DB.select('deals'), DB.select('media_kits'), DB.select('inbox_messages'),
      DB.select('staff_accounts'),
    ]);

    if (dbC && dbC.length > 0) { creators = normaliseCreators(dbC); }
    else { await DB.upsertMany('creators', DEFAULT_CREATORS); creators = DEFAULT_CREATORS; }
    Storage.set('creators', creators);

    if (dbCa !== null) { campaigns  = dbCa; Storage.set('campaigns',  campaigns);  }
    if (dbP  !== null) { pitchDecks = dbP;  Storage.set('pitchDecks', pitchDecks); }
    if (dbD  !== null) { deals      = dbD;  Storage.set('deals',      deals);      }
    if (dbMk !== null) { mediaKits  = dbMk; Storage.set('mediaKits',  mediaKits);  }
    if (dbIm && dbIm.length > 0) { inboxMessages = dbIm; Storage.set('inboxMessages', inboxMessages); }

    // Staff ‚Äî seed into Supabase if empty (first-run)
    if (dbSt && dbSt.length > 0) {
      STAFF = dbSt; Storage.set('staff', STAFF);
    } else {
      const seeded = DEFAULT_STAFF.map((s, i) => ({...s, id: i+1}));
      await DB.upsertMany('staff_accounts', seeded);
      STAFF = seeded; Storage.set('staff', STAFF);
    }

    const [pp, ia, ao] = await Promise.all([
      DB.getAppData('profilePics'),
      DB.getAppData('kitAnalytics'),
      DB.getAppData('adminOverrides'),
    ]);
    if (pp) { profilePics  = pp; Storage.set('profilePics',  profilePics); }
    if (ia) { kitAnalytics = ia; Storage.set('kitAnalytics', kitAnalytics); }
    if (ao) { adminOverrides = ao; Storage.set('adminOverrides', ao); } // BUG2 FIX: store fetched value 'ao', not stale local var

  } catch(e) { console.warn('[Sync] Failed, using cache:', e); }
  showSyncBanner(false);
  renderAll();
}

// Fetch one table and re-render affected UI
async function refetch(table) {
  const rows = await DB.select(table);
  if (rows === null) return false;
  switch(table) {
    case 'creators':
      creators = normaliseCreators(rows); Storage.set('creators', creators);
      renderCRM(creators); renderOnboarding();
      if (currentCreatorId) {
        renderCreatorDeals(currentCreatorId);
        renderCreatorContracts(currentCreatorId);
      }
      break;
    case 'campaigns':
      campaigns = rows; Storage.set('campaigns', rows);
      renderCampaigns(currentCampaignFilter);
      break;
    case 'pitch_decks': pitchDecks = rows; Storage.set('pitchDecks', rows); renderPitchDecks(); break;
    case 'deals':       deals      = rows; Storage.set('deals',      rows); renderPipeline();   break;
    case 'media_kits':  mediaKits  = rows; Storage.set('mediaKits',  rows); renderMediaKitList(); break;
    case 'inbox_messages': inboxMessages = rows; Storage.set('inboxMessages', rows); renderInbox(); break;
    case 'contracts':
      if (currentCreatorId) renderCreatorContracts(currentCreatorId);
      break;
  }
  updateDashStats(); populateSelects();
  return true;
}

function showSyncBanner(show) {
  let el = document.getElementById('syncBanner');
  if (!el) {
    el = document.createElement('div');
    el.id = 'syncBanner';
    el.style.cssText = 'position:fixed;top:0;left:0;right:0;background:var(--blue);color:white;text-align:center;font-size:12px;font-weight:600;padding:6px;z-index:9000';
    el.textContent = '‚ü≥ Syncing with shared database‚Ä¶';
    document.body.appendChild(el);
  }
  el.style.display = show ? 'block' : 'none';
}

const DEFAULT_INBOX = [
  {id:1,from:'GymShark Partnerships',email:'partnerships@gymshark.com',subject:'Re: Amazing ‚Äî Fitness Collab Proposal',preview:"Thanks for reaching out! We're interested in working with Amazing. Could you send over more details about...",body:"Hi,\n\nThanks for reaching out! We've reviewed the pitch deck you sent for Amazing (Imran) and we're genuinely interested in exploring a fitness collaboration.\n\nCould you send over the following:\n1. Detailed audience demographics\n2. Previous campaign case studies\n3. Rate card for a 60-day usage deal\n\nLooking forward to hearing from you.\n\nBest,\nThe GymShark Team",time:'2h ago',unread:true,avatar:'G',color:'#1A5CFF'},
  {id:2,from:'Muskan',email:'muskan@blustu.agency',subject:'FashionNova Update ‚Äî Content Ready',preview:"Hey! Just finished filming the haul, editing now üé¨ Should be done by...",body:"Hey Ubayy!\n\nJust finished filming the FashionNova haul content. The footage looks great! I'm editing now and should have the final cut ready by Thursday.\n\nI've done:\n‚úÖ 1√ó Instagram Reel (60s)\n‚úÖ 3√ó Stories\n‚è≥ TikTok version (editing)\n\nLet me know if you need anything changed!\n\nMuskan üé¨",time:'5h ago',unread:true,avatar:'M',color:'#6366F1'},
  {id:3,from:'ASOS Press',email:'press@asos.com',subject:'Media Kit Review ‚Äî Daniel',preview:"Thank you for reaching out. We've reviewed the media kit for Daniel and...",body:"Hello,\n\nThank you for reaching out regarding a potential collaboration with Daniel.\n\nWe've reviewed the media kit and Daniel's content aligns well with our upcoming student fashion campaign. We'd like to schedule a call to discuss rates and deliverables.\n\nAvailability next week?\n\nKind regards,\nASOS Press & Partnerships",time:'Yesterday',unread:true,avatar:'A',color:'#8B93A8'},
  {id:4,from:'Daniel',email:'dreambig@blustu.agency',subject:'ASOS Pitch ‚Äî Any news?',preview:"Any update on the ASOS pitch? Really excited about this one, been putting effort into...",body:"Ubayy,\n\nAny update on the ASOS pitch? I've been working on some content ideas for them and I'm really excited about this potential deal.\n\nAlso, should I reach out to them directly or keep it all through you?\n\nThanks,\nDaniel",time:'2 days ago',unread:true,avatar:'D',color:'#14B8A6'},
  {id:5,from:'Safwar',email:'safwar@blustu.agency',subject:'Boohoo Content ‚Äî Going Live Thursday',preview:"Confirmed ‚Äî video goes up Thursday ‚úÖ Just wanted to let you know that...",body:"Hey!\n\nJust a quick update ‚Äî the Boohoo Style Reel is confirmed to go live this Thursday at 6pm UK time.\n\nI'll send you the post link as soon as it's live so you can track performance.\n\nSafwar ‚úÖ",time:'3 days ago',unread:false,avatar:'S',color:'#F97316'},
];

let inboxMessages = Storage.get('inboxMessages', DEFAULT_INBOX);
let kitAnalytics  = Storage.get('kitAnalytics',  {});
let profilePics   = Storage.get('profilePics',   {});
function saveInbox()    { Storage.set('inboxMessages', inboxMessages); }
function saveAnalyticsData() { Storage.set('kitAnalytics', kitAnalytics); }
function saveProfilePics()   { Storage.set('profilePics', profilePics); }

let currentInboxId = null;
let currentPortalCreatorId = null;
let currentPortalStep = 1;
let portalData = {};

// Admin override data ‚Äî keyed by creator id (integer)
// Shape per creator: { rates, usage, engagementRate, followers, avgViews, audience, niche, updatedBy, updatedAt }
let adminOverrides = Storage.get('adminOverrides', {});
async function saveAdminOverrides() {
  Storage.set('adminOverrides', adminOverrides);
  // BUG2 FIX: await the Supabase write. Previously fire-and-forget meant
  // data was lost if the user logged out before the request completed.
  const ok = await DB.setAppData('adminOverrides', adminOverrides);
  if (!ok) console.warn('[adminOverrides] Supabase write failed ‚Äî check RLS and app_data table');
}

// ‚îÄ‚îÄ resolveCreator: merges admin overrides on top of self-reported for a creator ‚îÄ‚îÄ
// Returns a "resolved" object with both layers visible
function resolveCreator(c) {
  const ao = adminOverrides[c.id] || {};
  const ob = c.onboarding || {};
  return {
    // Self reported (from onboarding form)
    srRates:       ob.rates  || {},
    srUsage:       ob.usage  || {},
    srEngRate:     ob.engagementRate || null,
    srFollowers:   ob.followers || null,
    srAvgViews:    ob.avgViews || null,
    srAudience:    ob.audience || null,
    // Admin overrides
    aoRates:       ao.rates  || null,
    aoUsage:       ao.usage  || null,
    aoEngRate:     ao.engagementRate || null,
    aoFollowers:   ao.followers || null,
    aoAvgViews:    ao.avgViews || null,
    aoAudience:    ao.audience || null,
    aoNiche:       ao.niche   || null,
    // Resolved = admin ?? self-reported
    rates:         ao.rates   || ob.rates  || {},
    usage:         ao.usage   || ob.usage  || {},
    engRate:       ao.engagementRate != null ? ao.engagementRate : (ob.engagementRate || null),
    followers:     ao.followers  || ob.followers  || null,
    avgViews:      ao.avgViews   || ob.avgViews   || null,
    audience:      ao.audience   || ob.audience   || null,
    niche:         ao.niche      || c.niche        || ob.niche || '‚Äî',
  };
}

// ‚îÄ‚îÄ Grid state ‚îÄ‚îÄ
let gridSelectionIds = new Set();
let gridCallbackFn = null;   // called with array of selected creator ids when confirmed

// ‚îÄ‚îÄ prefetchStaff: load staff from Supabase BEFORE login prompt ‚îÄ‚îÄ
// This is what makes cross-device auth work for ALL staff accounts.
async function prefetchStaff() {
  try {
    const rows = await DB.select('staff_accounts');
    if (rows && rows.length > 0) {
      STAFF = rows;
      Storage.set('staff', STAFF);
      console.log('[Auth] Prefetched', STAFF.length, 'staff accounts from Supabase');
    }
  } catch(e) {
    console.warn('[Auth] Staff prefetch failed, using local cache:', e);
  }
}

// ‚ïê‚ïê AUTH ‚ïê‚ïê
async function doLogin() {
  const emailEl = document.getElementById('loginEmail');
  const passEl  = document.getElementById('loginPassword');
  const errEl   = document.getElementById('authError');
  const btnEl   = document.getElementById('loginBtn');
  if (!emailEl || !passEl) return;

  const email = emailEl.value.trim().toLowerCase();
  const pass  = passEl.value;
  if (!email || !pass) {
    errEl.style.display = 'block';
    errEl.textContent = 'Please enter your email and password.';
    return;
  }

  errEl.style.display = 'none';
  if (btnEl) { btnEl.disabled = true; btnEl.textContent = 'Signing in‚Ä¶'; }

  // 1. Try Supabase directly (works on ANY device, always up to date)
  let staff = null;
  try {
    const rows = await DB._req('GET', 'staff_accounts', null,
      `?email=eq.${encodeURIComponent(email)}&pass=eq.${encodeURIComponent(pass)}&limit=1`);
    if (rows && rows.length > 0) {
      staff = rows[0];
      // Keep local STAFF array in sync
      const idx = STAFF.findIndex(s => s.email === email);
      if (idx > -1) STAFF[idx] = staff; else STAFF.push(staff);
      Storage.set('staff', STAFF);
    }
  } catch(e) {
    console.warn('[Auth] Supabase login query failed:', e);
  }

  // 2. Fallback to local STAFF array (covers offline / Supabase down)
  if (!staff) {
    staff = STAFF.find(s => s.email === email && s.pass === pass);
  }

  if (btnEl) { btnEl.disabled = false; btnEl.textContent = 'Sign In'; }

  if (!staff) {
    errEl.style.display = 'block';
    errEl.textContent = 'Invalid email or password.';
    return;
  }

  currentUser = staff;
  Storage.set('lastUser', email);

  document.getElementById('authScreen').classList.add('hidden');

  const role = staff.systemRole || 'readonly';
  document.getElementById('sidebarName').textContent = staff.name;
  document.getElementById('sidebarAvatar').textContent = staff.name[0].toUpperCase();
  document.getElementById('sidebarRole').innerHTML =
    `<span class="user-role-badge role-${role}">${ROLE_LABELS[role]||role}</span>`;

  const h = new Date().getHours();
  const greet = h<12?'Good morning':h<17?'Good afternoon':'Good evening';
  const greetEl = document.getElementById('dashGreeting');
  if (greetEl) greetEl.textContent = `${greet}, ${staff.name}. üëã`;

  const pmName = document.getElementById('profile-modal-name');
  const pmEmail = document.getElementById('profile-modal-email');
  const pmAvatar = document.getElementById('profile-modal-avatar');
  const pmDisplay = document.getElementById('profile-modal-display');
  if (pmName)    pmName.textContent    = staff.name;
  if (pmEmail)   pmEmail.textContent   = staff.email;
  if (pmAvatar)  pmAvatar.textContent  = staff.name[0];
  if (pmDisplay) pmDisplay.value       = staff.name;

  applyPermissionsUI();
  syncAllFromDB();
}

// Apply RBAC restrictions to UI elements
function applyPermissionsUI() {
  const role = currentUser ? (currentUser.systemRole || 'readonly') : 'readonly';
  const caps = ROLE_CAPS[role] || ROLE_CAPS.readonly;

  // Show/hide add creator button in topbar
  const addCreatorBtn = document.querySelector('.topbar .btn-primary');
  if (addCreatorBtn) addCreatorBtn.style.display = caps.addCreator ? '' : 'none';

  // Show/hide Users & Access nav item (owner + admin only)
  const navUsers = document.getElementById('nav-users');
  if (navUsers) navUsers.style.display = (role==='owner'||role==='admin') ? '' : 'none';

  // Add creator button on CRM page
  const crmBtn = document.querySelector('#page-crm .btn-primary');
  if (crmBtn) crmBtn.style.display = caps.addCreator ? '' : 'none';
}

function doLogout() {
  currentUser = null;
  document.getElementById('authScreen').classList.remove('hidden');
  const emailEl = document.getElementById('loginEmail');
  const passEl  = document.getElementById('loginPassword');
  if (emailEl) emailEl.value = '';
  if (passEl)  passEl.value  = '';
  // Reset role badge
  const roleEl = document.getElementById('sidebarRole');
  if (roleEl) roleEl.textContent = '';
}

function saveProfile() {
  const n = document.getElementById('profile-modal-display').value.trim();
  if (n && currentUser) {
    currentUser.name = n;
    document.getElementById('sidebarName').textContent = n;
    document.getElementById('profile-modal-name').textContent = n;
  }
  closeModal('profileModal');
  showToast('Profile updated!');
}

// ‚ïê‚ïê UTILS ‚ïê‚ïê
function avatarColor(id){return AVATAR_COLORS[(id-1)%AVATAR_COLORS.length];}
function avatarLetter(n){return n.trim()[0].toUpperCase();}

function showToast(msg) {
  const t=document.getElementById('toast');
  t.textContent=msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),3200);
}

function openModal(id) {
  const el=document.getElementById(id);
  if(!el){showToast('This feature is coming soon');return;}
  el.classList.add('open');
}
function closeModal(id) {
  const el=document.getElementById(id);
  if(el) el.classList.remove('open');
}

const pageTitles = {
  dashboard:'Dashboard', crm:'Creator CRM', creatorprofile:'Creator Profile',
  onboarding:'Creator Onboarding', mediakit:'Media Kits', ratekit:'Rate Kit',
  campaigns:'Campaigns', pitchdecks:'Pitch Decks', pipeline:'Deal Pipeline',
  inbox:'Inbox', users:'Users & Access', reports:'Campaign Reports', invoice:'Invoice Generator',
  creatorgrid:'Select Creators'
};

function showPage(id, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

  // Show target page ‚Äî special pages live in wrapper divs outside <main>
  if (id === 'reports' || id === 'invoice') {
    // Move page element into main content area if needed
    const wrapper = document.getElementById('page-'+id+'-wrapper');
    const page    = document.getElementById('page-'+id);
    if (wrapper) wrapper.style.display = 'block';
    if (page) {
      const content = document.querySelector('.content');
      if (content && page.parentElement !== content) content.appendChild(page);
      page.classList.add('active');
    }
    if (id === 'reports') populateReportSelector();
    if (id === 'invoice') initInvoice();
  } else {
    // Hide special wrappers
    ['reports','invoice'].forEach(pid => {
      const w = document.getElementById('page-'+pid+'-wrapper');
      if (w) w.style.display = 'none';
    });
    const page = document.getElementById('page-'+id);
    if (page) page.classList.add('active');
  }

  if (btn) btn.classList.add('active');
  const titleEl = document.getElementById('topbarTitle');
  if (titleEl) titleEl.textContent = pageTitles[id] || id;
  closeSidebar();

  // ‚îÄ‚îÄ Per-page re-render on navigation ‚îÄ‚îÄ
  // Guarantees each page shows current data on every visit.
  if (id === 'crm')        { renderCRM(creators); }
  if (id === 'onboarding') { renderOnboarding(); }
  if (id === 'mediakit')   {
    renderMediaKitList();
    // Re-activate the first tab (Media Kit) since switchProfileTab may have cleared it
    const firstMkTab = document.querySelector('#page-mediakit .profile-tab');
    switchMKTab('kit', firstMkTab);
  }
  if (id === 'ratekit')    { populateRateKitSelector(); }
  if (id === 'users')      { renderUsersPage(); }
  if (id === 'pipeline')   { renderPipeline(); }
  if (id === 'campaigns')  { renderCampaigns(currentCampaignFilter); }
}

function statusBadge(s){
  const map={Active:'green',Onboarded:'green',Live:'green',Completed:'green',Invited:'amber',Negotiating:'amber',Pitched:'blue',Prospect:'gray',Lost:'red',Paused:'gray',Delivered:'blue',Draft:'gray',Sent:'blue',Viewed:'amber',Interested:'green',Declined:'red',Connected:'blue'};
  return `<span class="badge badge-${map[s]||'gray'}">${s}</span>`;
}

function fmtMoney(v){if(!v&&v!==0)return'‚Äî';const n=Number(v);return n>=1000?'¬£'+Math.round(n/100)/10+'k':'¬£'+n;}

function addActivity(msg) {
  const feed=document.getElementById('activityFeed');
  if(!feed)return;
  const t=new Date();
  const timeStr=t.getHours()+':'+String(t.getMinutes()).padStart(2,'0');
  const el=document.createElement('div');
  el.className='activity-item';
  el.innerHTML=`<div class="activity-dot" style="background:var(--blue)"></div><div><div class="activity-text">${msg}</div><div class="activity-time">Just now (${timeStr})</div></div>`;
  feed.insertBefore(el,feed.firstChild);
}

// ‚îÄ‚îÄ CRM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCRM(list) {
  const tbody=document.getElementById('crmTableBody');
  const empty=document.getElementById('crm-empty');
  if(!list||!list.length){tbody.innerHTML='';empty.style.display='block';return;}
  empty.style.display='none';
  tbody.innerHTML=list.map(c=>{
    const pic=profilePics[c.id];
    const avatarHtml=pic
      ? `<div class="creator-avatar" style="background:${avatarColor(c.id)};overflow:hidden"><img src="${pic}" class="avatar-img" alt="${c.name}"></div>`
      : `<div class="creator-avatar" style="background:${avatarColor(c.id)}">${avatarLetter(c.name)}</div>`;
    return `
    <tr>
      <td><div class="creator-cell">${avatarHtml}<div><div class="creator-name">${c.name}</div><div class="creator-handle">${c.email}</div></div></div></td>
      <td style="font-size:12px;color:var(--gray-400)">${c.role}</td>
      <td style="font-size:12px">${c.location}</td>
      <td>${c.onboarding?'<span class="badge badge-green">‚úì Complete</span>':c.status==='Invited'?'<span class="badge badge-amber">Invited</span>':'<span class="badge badge-gray">Pending</span>'}</td>
      <td>${statusBadge(c.status)}</td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="openCreatorProfile(${c.id})">Profile</button>
        <button class="btn btn-ghost btn-sm" onclick="openCreatorQuickView(${c.id})">Quick</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDeleteCreator(${c.id})">Delete</button>
      </td>
    </tr>`;
  }).join('');
  document.getElementById('crm-count').textContent=list.length;
  document.getElementById('crmBadge').textContent=creators.length;
}

function filterCRM(q){
  const s=(q||'').toLowerCase();
  if(!s){renderCRM(creators);return;}
  renderCRM(creators.filter(c=>
    (c.name||'').toLowerCase().includes(s)||
    (c.email||'').toLowerCase().includes(s)||
    (c.location||'').toLowerCase().includes(s)||
    (c.niche||'').toLowerCase().includes(s)
  ));
}
function filterCRMStatus(v){
  if (!v) { renderCRM(creators); return; }
  if (v === 'Onboarded') {
    // Show creators who have submitted onboarding data (regardless of status label)
    renderCRM(creators.filter(c => c.onboarding));
    return;
  }
  if (v === 'Active') {
    // Active = has no onboarding OR has onboarding, status is Active or Onboarded
    renderCRM(creators.filter(c => c.status === 'Active' || c.status === 'Onboarded'));
    return;
  }
  renderCRM(creators.filter(c => c.status === v));
}

// ‚îÄ‚îÄ DELETE CREATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function confirmDeleteCreator(id) {
  // If called without id, use currentCreatorId (from profile page)
  const targetId = id !== undefined ? id : currentCreatorId;
  const c = creators.find(x => x.id === targetId);
  if (!c) return;
  showConfirm(
    `Delete ${c.name}?`,
    `This will permanently remove ${c.name} from the roster, along with their media kit, deals and onboarding data.`,
    () => deleteCreator(targetId)
  );
}

async function deleteCreator(id) {
  const numId = parseInt(id, 10);
  console.log('Deleting influencer id:', numId, typeof numId);
  // Delete from Supabase first
  const result = await DB.delete('creators', numId);
  console.log('Delete influencer result:', result);
  // Also clean up related records
  await Promise.all([
    DB.deleteWhere('deals',      'creatorId', numId),
    DB.deleteWhere('media_kits', 'creatorId', numId),
  ]);
  // Update local state
  creators  = creators.filter(x => x.id !== numId);
  deals     = deals.filter(x => x.creatorId !== numId);
  mediaKits = mediaKits.filter(x => x.creatorId !== numId);
  delete profilePics[numId];
  delete kitAnalytics[numId];
  Storage.set('creators',  creators);
  Storage.set('deals',     deals);
  Storage.set('mediaKits', mediaKits);
  saveProfilePics(); saveAnalyticsData();
  if (document.getElementById('page-creatorprofile').classList.contains('active')) {
    showPage('crm', document.querySelector('[onclick*=crm]'));
  }
  renderCRM(creators);
  renderPipeline();
  updateDashStats();
  addActivity('Creator deleted from roster');
  showToast('Creator removed');
}

async function addCreator(){
  const name=document.getElementById('nc-name').value.trim();
  if(!name){showToast('Please enter a name');return;}
  // Generate a unique ID that won't clash (timestamp-based)
  const newId = Date.now() % 2147483647; // fits in int4
  const c={
    id: newId,
    name,
    email: document.getElementById('nc-email').value.trim() || name.toLowerCase().replace(/\s+/g,'')+'@blustu.agency',
    role: document.getElementById('nc-role').value,
    location: document.getElementById('nc-loc').value.trim()||'‚Äî',
    niche: document.getElementById('nc-niche').value,
    status:'Active',
    notes:'',
    onboarding:null,
    profile_image_url: null
  };
  console.log('Adding influencer:', c);
  const result = await DB.upsertOne('creators', c);
  console.log('Add influencer result:', result);
  if (!result) { showToast('‚ùå Failed to save creator ‚Äî check console'); return; }
  // Refetch from Supabase to ensure consistent state
  await refetch('creators');
  closeModal('addCreatorModal');
  populateSelects();
  updateDashStats();
  addActivity(`<strong>${name}</strong> added to roster`);
  showToast(`${name} added!`);
  ['nc-name','nc-email','nc-loc'].forEach(id=>document.getElementById(id).value='');
}

function handleGlobalSearch(q){
  if(!q)return;
  showPage('crm',document.querySelector('[onclick*="crm"]'));
  document.getElementById('crmSearchInput').value=q;
  filterCRM(q);
}

// ‚îÄ‚îÄ CREATOR PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openCreatorProfile(id){
  const c=creators.find(x=>x.id===id);
  if(!c)return;
  currentCreatorId=id;
  document.getElementById('profile-name').textContent=c.name;
  document.getElementById('profile-email').textContent=c.email;
  document.getElementById('profile-status-badge').innerHTML=statusBadge(c.status);

  // Render avatar / profile pic
  const avatarEl = document.getElementById('profile-avatar-circle');
  if (avatarEl) {
    const pic = profilePics[id];
    if (pic) {
      avatarEl.style.background = 'transparent';
      avatarEl.innerHTML = `<img src="${pic}" class="avatar-img" alt="${c.name}">`;
    } else {
      avatarEl.style.background = avatarColor(id);
      avatarEl.textContent = avatarLetter(c.name);
    }
  }

  document.getElementById('profile-info-body').innerHTML=`
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;gap:8px"><span style="font-size:12px;color:var(--gray-400);width:80px;flex-shrink:0">Role</span><span style="font-size:13px;font-weight:500">${c.role}</span></div>
      <div style="display:flex;gap:8px"><span style="font-size:12px;color:var(--gray-400);width:80px;flex-shrink:0">Location</span><span style="font-size:13px;font-weight:500">${c.location}</span></div>
      <div style="display:flex;gap:8px"><span style="font-size:12px;color:var(--gray-400);width:80px;flex-shrink:0">Niche</span><span style="font-size:13px;font-weight:500">${c.niche}</span></div>
      <div style="display:flex;gap:8px"><span style="font-size:12px;color:var(--gray-400);width:80px;flex-shrink:0">Email</span><span style="font-size:13px;font-weight:500">${c.email}</span></div>
    </div>`;

  document.getElementById('profile-onboarding-body').innerHTML=`
    <div style="display:flex;flex-direction:column;gap:8px">
      <div style="display:flex;align-items:center;justify-content:space-between"><span style="font-size:13px">Added to Roster</span><span class="badge badge-green">‚úì Done</span></div>
      <div style="display:flex;align-items:center;justify-content:space-between"><span style="font-size:13px">Invite Sent</span>${c.status==='Invited'||c.onboarding?'<span class="badge badge-green">‚úì Done</span>':'<span class="badge badge-gray">Pending</span>'}</div>
      <div style="display:flex;align-items:center;justify-content:space-between"><span style="font-size:13px">Onboarding Form</span>${c.onboarding?'<span class="badge badge-green">‚úì Complete</span>':'<span class="badge badge-gray">Not submitted</span>'}</div>
      <div style="display:flex;align-items:center;justify-content:space-between"><span style="font-size:13px">Status</span>${statusBadge(c.status)}</div>
    </div>
    <button class="btn btn-ghost btn-sm" style="margin-top:12px;width:100%" onclick="showPage('onboarding',document.querySelector('[onclick*=onboarding]'))">Go to Onboarding</button>`;

  // Socials & Rates tab ‚Äî full dual-layer display
  renderProfileSocials(c);

  document.getElementById('profile-notes-input').value=c.notes||'';
  switchProfileTab('overview',document.querySelector('.profile-tab'));
  showPage('creatorprofile',null);
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
}

function triggerProfilePicUpload() {
  document.getElementById('profilePicFile').click();
}

async function handleProfilePicUpload(event) {
  const file = event.target.files[0];
  if (!file || !currentCreatorId) return;
  event.target.value = '';

  // Show uploading state
  const avatarEl = document.getElementById('profile-avatar-circle');
  if (avatarEl) { avatarEl.style.opacity = '0.5'; }
  showToast('Uploading photo‚Ä¶');

  try {
    // Upload to Supabase Storage bucket "profile-pictures"
    const ext = file.name.split('.').pop();
    const fileName = `creator_${currentCreatorId}.${ext}`;
    const uploadUrl = `${SUPABASE_URL}/storage/v1/object/profile-pictures/${fileName}`;

    const uploadRes = await fetch(uploadUrl, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': file.type,
        'x-upsert': 'true'
      },
      body: file
    });

    if (!uploadRes.ok) {
      const err = await uploadRes.text();
      console.error('Profile pic upload failed:', err);
      // Fallback: store as base64 in app_data
      const reader = new FileReader();
      reader.onload = async function(e) {
        profilePics[currentCreatorId] = e.target.result;
        await saveProfilePics();
        renderProfilePic(currentCreatorId, e.target.result);
        renderCRM(creators);
        renderMediaKitList();
        showToast('Profile picture saved!');
      };
      reader.readAsDataURL(file);
      return;
    }

    // Get public URL
    const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/profile-pictures/${fileName}`;

    // Save URL to creators table
    const c = creators.find(x => x.id === currentCreatorId);
    if (c) {
      c.profile_image_url = publicUrl;
      await DB.upsertOne('creators', c);
      Storage.set('creators', creators);
    }
    // Also store in profilePics for backwards compat
    profilePics[currentCreatorId] = publicUrl;
    await saveProfilePics();

    renderProfilePic(currentCreatorId, publicUrl);
    renderCRM(creators);
    renderMediaKitList();
    showToast('Profile picture updated!');
  } catch(e) {
    console.error('Profile pic error:', e);
    showToast('Failed to upload photo');
  } finally {
    if (avatarEl) { avatarEl.style.opacity = '1'; }
  }
}

function renderProfilePic(id, src) {
  const avatarEl = document.getElementById('profile-avatar-circle');
  if (!avatarEl) return;
  if (src) {
    avatarEl.style.background = 'transparent';
    avatarEl.innerHTML = `<img src="${src}" class="avatar-img" alt="">`;
  } else {
    const c = creators.find(x=>x.id===id);
    if (c) { avatarEl.style.background = avatarColor(id); avatarEl.textContent = avatarLetter(c.name); }
  }
}

function openCreatorQuickView(id){
  const c=creators.find(x=>x.id===id);
  if(!c)return;
  currentCreatorId=id;
  document.getElementById('cm-avatar').textContent=avatarLetter(c.name);
  document.getElementById('cm-avatar').style.background=avatarColor(c.id);
  document.getElementById('cm-name').textContent=c.name;
  document.getElementById('cm-sub').textContent=c.email+' ¬∑ '+c.location;
  document.getElementById('cm-onboard-info').innerHTML=c.onboarding
    ?`<div style="background:var(--green-light);border-radius:8px;padding:10px;font-size:12px;color:var(--green)">‚úì Onboarding complete. Bio, rates & socials on file.</div>`
    :`<div style="background:var(--amber-light);border-radius:8px;padding:10px;font-size:12px;color:var(--amber)">Onboarding not yet completed. Send them the link to collect their details.</div>`;
  document.getElementById('cm-profile-btn').onclick=()=>{closeModal('creatorModal');openCreatorProfile(id);};
  document.getElementById('cm-invite-btn').onclick=()=>{closeModal('creatorModal');openInviteFor(id);};
  openModal('creatorModal');
}

function switchProfileTab(id, btn) {
  // SCOPED: only clear ptab-* tabs, NOT mktab-* or rtab-* or other tab groups
  document.querySelectorAll('[id^="ptab-"]').forEach(t => t.classList.remove('active'));
  // Only deactivate profile-tab buttons that are INSIDE the creator profile page
  const profilePage = document.getElementById('page-creatorprofile');
  if (profilePage) profilePage.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('ptab-'+id);
  if (el) el.classList.add('active');
  if (btn) btn.classList.add('active');
  if (id === 'deals' && currentCreatorId) renderCreatorDeals(currentCreatorId);
  if (id === 'contracts' && currentCreatorId) renderCreatorContracts(currentCreatorId);
}

function renderCreatorDeals(creatorId) {
  const bodyEl = document.getElementById('profile-deals-body');
  if (!bodyEl) return;
  const c = creators.find(x => x.id === creatorId);
  // Match by numeric creatorId OR by creator name (for legacy records)
  const myDeals = deals.filter(d =>
    Number(d.creatorId) === Number(creatorId) ||
    (c && d.creator && d.creator.toLowerCase() === c.name.toLowerCase())
  );
  if (!myDeals.length) {
    bodyEl.innerHTML = '<div style="font-size:13px;color:var(--gray-400);padding:8px 0">No deals found for this creator yet.</div>';
    return;
  }
  bodyEl.innerHTML = `
    <div style="display:flex;flex-direction:column;gap:8px">
      ${myDeals.map(d => `
        <div style="padding:12px;border:1px solid var(--gray-100);border-radius:10px;cursor:pointer;transition:border-color .15s" onmouseover="this.style.borderColor='var(--blue)'" onmouseout="this.style.borderColor='var(--gray-100)'" onclick="showPage('pipeline',document.querySelector('[onclick*=pipeline]'));setTimeout(()=>openEditDeal(${d.id}),150)">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
            <div style="font-size:13px;font-weight:600">${d.brand}</div>
            ${statusBadge(d.stage)}
          </div>
          <div style="font-size:12px;color:var(--gray-400)">${fmtMoney(d.value)}${d.notes ? ' ¬∑ '+d.notes.substring(0,50) : ''}</div>
        </div>`).join('')}
    </div>`;
}

function saveProfileNote(val){
  clearTimeout(notesSaveTimer);
  document.getElementById('notes-save-indicator').textContent='Saving‚Ä¶';
  notesSaveTimer=setTimeout(async ()=>{
    const c=creators.find(x=>x.id===currentCreatorId);
    if(c){
      c.notes=val;
      await DB.upsertOne('creators', c);
      Storage.set('creators', creators);
    }
    document.getElementById('notes-save-indicator').textContent='Saved ‚úì';
    setTimeout(()=>document.getElementById('notes-save-indicator').textContent='',2000);
  },800);
}

// ‚ïê‚ïê ONBOARDING PAGE ‚ïê‚ïê
function renderOnboarding(){
  const invited   = creators.filter(c => c.status === 'Invited');
  const onboarded = creators.filter(c => c.onboarding);
  const active    = creators.filter(c => c.status === 'Active' || c.status === 'Onboarded');

  // Update stat pills
  const statInv = document.getElementById('stat-invited');
  const statOb  = document.getElementById('stat-onboarded');
  const statAct = document.getElementById('stat-active-ob');
  if (statInv) statInv.textContent = invited.length;
  if (statOb)  statOb.textContent  = onboarded.length;
  if (statAct) statAct.textContent = active.length;

  // ‚îÄ‚îÄ Pending invites ‚îÄ‚îÄ
  const pendList = document.getElementById('onboarding-pending-list');
  if (pendList) {
    pendList.innerHTML = invited.length ? invited.map(c => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--gray-100);border-radius:10px;margin-bottom:8px">
        <div class="creator-avatar" style="background:${avatarColor(c.id)};width:32px;height:32px;font-size:11px">${avatarLetter(c.name)}</div>
        <div style="flex:1"><div style="font-size:13px;font-weight:600">${c.name}</div><div style="font-size:11px;color:var(--gray-400)">${c.email}</div></div>
        <span class="badge badge-amber">Invited</span>
        <button class="btn btn-ghost btn-sm" onclick="copyInviteLinkFor(${c.id})">Copy Link</button>
      </div>`).join('') : '<div style="font-size:13px;color:var(--gray-400);padding:8px 0">No pending invites.</div>';
  }

  // ‚îÄ‚îÄ Completed onboarding ‚îÄ‚îÄ
  const doneList = document.getElementById('onboarding-done-list');
  if (doneList) {
    doneList.innerHTML = onboarded.length ? onboarded.map(c => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px;border:1px solid var(--green-light);border-radius:10px;margin-bottom:8px;background:var(--green-light)">
        <div class="creator-avatar" style="background:${avatarColor(c.id)};width:32px;height:32px;font-size:11px">${avatarLetter(c.name)}</div>
        <div style="flex:1"><div style="font-size:13px;font-weight:600">${c.name}</div><div style="font-size:11px;color:var(--green)">Onboarding complete</div></div>
        <span class="badge badge-green">‚úì Done</span>
        <button class="btn btn-ghost btn-sm" onclick="openCreatorProfile(${c.id})">View</button>
      </div>`).join('') : '<div style="font-size:13px;color:var(--gray-400);padding:8px 0">No creators have completed onboarding yet.</div>';
  }

  // Update total count pill
  const statTotal = document.getElementById('stat-total-ob');
  if (statTotal) statTotal.textContent = creators.length;

  // Full tracker delegates to shared renderer (also used by search filter)
  _renderOnboardingTrackerRows(creators);
}

function filterOnboardingTracker(q) {
  const s = (q||'').toLowerCase();
  const filtered = s
    ? creators.filter(c =>
        (c.name||'').toLowerCase().includes(s) ||
        (c.email||'').toLowerCase().includes(s) ||
        (c.niche||'').toLowerCase().includes(s)
      )
    : creators;
  _renderOnboardingTrackerRows(filtered);
}

function _renderOnboardingTrackerRows(list) {
  const tracker = document.getElementById('onboarding-tracker-body');
  if (!tracker) return;
  if (!list || !list.length) {
    tracker.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:20px;color:var(--gray-400)">No creators found.</td></tr>';
    return;
  }
  tracker.innerHTML = list.map(c => {
    let statusLabel, statusClass, statusIcon;
    if (c.onboarding) {
      statusLabel = 'Submitted'; statusClass = 'badge-green'; statusIcon = '‚úì';
    } else if (c.status === 'Invited') {
      statusLabel = 'Invited'; statusClass = 'badge-amber'; statusIcon = '‚úâÔ∏è';
    } else {
      statusLabel = 'Not started'; statusClass = 'badge-gray'; statusIcon = '‚Äî';
    }
    const ob = c.onboarding || {};
    const hasRates   = ob.rates   && Object.values(ob.rates).some(v=>v);
    const hasSocials = ob.tiktok  || ob.instagram || ob.youtube;
    const hasBio     = !!ob.bio;
    const pic = profilePics[c.id];
    const avatarHtml = pic
      ? `<div class="creator-avatar" style="overflow:hidden;width:28px;height:28px;font-size:10px"><img src="${pic}" class="avatar-img"></div>`
      : `<div class="creator-avatar" style="background:${avatarColor(c.id)};width:28px;height:28px;font-size:10px">${avatarLetter(c.name)}</div>`;
    return `<tr>
      <td><div class="creator-cell">${avatarHtml}<div><div class="creator-name">${c.name}</div><div class="creator-handle">${c.email}</div></div></div></td>
      <td style="font-size:12px;color:var(--gray-400)">${c.niche||'‚Äî'}</td>
      <td><span class="badge ${statusClass}">${statusIcon} ${statusLabel}</span></td>
      <td style="font-size:12px">
        ${c.onboarding?`<div style="display:flex;gap:4px;flex-wrap:wrap">
          ${hasSocials?'<span class="badge badge-blue" style="font-size:10px">Socials</span>':''}
          ${hasRates?'<span class="badge badge-green" style="font-size:10px">Rates</span>':''}
          ${hasBio?'<span class="badge badge-gray" style="font-size:10px">Bio</span>':''}
        </div>`:'<span style="color:var(--gray-300)">‚Äî</span>'}
      </td>
      <td style="font-size:11px">
        ${c.status==='Invited'?`<button class="btn btn-ghost btn-sm" onclick="copyInviteLinkFor(${c.id})">Resend</button>`
        :c.onboarding?''
        :`<button class="btn btn-ghost btn-sm" onclick="openInviteFor(${c.id})">Invite</button>`}
      </td>
      <td><button class="btn btn-ghost btn-sm" onclick="openCreatorProfile(${c.id})">View</button></td>
    </tr>`;
  }).join('');
}

function openInviteFor(id){
  document.getElementById('invite-creator-select').value=creators.find(x=>x.id===id)?.name||'';
  updateInviteLink();
  openModal('inviteCreatorModal');
}

function updateInviteLink(){
  const name=document.getElementById('invite-creator-select').value;
  const c=creators.find(x=>x.name===name);
  const token=c?btoa(c.id+':'+c.name):btoa('0:unknown');
  document.getElementById('invite-link-preview').value=`${location.href.split('?')[0]}?onboard=${token}`;
}

function copyInviteLinkFor(id){
  const c=creators.find(x=>x.id===id);
  if(!c)return;
  const token=btoa(c.id+':'+c.name);
  const link=`${location.href.split('?')[0]}?onboard=${token}`;
  navigator.clipboard.writeText(link).then(()=>showToast('Invite link copied!')).catch(()=>showToast('Link: '+link));
}

function copyInviteLink(){
  const val=document.getElementById('invite-link-preview').value;
  navigator.clipboard.writeText(val).then(()=>showToast('Invite link copied!')).catch(()=>showToast('Link copied!'));
}

async function sendInvite(){
  const name=document.getElementById('invite-creator-select').value;
  const c=creators.find(x=>x.name===name);
  if(c && c.status!=='Onboarded' && c.status!=='Invited'){
    // Update local state immediately so the UI reflects change right away
    c.status='Invited';
    Storage.set('creators', creators);
    // Persist to Supabase (non-blocking)
    DB.upsertOne('creators', c).then(() => {
      // Refetch silently to confirm, but don't block UI
      refetch('creators');
    });
  }
  closeModal('inviteCreatorModal');
  // Re-render immediately so Pending Invites list updates now
  renderOnboarding();
  renderCRM(creators);
  addActivity(`Onboarding invite sent to <strong>${name}</strong>`);
  showToast(`Invite link ready for ${name}!`);
}

// ‚ïê‚ïê ONBOARDING PORTAL ‚ïê‚ïê
function checkPortalParam(){
  const params = new URLSearchParams(location.search);
  const ob = params.get('onboard');
  if (!ob) return;
  try {
    const decoded = atob(ob);
    const parts = decoded.split(':');
    const id = parseInt(parts[0], 10);
    const name = parts.slice(1).join(':'); // handle names with colons
    if (isNaN(id)) { console.error('Invalid onboarding token - bad id:', decoded); return; }
    currentPortalCreatorId = id;
    console.log('Portal: creator id =', id, 'name =', name);
    document.getElementById('portalCreatorName').textContent = `Hi ${name}! Please complete your onboarding below.`;
    // Pre-fill existing niche if available
    const c = creators.find(x => x.id === id);
    if (c && c.niche) document.getElementById('ob-niche').value = c.niche;
    // Close any open modals that could sit above the portal
    document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
    showPortalStep(1);
    document.getElementById('onboardPortal').classList.add('show');
    document.getElementById('authScreen').classList.add('hidden');
    // Sidebar (z-index:100) and topbar (z-index:50) are below portal (z-index:9998)
    // No pointer-events manipulation needed ‚Äî z-index handles it correctly.
  } catch(e) {
    console.error('Portal decode error:', e);
  }
}

function showPortalStep(n){
  currentPortalStep=n;
  document.querySelectorAll('.portal-step').forEach((s,i)=>s.classList.toggle('active',i===n-1));
  for(let i=1;i<=4;i++){
    const dot=document.getElementById('pdot-'+i);
    if(dot)dot.classList.toggle('done',i<=n);
  }
  if(n===4)buildReview();
}

function portalNext(n){
  if(n>currentPortalStep)collectPortalData();
  showPortalStep(n);
}

function collectPortalData(){
  portalData.tiktok    = document.getElementById('ob-tiktok').value.trim();
  portalData.instagram = document.getElementById('ob-instagram').value.trim();
  portalData.youtube   = document.getElementById('ob-youtube').value.trim();
  portalData.other     = document.getElementById('ob-other').value.trim();
  portalData.rates = {
    'TikTok Video':   document.getElementById('ob-rate-tiktok').value,
    'Instagram Reel': document.getElementById('ob-rate-reel').value,
    'Instagram Story':document.getElementById('ob-rate-story').value,
    'YouTube':        document.getElementById('ob-rate-youtube').value,
    'Long-form':      document.getElementById('ob-rate-long').value,
  };
  portalData.usage = {
    '30 days':  document.getElementById('ob-usage-30').value,
    '60 days':  document.getElementById('ob-usage-60').value,
    '90 days':  document.getElementById('ob-usage-90').value,
    'Perpetual':document.getElementById('ob-usage-perp').value,
  };
  portalData.extraFees   = document.getElementById('ob-extra-fees').value.trim();
  portalData.bio         = document.getElementById('ob-bio').value.trim();
  portalData.niche       = document.getElementById('ob-niche').value.trim();
  portalData.restrictions= document.getElementById('ob-restrictions').value.trim();
  portalData.preferences = document.getElementById('ob-preferences').value.trim();
  // Optional stats fields (from Your Stats section in step 1)
  const flrEl = document.getElementById('ob-followers');
  const engEl = document.getElementById('ob-engrate');
  const avgEl = document.getElementById('ob-avgviews');
  const audEl = document.getElementById('ob-audience');
  if (flrEl) portalData.followers      = flrEl.value.trim();
  if (engEl) portalData.engagementRate = engEl.value ? parseFloat(engEl.value) : null;
  if (avgEl) portalData.avgViews       = avgEl.value.trim();
  if (audEl) portalData.audience       = audEl.value.trim();
}

function buildReview(){
  collectPortalData();
  const r=document.getElementById('ob-review');
  const entries=[
    ['TikTok',portalData.tiktok||'‚Äî'],
    ['Instagram',portalData.instagram||'‚Äî'],
    ['YouTube',portalData.youtube||'‚Äî'],
    ['TikTok Rate',portalData.rates['TikTok Video']?'¬£'+portalData.rates['TikTok Video']:'Not set'],
    ['IG Reel Rate',portalData.rates['Instagram Reel']?'¬£'+portalData.rates['Instagram Reel']:'Not set'],
    ['Bio',portalData.bio||'‚Äî'],
    ['Niche',portalData.niche||'‚Äî'],
    ['Restrictions',portalData.restrictions||'None'],
  ];
  r.innerHTML=entries.map(([k,v])=>`<div style="display:flex;gap:8px;padding:4px 0;border-bottom:1px solid var(--gray-100)"><span style="color:var(--gray-400);width:120px;flex-shrink:0">${k}</span><span style="font-weight:500">${v}</span></div>`).join('');
}

async function submitOnboarding(){
  collectPortalData();

  // Show saving state on button
  const submitBtn = document.querySelector('#onboardPortal .btn-primary[onclick*="submitOnboarding"]');
  if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Saving‚Ä¶'; }

  // The portal loads BEFORE login, so creators[] may be empty.
  // Fetch creator directly from Supabase by ID.
  let creator = creators.find(x => x.id === currentPortalCreatorId);
  if (!creator) {
    console.log('[Onboarding] Fetching creator id:', currentPortalCreatorId);
    const rows = await DB._req('GET', 'creators', null, `?id=eq.${currentPortalCreatorId}&limit=1`);
    console.log('[Onboarding] Fetched creator:', rows);
    if (!rows || !rows.length) {
      if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit Onboarding ‚úì'; }
      alert('Error: Creator profile not found in the system. Please ask your agency to re-send the onboarding link.');
      return;
    }
    creator = rows[0];
    creators.push(creator);
  }

  creator.onboarding = portalData;
  creator.status = 'Onboarded';  // Mark as Onboarded (was 'Active' ‚Äî now correctly distinguished)
  if (portalData.niche) creator.niche = portalData.niche;

  console.log('[Onboarding] Saving creator:', creator.id, creator.name);

  // Try upsert first, then PATCH as fallback
  let result = await DB.upsertOne('creators', creator);

  // If upsert failed (e.g. column missing), try PATCH which only updates existing row
  if (!result) {
    console.log('[Onboarding] Upsert failed, trying PATCH...');
    const patchUrl = `${SUPABASE_URL}/rest/v1/creators?id=eq.${creator.id}`;
    try {
      const pr = await fetch(patchUrl, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation',
        },
        body: JSON.stringify({
          onboarding: portalData,
          status: 'Onboarded',
          niche: creator.niche
        })
      });
      const ptext = await pr.text();
      console.log('[Onboarding] PATCH result:', pr.status, ptext.slice(0, 300));
      if (pr.ok) {
        result = ptext ? JSON.parse(ptext) : [creator];
      } else {
        console.error('[Onboarding] PATCH also failed:', ptext);
      }
    } catch(pe) {
      console.error('[Onboarding] PATCH error:', pe);
    }
  }

  if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = 'Submit Onboarding ‚úì'; }

  if (!result || !result.length) {
    alert('‚ùå Failed to save onboarding data.\n\nError details logged to browser console.\n\nMost likely fix: run the SQL migration in Supabase to add the onboarding column.');
    return;
  }

  Storage.set('creators', creators);
  // Update any open CRM / onboarding views immediately
  if (typeof renderCRM === 'function')       renderCRM(creators);
  if (typeof renderOnboarding === 'function') renderOnboarding();
  showPortalStep(5);
}

function closePortal(){
  document.getElementById('onboardPortal').classList.remove('show');
  // Restore sidebar/topbar pointer-events in case they were ever disabled
  const sidebar = document.querySelector('.sidebar');
  const topbar  = document.querySelector('.topbar');
  if (sidebar) sidebar.style.pointerEvents = '';
  if (topbar)  topbar.style.pointerEvents  = '';
  if(currentUser){
    renderAll();
  } else {
    document.getElementById('authScreen').classList.remove('hidden');
  }
}

// ‚ïê‚ïê CAMPAIGNS ‚ïê‚ïê
function renderCampaigns(filter){
  const filtered=filter&&filter!=='all'?campaigns.filter(c=>c.status===filter):campaigns;
  const list=document.getElementById('campaignList');
  const sub=document.getElementById('campaigns-sub-title');
  sub.textContent=`${campaigns.length} campaigns total`;
  document.getElementById('campaignsBadge').textContent=campaigns.filter(c=>c.status==='Live').length||campaigns.length;

  // BUG1 FIX: update dashboard widget BEFORE any early return so
  // deleted/filtered campaigns are always cleared from the dashboard.
  const dashC=document.getElementById('dashCampaigns');
  if(dashC){
    const live=campaigns.filter(c=>c.status==='Live'||c.status==='Negotiating');
    dashC.innerHTML=live.length?live.map(c=>`
      <div style="display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--gray-100)">
        <div><div style="font-size:13px;font-weight:600">${c.brand} √ó ${c.creator}</div><div style="font-size:11px;color:var(--gray-400)">${c.deliverables||'‚Äî'} ¬∑ ${c.deadline||'TBD'}</div></div>
        <div style="display:flex;align-items:center;gap:8px">${statusBadge(c.status)}<span style="font-size:13px;font-weight:600;color:var(--blue)">${fmtMoney(c.value)}</span></div>
      </div>`).join(''):
      `<div class="empty-state" style="padding:24px"><h3>No active campaigns</h3><p>Create a campaign to start tracking</p></div>`;
  }

  if(!filtered.length){
    list.innerHTML=`<div class="empty-state"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg><h3>${campaigns.length?'No campaigns in this category':'No campaigns yet'}</h3><p>${campaigns.length?'Try a different filter':'Create your first campaign to start tracking brand deals'}</p>${!campaigns.length?'<button class="btn btn-primary" style="margin-top:16px" onclick="openModal(\'addCampaignModal\')">+ New Campaign</button>':''}</div>`;
    return;
  }

  list.innerHTML=filtered.map(c=>`
    <div class="campaign-card" onclick="openEditCampaign(${c.id})">
      <div class="campaign-top">
        <div class="campaign-name">${c.brand} √ó ${c.creator}</div>
        ${statusBadge(c.status)}
      </div>
      <div style="font-size:12px;color:var(--gray-400);margin-bottom:10px">${c.deliverables||'No deliverables specified'}</div>
      <div class="campaign-meta">
        <div class="campaign-meta-item">üí∞ <strong>${fmtMoney(c.value)}</strong></div>
        <div class="campaign-meta-item">üìÖ <strong>${c.deadline||'TBD'}</strong></div>
        <div class="campaign-meta-item">üìà <strong>${c.progress||0}%</strong></div>
      </div>
      <div class="progress-bar" style="margin-top:8px"><div class="progress-fill ${c.status==='Live'?'green':c.status==='Negotiating'?'amber':''}" style="width:${c.progress||0}%"></div></div>
      ${c.notes?`<div style="font-size:11px;color:var(--gray-400);margin-top:6px">${c.notes}</div>`:''}
    </div>`).join('');

}

// ‚îÄ‚îÄ Multi-creator grid integration for campaign modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openGridForCampaignModal() {
  // Store any currently selected creator before closing modal
  const currentCreator = document.getElementById('camp-creator').value;
  closeModal('addCampaignModal');
  openCreatorGrid(function(sel) {
    if (sel.length === 0) { openModal('addCampaignModal'); return; }
    const names = sel.map(c => c.name);
    const ids   = sel.map(c => c.id);
    // Always set the dropdown to first selected (for legacy compat)
    document.getElementById('camp-creator').value = names[0];
    // Store all IDs for multi-creator save
    document.getElementById('camp-creator-ids').value = JSON.stringify(ids);
    // Show chips if multiple selected
    const chipsEl = document.getElementById('camp-creators-chips');
    if (sel.length > 1 && chipsEl) {
      chipsEl.style.display = 'flex';
      chipsEl.innerHTML = sel.map(c =>
        `<span style="background:var(--blue-light);color:var(--blue);border:1px solid rgba(33,152,237,.2);border-radius:20px;padding:3px 10px;font-size:12px;font-weight:600">${c.name}</span>`
      ).join('');
    } else if (chipsEl) {
      chipsEl.style.display = 'none';
      chipsEl.innerHTML = '';
    }
    openModal('addCampaignModal');
  });
}

async function saveCampaign(){
  const brand   = document.getElementById('camp-brand').value.trim();
  const creator = document.getElementById('camp-creator').value;
  if (!brand)    { showToast('Please enter a brand name'); return; }
  if (!creator)  { showToast('Please select a creator');  return; }

  const campId = Date.now() % 2147483647;
  const dealId = (campId + 1) % 2147483647;

  // Multi-creator support: read stored IDs from hidden field
  let creatorIds = [];
  let creatorNames = creator;
  try {
    const storedIds = document.getElementById('camp-creator-ids').value;
    if (storedIds) {
      creatorIds = JSON.parse(storedIds);
      // Build comma-separated names from IDs
      const resolvedNames = creatorIds.map(id => {
        const c = creators.find(x => x.id === id);
        return c ? c.name : null;
      }).filter(Boolean);
      if (resolvedNames.length > 0) creatorNames = resolvedNames.join(', ');
    }
  } catch(e) { /* fallback to single creator */ }

  // Fallback: if no grid IDs, use the dropdown selection
  if (!creatorIds.length) {
    const cr = creators.find(x => x.name === creator);
    creatorIds = cr ? [cr.id] : [];
    creatorNames = creator;
  }

  const primaryCreatorId = creatorIds[0] || null;

  const c = {
    id: campId, brand,
    creator: creatorNames,            // comma-separated for multi, single for one
    creatorId: primaryCreatorId,      // primary creator (for legacy pipeline)
    creatorIds: creatorIds,           // all selected creator IDs (additive field)
    value:       document.getElementById('camp-value').value || 0,
    deadline:    document.getElementById('camp-deadline').value,
    status:      document.getElementById('camp-status').value,
    deliverables:document.getElementById('camp-deliverables').value.trim(),
    progress:    parseInt(document.getElementById('camp-progress').value) || 0,
    notes:       document.getElementById('camp-notes').value.trim(),
    campaignId:  null
  };

  const stageMap = {Live:'Live', Negotiating:'Negotiating', Completed:'Completed', Paused:'Negotiating'};
  const d = {
    id: dealId, brand: c.brand, creator: creatorNames,
    creatorId: primaryCreatorId, value: c.value,
    stage: stageMap[c.status] || 'Prospect',
    notes: `Linked from campaign: ${c.brand}`,
    campaignId: campId
  };

  closeModal('addCampaignModal');
  // Reset form fields
  ['camp-brand','camp-value','camp-deadline','camp-deliverables','camp-notes'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  document.getElementById('camp-progress').value = '0';
  document.getElementById('camp-creator-ids').value = '';
  const chipsEl = document.getElementById('camp-creators-chips');
  if (chipsEl) { chipsEl.style.display = 'none'; chipsEl.innerHTML = ''; }

  const [r1, r2] = await Promise.all([DB.upsertOne('campaigns', c), DB.upsertOne('deals', d)]);
  if (!r1) { showToast('‚ùå Campaign save failed'); return; }
  await Promise.all([refetch('campaigns'), refetch('deals')]);
  updateDashStats();
  addActivity(`Campaign created: <strong>${brand} √ó ${creatorNames}</strong>`);
  showToast('Campaign created!');
}

function deleteCampaign(){
  const id = parseInt(document.getElementById('edit-camp-id').value);
  const c = campaigns.find(x => x.id === id);
  if (!c) return;
  // Close the edit modal FIRST so confirm appears on a clean layer
  closeModal('editCampaignModal');
  showConfirm('Delete Campaign?', `Delete "${c.brand} √ó ${c.creator}"? Linked pipeline deals will also be removed.`, async () => {
    console.log('[DB] DELETE campaigns id=', id);
    const r = await DB.delete('campaigns', id);
    console.log('[DB] DELETE campaigns result:', r);
    if (r === null) { showToast('‚ùå Delete failed ‚Äî check console'); return; }
    // Delete any linked deals
    const linked = deals.filter(d => d.campaignId === id);
    for (const d of linked) await DB.delete('deals', d.id);
    await Promise.all([refetch('campaigns'), refetch('deals')]);
    updateDashStats();
    showToast('Campaign deleted');
  });
}

function openEditCampaign(id){
  const c=campaigns.find(x=>x.id===id);
  if(!c)return;
  document.getElementById('edit-camp-id').value=id;
  document.getElementById('edit-camp-brand').value=c.brand;
  document.getElementById('edit-camp-creator').value=c.creator;
  document.getElementById('edit-camp-value').value=c.value;
  document.getElementById('edit-camp-deadline').value=c.deadline;
  document.getElementById('edit-camp-status').value=c.status;
  document.getElementById('edit-camp-deliverables').value=c.deliverables||'';
  document.getElementById('edit-camp-progress').value=c.progress||0;
  document.getElementById('edit-camp-notes').value=c.notes||'';
  openModal('editCampaignModal');
}

async function updateCampaign(){
  const id=parseInt(document.getElementById('edit-camp-id').value);
  const c=campaigns.find(x=>x.id===id);
  if(!c)return;
  c.brand=document.getElementById('edit-camp-brand').value.trim();
  c.creator=document.getElementById('edit-camp-creator').value;
  c.value=document.getElementById('edit-camp-value').value;
  c.deadline=document.getElementById('edit-camp-deadline').value;
  c.status=document.getElementById('edit-camp-status').value;
  c.deliverables=document.getElementById('edit-camp-deliverables').value.trim();
  c.progress=parseInt(document.getElementById('edit-camp-progress').value)||0;
  c.notes=document.getElementById('edit-camp-notes').value.trim();
  closeModal('editCampaignModal');
  // Sync linked pipeline deal
  const stageMap = {Live:'Live',Negotiating:'Negotiating',Completed:'Completed',Paused:'Negotiating',Cancelled:'Lost'};
  const linkedDeal = deals.find(d => d.campaignId === id);
  const ops = [DB.upsertOne('campaigns', c)];
  if (linkedDeal) {
    linkedDeal.brand = c.brand; linkedDeal.creator = c.creator;
    linkedDeal.value = c.value; linkedDeal.stage = stageMap[c.status] || linkedDeal.stage;
    ops.push(DB.upsertOne('deals', linkedDeal));
  }
  await Promise.all(ops);
  await Promise.all([refetch('campaigns'), refetch('deals')]);
  updateDashStats();
  addActivity(`Campaign updated: <strong>${c.brand} √ó ${c.creator}</strong> ‚Üí ${c.status}`);
  showToast('Campaign updated!');
}

function filterCampaigns(filter,btn){
  currentCampaignFilter=filter;
  document.querySelectorAll('#campaignTabs .tab').forEach(t=>t.classList.remove('active'));
  if(btn)btn.classList.add('active');
  renderCampaigns(filter);
}

// ‚ïê‚ïê PITCH DECKS ‚ïê‚ïê
function renderPitchDecks(){
  const grid=document.getElementById('pitchGrid');
  document.getElementById('pitchBadge').textContent=pitchDecks.length||0;
  document.getElementById('pitch-sub').textContent=`${pitchDecks.length} pitch deck${pitchDecks.length!==1?'s':''} total`;

  const cards=pitchDecks.map(p=>`
    <div class="card" style="padding:0;overflow:hidden">
      <div class="deck-slide" style="border-radius:var(--radius) var(--radius) 0 0">
        <div><div class="deck-slide-label">Brand Pitch</div><div class="deck-slide-title">${p.creator} √ó ${p.brand}<br><span style="font-size:14px;opacity:.7">${p.concept||''}</span></div></div>
        <div class="deck-slide-footer"><div class="deck-logo">blustu‚Ñ¢</div>${statusBadge(p.status)}</div>
      </div>
      <div style="padding:14px">
        <div style="font-size:12px;color:var(--gray-400);margin-bottom:10px">${p.email?'Contact: '+p.email:'No contact yet'} ${p.rate?'¬∑ ¬£'+p.rate:''}</div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-ghost btn-sm" style="flex:1" onclick="openEditPitch(${p.id})">Edit</button>
          <button class="btn btn-primary btn-sm" style="flex:1" onclick="sendPitch(${p.id})">${p.status==='Draft'?'Send':'Re-send'}</button>
        </div>
      </div>
    </div>`).join('');

  grid.innerHTML=cards+`
    <div class="card" style="display:flex;flex-direction:column;align-items:center;justify-content:center;border:2px dashed var(--gray-200);background:transparent;cursor:pointer;min-height:200px;gap:10px" onclick="openModal('addPitchModal')">
      <div style="width:40px;height:40px;border-radius:50%;background:var(--blue-light);display:flex;align-items:center;justify-content:center">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--blue)" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      </div>
      <div style="font-size:13px;font-weight:600;color:var(--gray-600)">Create New Pitch</div>
      <div style="font-size:11px;color:var(--gray-400)">Build a deck in minutes</div>
    </div>`;
}

async function savePitch(status){
  const brand=document.getElementById('pitch-brand').value.trim();
  const creator=document.getElementById('pitch-creator').value;
  if(!brand){showToast('Enter a brand name');return;}
  const overrideStatus=document.getElementById('pitch-status').value;
  const p={
    id: Date.now() % 2147483647, brand, creator,
    concept:document.getElementById('pitch-concept').value.trim(),
    rate:document.getElementById('pitch-rate').value,
    email:document.getElementById('pitch-email').value.trim(),
    message:document.getElementById('pitch-message').value.trim(),
    status:status==='Sent'?'Sent':overrideStatus
  };
  closeModal('addPitchModal');
  ['pitch-brand','pitch-concept','pitch-rate','pitch-email','pitch-message'].forEach(id=>document.getElementById(id).value='');
  const result = await DB.upsertOne('pitch_decks', p);
  if (!result) { showToast('‚ùå Pitch save failed'); return; }
  await refetch('pitch_decks');
  addActivity(`Pitch deck created: <strong>${creator} √ó ${brand}</strong>`);
  showToast(`Pitch deck ${p.status==='Sent'?'sent':'saved as draft'}!`);
}

async function updatePitch(){
  const id=parseInt(document.getElementById('edit-pitch-id').value);
  const p=pitchDecks.find(x=>x.id===id);
  if(!p)return;
  p.brand=document.getElementById('edit-pitch-brand').value.trim();
  p.creator=document.getElementById('edit-pitch-creator').value;
  p.concept=document.getElementById('edit-pitch-concept').value.trim();
  p.rate=document.getElementById('edit-pitch-rate').value;
  p.email=document.getElementById('edit-pitch-email').value.trim();
  p.message=document.getElementById('edit-pitch-message').value.trim();
  p.status=document.getElementById('edit-pitch-status').value;
  closeModal('editPitchModal');
  await DB.upsertOne('pitch_decks', p);
  await refetch('pitch_decks');
  addActivity(`Pitch updated: <strong>${p.brand} √ó ${p.creator}</strong>`);
  showToast('Pitch deck updated!');
}

function openEditPitch(id){
  const p=pitchDecks.find(x=>x.id===id);
  if(!p)return;
  document.getElementById('edit-pitch-id').value=id;
  document.getElementById('edit-pitch-brand').value=p.brand;
  document.getElementById('edit-pitch-creator').value=p.creator;
  document.getElementById('edit-pitch-concept').value=p.concept||'';
  document.getElementById('edit-pitch-rate').value=p.rate||'';
  document.getElementById('edit-pitch-email').value=p.email||'';
  document.getElementById('edit-pitch-message').value=p.message||'';
  document.getElementById('edit-pitch-status').value=p.status;
  openModal('editPitchModal');
}

function deletePitch(){
  const id = parseInt(document.getElementById('edit-pitch-id').value);
  const p = pitchDecks.find(x => x.id === id);
  if (!p) return;
  closeModal('editPitchModal');
  showConfirm('Delete Pitch Deck?', `Delete pitch for "${p.brand} √ó ${p.creator}"?`, async () => {
    console.log('[DB] DELETE pitch_decks id=', id);
    const r = await DB.delete('pitch_decks', id);
    console.log('[DB] DELETE pitch_decks result:', r);
    if (r === null) { showToast('‚ùå Delete failed'); return; }
    await refetch('pitch_decks');
    showToast('Pitch deck deleted');
  });
}

function sendPitch(id){
  const p=pitchDecks.find(x=>x.id===id);
  if(!p)return;
  p.status='Sent';
  renderPitchDecks();
  addActivity(`Pitch deck sent to <strong>${p.brand}</strong> for ${p.creator}`);
  showToast(`Pitch sent to ${p.brand}!`);
}

// ‚ïê‚ïê PIPELINE ‚ïê‚ïê
const PIPELINE_STAGES=['Prospect','Pitched','Negotiating','Live','Completed'];
const STAGE_COLORS={Prospect:'var(--gray-400)',Pitched:'var(--blue)',Negotiating:'var(--amber)',Live:'var(--green)',Delivered:'var(--blue)',Completed:'var(--green)',Lost:'var(--red)'};

function renderPipeline(){
  const board=document.getElementById('pipelineBoard');
  const pipelineValue=deals.filter(d=>d.stage!=='Lost'&&d.stage!=='Completed').reduce((s,d)=>s+Number(d.value||0),0);
  document.getElementById('stat-pipeline').textContent=fmtMoney(pipelineValue);
  document.getElementById('pipeline-sub').textContent=`${deals.length} deal${deals.length!==1?'s':''} ¬∑ Total pipeline: ${fmtMoney(pipelineValue)}`;

  board.innerHTML=PIPELINE_STAGES.map(stage=>{
    const stageDe=deals.filter(d=>d.stage===stage);
    return `
      <div>
        <div class="pipeline-col-header">
          <div class="pipeline-col-title"><div style="width:8px;height:8px;border-radius:50%;background:${STAGE_COLORS[stage]}"></div>${stage}</div>
          <div class="pipeline-count">${stageDe.length}</div>
        </div>
        ${stageDe.map(d=>`
          <div class="deal-card" onclick="openEditDeal(${d.id})">
            <div class="deal-brand">${d.brand}</div>
            <div class="deal-creator">‚Üí ${d.creator}</div>
            <div class="deal-value">${fmtMoney(d.value)}</div>
            <div class="deal-meta"><div class="deal-date">${d.notes?d.notes.substring(0,30)+'‚Ä¶':d.stage}</div></div>
          </div>`).join('')}
        <button class="btn btn-ghost btn-sm" style="width:100%;margin-top:4px;justify-content:center;font-size:11px;color:var(--gray-400);border-color:var(--gray-100)" onclick="openAddDealInStage('${stage}')">+ Add deal</button>
      </div>`;
  }).join('');

  // Update recent deals on dashboard
  const dashDeals=document.getElementById('dashRecentDeals');
  const recent=deals.slice(-5).reverse();
  dashDeals.innerHTML=recent.length?`<div class="table-wrap"><table><thead><tr><th>Creator</th><th>Brand</th><th>Value</th><th>Stage</th></tr></thead><tbody>
    ${recent.map(d=>`<tr><td><span style="font-weight:600">${d.creator}</span></td><td>${d.brand}</td><td style="font-weight:600;color:var(--blue)">${fmtMoney(d.value)}</td><td>${statusBadge(d.stage)}</td></tr>`).join('')}
  </tbody></table></div>`:'<div style="font-size:13px;color:var(--gray-400);padding:8px 0">No deals added yet.</div>';
}

async function saveDeal(){
  const brand=document.getElementById('deal-brand').value.trim();
  const creator=document.getElementById('deal-creator').value;
  if(!brand){showToast('Enter a brand name');return;}
  const cr = creators.find(x=>x.name===creator);
  const d={
    id: Date.now() % 2147483647, brand, creator,
    creatorId: cr ? cr.id : null,
    value:document.getElementById('deal-value').value||0,
    stage:document.getElementById('deal-stage').value,
    notes:document.getElementById('deal-notes').value.trim(),
    campaignId: null
  };
  closeModal('addDealModal');
  ['deal-brand','deal-value','deal-notes'].forEach(id=>document.getElementById(id).value='');
  const result = await DB.upsertOne('deals', d);
  if (!result) { showToast('‚ùå Deal save failed'); return; }
  await refetch('deals');
  updateDashStats();
  addActivity(`Deal added: <strong>${brand} √ó ${creator}</strong> (${d.stage})`);
  showToast('Deal added to pipeline!');
}

async function updateDeal(){
  const id=parseInt(document.getElementById('edit-deal-id').value);
  const d=deals.find(x=>x.id===id);
  if(!d)return;
  d.brand=document.getElementById('edit-deal-brand').value.trim();
  d.creator=document.getElementById('edit-deal-creator').value;
  d.value=document.getElementById('edit-deal-value').value;
  d.stage=document.getElementById('edit-deal-stage').value;
  d.notes=document.getElementById('edit-deal-notes').value.trim();
  closeModal('editDealModal');
  const ops = [DB.upsertOne('deals', d)];
  // Sync linked campaign if exists
  if (d.campaignId) {
    const camp = campaigns.find(c => c.id === d.campaignId);
    if (camp) {
      const statusMap = {Live:'Live',Negotiating:'Negotiating',Completed:'Completed',Lost:'Cancelled'};
      if (statusMap[d.stage]) camp.status = statusMap[d.stage];
      camp.value = d.value;
      ops.push(DB.upsertOne('campaigns', camp));
    }
  }
  await Promise.all(ops);
  await Promise.all([refetch('deals'), refetch('campaigns')]);
  updateDashStats();
  addActivity(`Deal updated: <strong>${d.brand} √ó ${d.creator}</strong> ‚Üí ${d.stage}`);
  showToast('Deal updated!');
}

function openAddDealInStage(stage){
  document.getElementById('deal-stage').value=stage;
  openModal('addDealModal');
}

function openEditDeal(id){
  const d=deals.find(x=>x.id===id);
  if(!d)return;
  document.getElementById('edit-deal-id').value=id;
  document.getElementById('edit-deal-brand').value=d.brand;
  document.getElementById('edit-deal-creator').value=d.creator;
  document.getElementById('edit-deal-value').value=d.value;
  document.getElementById('edit-deal-stage').value=d.stage;
  document.getElementById('edit-deal-notes').value=d.notes||'';
  openModal('editDealModal');
}

function deleteDeal(){
  const id = parseInt(document.getElementById('edit-deal-id').value);
  const d = deals.find(x => x.id === id);
  if (!d) return;
  closeModal('editDealModal');
  showConfirm('Delete Deal?', `Remove deal "${d.brand} √ó ${d.creator}" from pipeline?`, async () => {
    console.log('[DB] DELETE deals id=', id);
    const r = await DB.delete('deals', id);
    console.log('[DB] DELETE deals result:', r);
    if (r === null) { showToast('‚ùå Delete failed'); return; }
    await refetch('deals');
    updateDashStats();
    showToast('Deal removed');
  });
}

// ‚îÄ‚îÄ INBOX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderInbox(){
  const list=document.getElementById('inboxList');
  const unread=inboxMessages.filter(m=>m.unread).length;
  document.getElementById('inboxBadge').textContent=unread||inboxMessages.length;

  if (!inboxMessages.length) {
    list.innerHTML='<div class="empty-state" style="padding:32px"><h3>No messages</h3><p>Your inbox is empty</p></div>';
    return;
  }

  list.innerHTML=`
    <div style="padding:12px 16px;border-bottom:1px solid var(--gray-100);font-size:11px;font-weight:600;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;justify-content:space-between">
      <span>Messages</span>
      <span style="background:var(--blue);color:white;border-radius:20px;padding:2px 7px">${unread} unread</span>
    </div>
    ${inboxMessages.map(m=>`
      <div class="inbox-item${m.unread?' unread':''}${currentInboxId===m.id?' active':''}" style="position:relative" onclick="openInboxMessage(${m.id})">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px">
          <div style="display:flex;align-items:center;gap:8px;min-width:0">
            <div style="width:32px;height:32px;border-radius:50%;background:${m.color};display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;color:white;flex-shrink:0">${m.avatar}</div>
            <div style="min-width:0">
              <div class="inbox-sender">${m.from}</div>
              <div class="inbox-preview">${m.subject}</div>
              <div class="inbox-preview">${m.preview}</div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0">
            <div class="inbox-time">${m.time}</div>
            ${m.unread?'<div class="inbox-unread-dot"></div>':''}
            <button class="btn btn-danger btn-sm" style="font-size:10px;padding:2px 6px;margin-top:2px" onclick="event.stopPropagation();confirmDeleteMessage(${m.id})">‚úï</button>
          </div>
        </div>
      </div>`).join('')}
    <div style="padding:14px 16px;font-size:12px;color:var(--gray-400);text-align:center;border-top:1px solid var(--gray-100)">
      Full IMAP integration requires backend setup.<br>
      <button class="btn btn-ghost btn-sm" style="margin-top:8px" onclick="openModal('imapModal')">Configure Email</button>
    </div>`;
}

function confirmDeleteMessage(id) {
  const m = inboxMessages.find(x => x.id === id);
  if (!m) return;
  showConfirm('Delete this message?', `From: ${m.from} ‚Äî "${m.subject}"`, () => {
    inboxMessages = inboxMessages.filter(x => x.id !== id);
    if (currentInboxId === id) {
      currentInboxId = null;
      document.getElementById('inboxPane').innerHTML = '<div class="inbox-empty"><svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-bottom:12px;opacity:.3"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg><div style="font-size:13px;font-weight:500;color:var(--gray-600)">Select a message</div></div>';
    }
    saveInbox();
    renderInbox();
    showToast('Message deleted');
  });
}

function openInboxMessage(id){
  currentInboxId=id;
  const m=inboxMessages.find(x=>x.id===id);
  if(!m)return;
  m.unread=false;
  saveInbox();
  renderInbox();
  const pane=document.getElementById('inboxPane');
  pane.innerHTML=`
    <div class="inbox-email-header">
      <div style="font-size:16px;font-weight:600;color:var(--gray-900);margin-bottom:6px">${m.subject}</div>
      <div style="display:flex;align-items:center;gap:10px">
        <div style="width:28px;height:28px;border-radius:50%;background:${m.color};display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:white">${m.avatar}</div>
        <div><div style="font-size:13px;font-weight:600">${m.from}</div><div style="font-size:11px;color:var(--gray-400)">${m.email}</div></div>
        <div style="margin-left:auto;font-size:11px;color:var(--gray-400)">${m.time}</div>
      </div>
    </div>
    <div class="inbox-email-body" style="white-space:pre-line">${m.body}</div>
    <div class="inbox-email-actions">
      <button class="btn btn-primary btn-sm" onclick="showToast('Reply requires email backend integration')">Reply</button>
      <button class="btn btn-ghost btn-sm" onclick="showToast('Forward requires email backend integration')">Forward</button>
      <button class="btn btn-ghost btn-sm" onclick="showToast('Archive requires email backend integration')">Archive</button>
    </div>`;
}

// ‚îÄ‚îÄ MEDIA KITS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderMediaKitList(){
  const tbody=document.getElementById('mkListBody');
  if(!mediaKits.length){
    tbody.innerHTML=`<tr><td colspan="4" style="text-align:center;padding:20px;color:var(--gray-400);font-size:13px">No kits yet. Generate one above.</td></tr>`;
    return;
  }
  tbody.innerHTML=mediaKits.map(k=>{
    const pic=profilePics[k.creatorId];
    const avatarHtml=pic
      ? `<div class="creator-avatar" style="overflow:hidden;width:28px;height:28px;font-size:11px"><img src="${pic}" class="avatar-img" alt="${k.creatorName}"></div>`
      : `<div class="creator-avatar" style="background:${avatarColor(k.creatorId)};width:28px;height:28px;font-size:11px">${k.initial}</div>`;
    return `
    <tr>
      <td><div class="creator-cell">${avatarHtml}<span class="creator-name">${k.creatorName}</span></div></td>
      <td style="color:var(--gray-400)">${k.updated}</td>
      <td style="font-weight:600">${k.views||0}</td>
      <td style="display:flex;gap:6px">
        <button class="btn btn-ghost btn-sm" onclick="selectKitPreview(${k.creatorId})">Edit</button>
        <button class="btn btn-danger btn-sm" onclick="confirmDeleteKit(${k.creatorId})">Delete</button>
      </td>
    </tr>`;
  }).join('');
}

function confirmDeleteKit(creatorId) {
  const k = mediaKits.find(x => x.creatorId === creatorId);
  if (!k) return;
  showConfirm('Delete Media Kit?', `Remove kit for ${k.creatorName}?`, () => {
    mediaKits = mediaKits.filter(x => x.creatorId !== creatorId);
    delete kitAnalytics[creatorId];
    saveMediaKits(); saveAnalyticsData();
    renderMediaKitList();
    showToast('Media kit deleted');
  });
}

function onKitCreatorChange(val){
  const c=creators.find(x=>x.name===val);
  if(c){
    document.getElementById('mk-name').textContent=c.name;
    document.getElementById('mk-niche').textContent=c.niche+' ¬∑ '+c.location;
    document.getElementById('mk-email').textContent=c.email;
  }
}

function generateKit(){
  const name = document.getElementById('kit-creator-select').value;
  const c    = creators.find(x => x.name === name);
  if (!c) { showToast('Please select a creator first'); return; }

  // Close modal immediately so UI never gets stuck in "Generating‚Ä¶" state
  closeModal('genKitModal');

  // Reset the generate button to its default state (in case it was loading)
  const genBtn = document.querySelector('#genKitModal .btn-primary');
  if (genBtn) { genBtn.disabled = false; genBtn.textContent = 'Generate Kit'; }

  // Add or update kit record
  if (!mediaKits.find(k => k.creatorId === c.id)) {
    mediaKits.push({creatorId:c.id, creatorName:c.name, initial:avatarLetter(c.name), updated:'Just now', views:0});
  }

  onKitCreatorChange(name);
  renderMediaKitList();

  // Pre-fill admin stats from overrides (previously in the override wrapper)
  selectKitPreview(c.id);

  addActivity(`Media kit generated for <strong>${name}</strong>`);
  showToast(`Media kit generated for ${name}!`);
  saveMediaKits();
}

function selectKitPreview(id){
  const c=creators.find(x=>x.id===id);
  if(c){
    onKitCreatorChange(c.name);
    document.getElementById('mk-edit-bio').value=c.niche||'';
    renderKitAnalytics(id);
  }
}

// ‚îÄ‚îÄ MEDIA KIT ANALYTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderKitAnalytics(creatorId) {
  const data = kitAnalytics[creatorId] || {};
  document.getElementById('ana-views').textContent = data.views || '‚Äî';
  document.getElementById('ana-opens').textContent = data.opens || '‚Äî';
  document.getElementById('ana-clicks').textContent = data.clicks || '‚Äî';

  // Age breakdown
  const ages = data.ages || {};
  const ageBrackets = [['13‚Äì17','1317'],['18‚Äì24','1824'],['25‚Äì34','2534'],['35‚Äì44','3544'],['45‚Äì54','4554'],['55+','55']];
  const ageEl = document.getElementById('ana-age-display');
  ageEl.innerHTML = ageBrackets.map(([label, key]) => {
    const pct = ages[key] || 0;
    return `<div class="breakdown-row"><div class="breakdown-label">${label}</div><div class="breakdown-bar"><div class="breakdown-fill" style="width:${pct}%"></div></div><div class="breakdown-pct">${pct}%</div></div>`;
  }).join('') || '<div style="font-size:12px;color:var(--gray-400)">No data yet</div>';

  // Gender
  const gender = data.gender || {};
  const genderEl = document.getElementById('ana-gender-display');
  genderEl.innerHTML = [['Female','f'],['Male','m'],['Other','o']].map(([label, key]) => {
    const pct = gender[key] || 0;
    return `<div class="breakdown-row"><div class="breakdown-label">${label}</div><div class="breakdown-bar"><div class="breakdown-fill" style="width:${pct}%"></div></div><div class="breakdown-pct">${pct}%</div></div>`;
  }).join('');

  // Locations
  const locs = data.locations || [];
  const locEl = document.getElementById('ana-location-display');
  locEl.innerHTML = locs.filter(Boolean).map(l => `<div style="font-size:12px;color:var(--gray-600);padding:4px 0;border-bottom:1px solid var(--gray-100)">${l}</div>`).join('') || '<div style="font-size:12px;color:var(--gray-400)">No data yet</div>';
}

function openAnalyticsModal() {
  // Find which kit is currently selected
  const kitName = document.getElementById('mk-name').textContent;
  const c = creators.find(x => x.name === kitName);
  const id = c ? c.id : null;
  document.getElementById('ana-kit-name').textContent = kitName;

  if (id) {
    const data = kitAnalytics[id] || {};
    document.getElementById('ana-input-views').value = data.views || '';
    document.getElementById('ana-input-opens').value = data.opens || '';
    document.getElementById('ana-input-clicks2').value = data.clicks || '';
    const ages = data.ages || {};
    ['1317','1824','2534','3544','4554','55'].forEach(k => {
      const el = document.getElementById('ana-age-'+k);
      if(el) el.value = ages[k] || '';
    });
    const gender = data.gender || {};
    ['f','m','o'].forEach(k => {
      const el = document.getElementById('ana-gender-'+k);
      if(el) el.value = gender[k] || '';
    });
    const locs = data.locations || [];
    [1,2,3].forEach((i,idx) => {
      const el = document.getElementById('ana-loc-'+i);
      if(el) el.value = locs[idx] || '';
    });
  }
  openModal('analyticsModal');
}

function saveAnalytics() {
  const kitName = document.getElementById('mk-name').textContent;
  const c = creators.find(x => x.name === kitName);
  if (!c) { showToast('Please select a creator first'); return; }
  const id = c.id;

  kitAnalytics[id] = {
    views: parseInt(document.getElementById('ana-input-views').value) || 0,
    opens: parseInt(document.getElementById('ana-input-opens').value) || 0,
    clicks: parseInt(document.getElementById('ana-input-clicks2').value) || 0,
    ages: {
      '1317': parseInt(document.getElementById('ana-age-1317').value)||0,
      '1824': parseInt(document.getElementById('ana-age-1824').value)||0,
      '2534': parseInt(document.getElementById('ana-age-2534').value)||0,
      '3544': parseInt(document.getElementById('ana-age-3544').value)||0,
      '4554': parseInt(document.getElementById('ana-age-4554').value)||0,
      '55':   parseInt(document.getElementById('ana-age-55').value)||0,
    },
    gender: {
      f: parseInt(document.getElementById('ana-gender-f').value)||0,
      m: parseInt(document.getElementById('ana-gender-m').value)||0,
      o: parseInt(document.getElementById('ana-gender-o').value)||0,
    },
    locations: [
      document.getElementById('ana-loc-1').value.trim(),
      document.getElementById('ana-loc-2').value.trim(),
      document.getElementById('ana-loc-3').value.trim(),
    ].filter(Boolean)
  };

  // Also update kit views
  const kit = mediaKits.find(k => k.creatorId === id);
  if (kit) kit.views = kitAnalytics[id].views;

  saveAnalyticsData();
  saveMediaKits();
  closeModal('analyticsModal');
  renderKitAnalytics(id);
  renderMediaKitList();
  showToast('Analytics saved!');
}

function updateKitPreview(){
  const bio=document.getElementById('mk-edit-bio').value;
  const p1=document.getElementById('mk-edit-p1').value;
  const p2=document.getElementById('mk-edit-p2').value;
  if(bio)document.getElementById('mk-niche').textContent=bio;
  document.getElementById('mk-platforms').innerHTML=[p1,p2].filter(Boolean).map(p=>`<div class="mk-platform">${p}</div>`).join('');
}

function saveKitEdits(){showToast('Kit changes saved!');}
function shareKit(){
  const name=document.getElementById('mk-name').textContent;
  showToast(`Share link for ${name} copied!`);
}

// ‚ïê‚ïê DASH STATS ‚ïê‚ïê
function updateDashStats(){
  // Total creators ‚Äî never decreases on onboarding (only on delete)
  document.getElementById('stat-creators').textContent = creators.length;
  const sub = document.getElementById('stat-creators-sub');
  if (sub) {
    const active = creators.filter(c=>c.status==='Active').length;
    const onboarded = creators.filter(c=>c.onboarding).length;
    sub.textContent = `${active} active ¬∑ ${onboarded} onboarded`;
  }

  const activeCamps=campaigns.filter(c=>c.status==='Live'||c.status==='Negotiating');
  document.getElementById('stat-campaigns').textContent=activeCamps.length;
  document.getElementById('stat-campaigns-sub').textContent=activeCamps.length?`${activeCamps.length} in progress`:'No active campaigns';
  const pipVal=deals.filter(d=>d.stage!=='Lost'&&d.stage!=='Completed').reduce((s,d)=>s+Number(d.value||0),0);
  document.getElementById('stat-pipeline').textContent=fmtMoney(pipVal);

  // Avg engagement rate from admin overrides (resolved)
  const engRates = creators.map(c=>resolveCreator(c).engRate).filter(v=>v!=null&&v!=='');
  const avgEngEl = document.getElementById('stat-avg-eng');
  const avgSubEl = document.getElementById('stat-avg-eng-sub');
  if (avgEngEl) {
    if (engRates.length) {
      const avg = (engRates.reduce((s,v)=>s+parseFloat(v),0)/engRates.length).toFixed(1);
      avgEngEl.textContent = avg+'%';
      if (avgSubEl) avgSubEl.textContent = `Across ${engRates.length} creator${engRates.length>1?'s':''}`;
    } else {
      avgEngEl.textContent = '‚Äî';
      if (avgSubEl) avgSubEl.textContent = 'No data yet';
    }
  }
}

// ‚ïê‚ïê POPULATE SELECTS ‚ïê‚ïê
function populateSelects(){
  const names=creators.map(c=>c.name);
  ['invite-creator-select','camp-creator','edit-camp-creator','pitch-creator','edit-pitch-creator','deal-creator','edit-deal-creator','kit-creator-select'].forEach(id=>{
    const el=document.getElementById(id);
    if(!el)return;
    const prev=el.value;
    el.innerHTML=names.map(n=>`<option>${n}</option>`).join('');
    if(names.includes(prev))el.value=prev;
    else if(names.length)el.value=names[0];
  });
}

// ‚ïê‚ïê USERS & ACCESS MANAGEMENT ‚ïê‚ïê
function renderUsersPage() {
  const role = currentUser ? (currentUser.systemRole || 'readonly') : 'readonly';
  const canManage = (role==='owner' || role==='admin');
  document.getElementById('users-perm-denied').style.display = canManage ? 'none' : 'flex';
  document.getElementById('users-content').style.display = canManage ? '' : 'none';
  document.getElementById('btn-add-user').style.display = canManage ? '' : 'none';
  if (!canManage) return;

  const grid = document.getElementById('usersGrid');
  grid.innerHTML = STAFF.map(s => {
    const r = s.systemRole || 'readonly';
    const isOwner = (s.email === 'ubayy@blustu.agency');
    const isSelf = (currentUser && s.email === currentUser.email);
    const canEdit = !isOwner && (role === 'owner' || (role === 'admin' && r !== 'owner'));
    return `
    <div class="user-card">
      <div class="user-card-header">
        <div class="user-card-avatar" style="background:${AVATAR_COLORS[STAFF.indexOf(s)%AVATAR_COLORS.length]}">${s.name[0].toUpperCase()}</div>
        <div style="flex:1;min-width:0">
          <div style="font-size:14px;font-weight:600;color:var(--gray-900)">${s.name} ${isSelf?'<span style="font-size:10px;color:var(--gray-400)">(you)</span>':''}</div>
          <div style="font-size:11px;color:var(--gray-400);margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${s.email}</div>
        </div>
        <span class="role-badge role-${r}">${ROLE_LABELS[r]||r}</span>
      </div>
      ${isOwner ? '<div style="font-size:11px;color:var(--amber);background:var(--amber-light);padding:6px 10px;border-radius:8px;">üëë Account owner ‚Äî cannot be modified</div>' : ''}
      <div class="user-card-actions">
        <button class="btn btn-ghost btn-sm" style="flex:1" onclick="openEditUser('${s.email}')" ${!canEdit?'disabled':''}>Edit</button>
        ${!isOwner && role==='owner' ? `<button class="btn btn-danger btn-sm" onclick="openDeleteUser('${s.email}')">Remove</button>` : ''}
      </div>
    </div>`;
  }).join('');
}

function openEditUser(email) {
  const s = STAFF.find(x => x.email === email);
  if (!s) return;
  document.getElementById('eu-email').value = email;
  document.getElementById('eu-name').value = s.name;
  document.getElementById('eu-role').value = s.systemRole || 'readonly';
  document.getElementById('eu-pass').value = '';
  // Hide delete for owner
  const delBtn = document.getElementById('eu-delete-btn');
  if (delBtn) delBtn.style.display = (s.email === 'ubayy@blustu.agency' || currentUser.systemRole !== 'owner') ? 'none' : '';
  openModal('editUserModal');
}

async function saveStaffUser() {
  const email = document.getElementById('eu-email').value;
  const s = STAFF.find(x => x.email === email);
  if (!s) return;
  const newName = document.getElementById('eu-name').value.trim();
  const newRole = document.getElementById('eu-role').value;
  const newPass = document.getElementById('eu-pass').value.trim();
  if (newName) s.name = newName;
  if (s.email !== 'ubayy@blustu.agency') s.systemRole = newRole;
  if (newPass && newPass.length >= 4) s.pass = newPass;
  Storage.set('staff', STAFF);
  if (s.id) await DB.upsertOne('staff_accounts', s);
  closeModal('editUserModal');
  renderUsersPage();
  showToast('User updated!');
}

function openDeleteUser(email) {
  const s = STAFF.find(x => x.email === email);
  if (!s || s.email === 'ubayy@blustu.agency') return;
  if (confirm(`Remove ${s.name} (${s.email}) from staff? This cannot be undone.`)) {
    deleteStaffUserByEmail(email);
  }
}

async function deleteStaffUser() {
  const email = document.getElementById('eu-email').value;
  const s = STAFF.find(x => x.email === email);
  if (!s || s.email === 'ubayy@blustu.agency') { showToast('Cannot delete owner account'); return; }
  if (confirm(`Remove ${s.name}?`)) {
    await deleteStaffUserByEmail(email);
    closeModal('editUserModal');
  }
}

async function deleteStaffUserByEmail(email) {
  const u = STAFF.find(x => x.email === email);
  STAFF = STAFF.filter(x => x.email !== email);
  Storage.set('staff', STAFF);
  if (u && u.id) await DB.delete('staff_accounts', u.id);
  renderUsersPage();
  showToast('User removed');
}

async function addStaffUser() {
  const name  = document.getElementById('nu-name').value.trim();
  const email = document.getElementById('nu-email').value.trim().toLowerCase();
  const pass  = document.getElementById('nu-pass').value.trim();
  const role  = document.getElementById('nu-role').value;
  if (!name || !email || !pass) { showToast('Please fill all fields'); return; }
  if (STAFF.find(s => s.email === email)) { showToast('Email already exists'); return; }
  const newUser = { id: Date.now() % 2147483647, email, pass, name, systemRole: role };
  STAFF.push(newUser);
  Storage.set('staff', STAFF);
  const result = await DB.upsertOne('staff_accounts', newUser);
  if (!result) { showToast('‚ö†Ô∏è User saved locally but failed to sync ‚Äî try again'); }
  closeModal('addUserModal');
  renderUsersPage();
  addActivity(`Staff account added: <strong>${name}</strong> (${ROLE_LABELS[role]})`);
  showToast(`${name} added as ${ROLE_LABELS[role]}`);
  ['nu-name','nu-email','nu-pass'].forEach(id=>{ const el=document.getElementById(id); if(el)el.value=''; });
}

// ‚îÄ‚îÄ CONFIRM MODAL HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showConfirm(title, msg, onOk) {
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmMsg').textContent = msg;
  const btn = document.getElementById('confirmOkBtn');
  btn.onclick = () => { closeModal('confirmModal'); onOk(); };
  openModal('confirmModal');
}

// ‚îÄ‚îÄ GLOBAL SEARCH (OVERLAY) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSearchOverlay() {
  document.getElementById('searchOverlay').classList.add('open');
  setTimeout(() => document.getElementById('globalSearchInput').focus(), 50);
}

function closeSearchOverlay(e) {
  if (!e || e.target === document.getElementById('searchOverlay')) {
    document.getElementById('searchOverlay').classList.remove('open');
    document.getElementById('globalSearchInput').value = '';
    document.getElementById('searchResultsPanel').style.display = 'none';
  }
}

function doGlobalSearch(q) {
  const panel = document.getElementById('searchResultsPanel');
  if (!q || q.length < 2) { panel.style.display = 'none'; return; }
  const s = q.toLowerCase();

  let html = '';

  // Creators
  const cResults = creators.filter(c =>
    (c.name||'').toLowerCase().includes(s) || (c.email||'').toLowerCase().includes(s) ||
    (c.niche||'').toLowerCase().includes(s) || (c.location||'').toLowerCase().includes(s)
  ).slice(0, 4);
  if (cResults.length) {
    html += `<div class="search-group-label">Creators</div>`;
    html += cResults.map(c => `
      <div class="search-result-item" onclick="closeSearchOverlay();openCreatorProfile(${c.id})">
        <div class="search-result-icon" style="background:${avatarColor(c.id)};color:white;font-weight:700">${avatarLetter(c.name)}</div>
        <div><div class="search-result-main">${c.name}</div><div class="search-result-sub">${c.niche} ¬∑ ${c.location}</div></div>
      </div>`).join('');
  }

  // Campaigns
  const campResults = campaigns.filter(c =>
    c.brand.toLowerCase().includes(s) || c.creator.toLowerCase().includes(s) ||
    (c.status||'').toLowerCase().includes(s)
  ).slice(0, 3);
  if (campResults.length) {
    html += `<div class="search-group-label">Campaigns</div>`;
    html += campResults.map(c => `
      <div class="search-result-item" onclick="closeSearchOverlay();showPage('campaigns',document.querySelector('[onclick*=campaigns]'));setTimeout(()=>openEditCampaign(${c.id}),100)">
        <div class="search-result-icon" style="background:var(--blue-light)">üìà</div>
        <div><div class="search-result-main">${c.brand} √ó ${c.creator}</div><div class="search-result-sub">${c.status} ¬∑ ${fmtMoney(c.value)}</div></div>
      </div>`).join('');
  }

  // Deals
  const dealResults = deals.filter(d =>
    d.brand.toLowerCase().includes(s) || d.creator.toLowerCase().includes(s) ||
    d.stage.toLowerCase().includes(s)
  ).slice(0, 3);
  if (dealResults.length) {
    html += `<div class="search-group-label">Pipeline Deals</div>`;
    html += dealResults.map(d => `
      <div class="search-result-item" onclick="closeSearchOverlay();showPage('pipeline',document.querySelector('[onclick*=pipeline]'));setTimeout(()=>openEditDeal(${d.id}),100)">
        <div class="search-result-icon" style="background:var(--green-light)">üíº</div>
        <div><div class="search-result-main">${d.brand} √ó ${d.creator}</div><div class="search-result-sub">${d.stage} ¬∑ ${fmtMoney(d.value)}</div></div>
      </div>`).join('');
  }

  // Media Kits
  const kitResults = mediaKits.filter(k => k.creatorName.toLowerCase().includes(s)).slice(0, 2);
  if (kitResults.length) {
    html += `<div class="search-group-label">Media Kits</div>`;
    html += kitResults.map(k => `
      <div class="search-result-item" onclick="closeSearchOverlay();showPage('mediakit',document.querySelector('[onclick*=mediakit]'));setTimeout(()=>selectKitPreview(${k.creatorId}),100)">
        <div class="search-result-icon" style="background:var(--amber-light)">üìÑ</div>
        <div><div class="search-result-main">${k.creatorName} ‚Äî Media Kit</div><div class="search-result-sub">${k.views||0} views</div></div>
      </div>`).join('');
  }

  // Inbox
  const msgResults = inboxMessages.filter(m =>
    m.from.toLowerCase().includes(s) || m.subject.toLowerCase().includes(s) ||
    m.preview.toLowerCase().includes(s)
  ).slice(0, 2);
  if (msgResults.length) {
    html += `<div class="search-group-label">Inbox</div>`;
    html += msgResults.map(m => `
      <div class="search-result-item" onclick="closeSearchOverlay();showPage('inbox',document.querySelector('[onclick*=inbox]'));setTimeout(()=>openInboxMessage(${m.id}),100)">
        <div class="search-result-icon" style="background:${m.color};color:white;font-weight:700">${m.avatar}</div>
        <div><div class="search-result-main">${m.subject}</div><div class="search-result-sub">From: ${m.from}</div></div>
      </div>`).join('');
  }

  if (!html) {
    html = `<div class="search-empty">No results for "<strong>${q}</strong>"</div>`;
  }

  panel.innerHTML = html;
  panel.style.display = 'block';
}

// ‚îÄ‚îÄ MOBILE SIDEBAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleSidebar() {
  document.querySelector('.sidebar').classList.toggle('open');
  document.getElementById('sidebarOverlay').classList.toggle('show');
}
function closeSidebar() {
  document.querySelector('.sidebar').classList.remove('open');
  document.getElementById('sidebarOverlay').classList.remove('show');
}

// ‚îÄ‚îÄ RENAME old handleGlobalSearch ‚Üí no-op (search replaced) ‚îÄ‚îÄ
function handleGlobalSearch() {}

function renderAll() {
  renderCRM(creators);
  renderCampaigns(currentCampaignFilter);
  renderPitchDecks();
  renderPipeline();
  renderInbox();
  renderMediaKitList();
  renderOnboarding();
  updateDashStats();
  populateSelects();
  populateRateKitSelector();
  renderUsersPage();
}

// ‚îÄ‚îÄ FORCE SYNC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function forceSyncAll() {
  const btn = document.getElementById('syncBtn');
  if (btn) { btn.disabled = true; btn.textContent = '‚ü≥ Syncing‚Ä¶'; }
  await syncAllFromDB();
  if (btn) {
    btn.disabled = false;
    btn.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg> Sync';
  }
  showToast('‚úÖ All data synced!');
}

// ‚îÄ‚îÄ SAVE HELPERS: write to Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveInbox()         { DB.upsertMany('inbox_messages', inboxMessages); Storage.set('inboxMessages', inboxMessages); }
function saveAnalyticsData() { DB.setAppData('kitAnalytics', kitAnalytics); Storage.set('kitAnalytics', kitAnalytics); }
function saveProfilePics()   { DB.setAppData('profilePics',  profilePics);  Storage.set('profilePics',  profilePics); }

async function saveCreators()   { Storage.set('creators',   creators);   await DB.upsertMany('creators',   creators); }
async function saveCampaigns()  { Storage.set('campaigns',  campaigns);  await DB.upsertMany('campaigns',  campaigns); }
async function savePitchDecks() { Storage.set('pitchDecks', pitchDecks); await DB.upsertMany('pitch_decks',pitchDecks); }
async function saveDeals()      { Storage.set('deals',      deals);      await DB.upsertMany('deals',      deals); }
async function saveMediaKits()  { Storage.set('mediaKits',  mediaKits);  await DB.upsertMany('media_kits', mediaKits); }
async function saveNextId()     { Storage.set('nextId', nextId); await DB.setAppData('nextId', nextId); }

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.addEventListener('DOMContentLoaded', async function() {
  // CRITICAL: prefetch staff_accounts from Supabase BEFORE showing login.
  // Without this, only the first device (with localStorage) can log in.
  // Every other device starts with DEFAULT_STAFF only ‚Äî Rayyan/others fail.
  await prefetchStaff();

  checkPortalParam();
  const params = new URLSearchParams(location.search);
  if (!params.get('onboard')) {
    document.getElementById('authScreen').classList.remove('hidden');
  }
  ['loginEmail','loginPassword'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('keydown', e => { if (e.key === 'Enter') doLogin(); });
  });
  document.getElementById('nav-dashboard').classList.add('active');
  initInvoice();

  window.addEventListener('beforeunload', (e) => {
    if (currentUser) { e.preventDefault(); e.returnValue = ''; }
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ CONTRACTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openUploadContract() {
  const fi = document.getElementById('contractFileInput');
  if (fi) fi.click();
}

async function handleContractUpload(event) {
  const file = event.target.files[0];
  if (!file || !currentCreatorId) return;
  event.target.value = '';
  if (file.type !== 'application/pdf') { showToast('Please upload a PDF file'); return; }

  showToast('Uploading contract‚Ä¶');
  const fileName = `creator_${currentCreatorId}_${Date.now()}.pdf`;

  // Upload to Supabase Storage bucket "contracts"
  const uploadUrl = `${SUPABASE_URL}/storage/v1/object/contracts/${fileName}`;
  let pdfUrl = null;
  try {
    const r = await fetch(uploadUrl, {
      method: 'POST',
      headers: {
        'apikey': SUPABASE_KEY,
        'Authorization': `Bearer ${SUPABASE_KEY}`,
        'Content-Type': 'application/pdf',
        'x-upsert': 'true'
      },
      body: file
    });
    if (r.ok) {
      pdfUrl = `${SUPABASE_URL}/storage/v1/object/public/contracts/${fileName}`;
    } else {
      const err = await r.text();
      console.error('[Contracts] Upload failed:', err);
      showToast('‚ùå Upload failed. Check Supabase Storage bucket "contracts" exists.');
      return;
    }
  } catch(e) {
    console.error('[Contracts] Upload error:', e);
    showToast('‚ùå Upload error ‚Äî check network');
    return;
  }

  // Save contract metadata to Supabase
  const contract = {
    id: Date.now() % 2147483647,
    influencer_id: currentCreatorId,
    contract_name: file.name.replace(/\.pdf$/i, ''),
    start_date: null,
    end_date: null,
    status: 'Active',
    pdf_url: pdfUrl,
    notes: '',
    created_at: new Date().toISOString()
  };

  console.log('[Contracts] Saving:', contract);
  const result = await DB.upsertOne('contracts', contract);
  console.log('[Contracts] Save result:', result);

  if (!result) { showToast('‚ùå Contract metadata save failed'); return; }
  showToast('‚úÖ Contract uploaded!');
  await renderCreatorContracts(currentCreatorId);
}

async function renderCreatorContracts(creatorId) {
  const el = document.getElementById('profile-contracts-body');
  if (!el) return;
  el.innerHTML = '<div style="font-size:13px;color:var(--gray-400)">Loading‚Ä¶</div>';

  const rows = await DB._req('GET', 'contracts', null,
    `?influencer_id=eq.${creatorId}&order=created_at.desc`);

  if (!rows || !rows.length) {
    el.innerHTML = '<div style="font-size:13px;color:var(--gray-400)">No contracts uploaded yet.</div>';
    return;
  }

  el.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px">
    ${rows.map(c => `
      <div style="display:flex;align-items:center;gap:12px;padding:12px 14px;border:1px solid var(--gray-100);border-radius:10px;background:var(--gray-50)">
        <div style="width:36px;height:36px;background:var(--red-light);border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--red)" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        </div>
        <div style="flex:1;min-width:0">
          <div style="font-size:13px;font-weight:600;margin-bottom:2px">${c.contract_name||'Contract'}</div>
          <div style="font-size:11px;color:var(--gray-400)">
            ${c.start_date?'From '+c.start_date:''}${c.end_date?' ¬∑ To '+c.end_date:''}
            ¬∑ Uploaded ${new Date(c.created_at).toLocaleDateString('en-GB')}
          </div>
        </div>
        ${statusBadge(c.status||'Active')}
        <a href="${c.pdf_url}" target="_blank" class="btn btn-ghost btn-sm" style="text-decoration:none;flex-shrink:0">View PDF</a>
        <button class="btn btn-danger btn-sm" style="flex-shrink:0" onclick="deleteContract(${c.id})">‚úï</button>
      </div>`).join('')}
  </div>`;
}

async function deleteContract(id) {
  if (!confirm('Delete this contract?')) return;
  console.log('[Contracts] Deleting id:', id);
  const r = await DB.delete('contracts', id);
  console.log('[Contracts] Delete result:', r);
  if (r === null) { showToast('‚ùå Delete failed'); return; }
  showToast('Contract deleted');
  await renderCreatorContracts(currentCreatorId);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ CAMPAIGN REPORTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function populateReportSelector() {
  const sel = document.getElementById('reportCampaignSelect');
  if (!sel) return;
  const prev = sel.value;
  sel.innerHTML = '<option value="">Select a campaign to view its report‚Ä¶</option>' +
    campaigns.map(c => `<option value="${c.id}">${c.brand} √ó ${c.creator} (${c.status})</option>`).join('');
  if (prev) sel.value = prev;
}

function switchReportTab(id, btn) {
  document.querySelectorAll('[id^="rtab-"]').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('#page-reports .profile-tab').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('rtab-'+id);
  if (el) el.classList.add('active');
  if (btn) btn.classList.add('active');
}

function loadReport(campId) {
  if (!campId) return;
  const camp = campaigns.find(x => String(x.id) === String(campId));
  if (!camp) return;

  document.getElementById('reportContent').style.display = 'block';
  document.getElementById('reportEmpty').style.display = 'none';

  // Header
  document.getElementById('reportTitle').textContent = `${camp.brand} √ó ${camp.creator}`;
  document.getElementById('reportMeta').textContent =
    `${camp.status} ¬∑ Deadline: ${camp.deadline||'TBD'} ¬∑ ${camp.deliverables||'‚Äî'}`;
  document.getElementById('reportTotalValue').textContent = fmtMoney(camp.value);

  const creator = creators.find(x => x.name === camp.creator);
  const ob = creator && creator.onboarding;
  const campDeals = deals.filter(d =>
    String(d.campaignId) === String(campId) || d.brand === camp.brand
  );

  // KPI Cards
  const kpis = [
    {label:'Progress', value:`${camp.progress||0}%`, color:'var(--blue)'},
    {label:'Campaign Value', value:fmtMoney(camp.value), color:'var(--green)'},
    {label:'Linked Deals', value:campDeals.length, color:'var(--amber)'},
    {label:'Status', value:camp.status, color:'var(--blue)'},
    {label:'Deliverables', value:camp.deliverables||'‚Äî', color:'var(--gray-600)'},
    {label:'Deadline', value:camp.deadline||'TBD', color:'var(--red)'},
  ];
  document.getElementById('reportKPIs').innerHTML = kpis.map(k => `
    <div style="background:white;border-radius:12px;padding:16px 18px;box-shadow:var(--shadow-sm);border:1px solid var(--gray-100)">
      <div style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:var(--gray-400);margin-bottom:6px">${k.label}</div>
      <div style="font-size:20px;font-weight:700;color:${k.color};font-family:'DM Serif Display',serif">${k.value}</div>
    </div>`).join('');

  // Creator performance table
  document.getElementById('reportCreatorTableBody').innerHTML = `
    <tr>
      <td>
        <div style="display:flex;align-items:center;gap:8px">
          <div class="creator-avatar" style="background:${creator?avatarColor(creator.id):'var(--blue)'};width:28px;height:28px;font-size:11px">${avatarLetter(camp.creator)}</div>
          <div>
            <div style="font-weight:600;font-size:13px">${camp.creator}</div>
            <div style="font-size:11px;color:var(--gray-400)">${creator?creator.email:''}</div>
          </div>
        </div>
      </td>
      <td>${camp.deliverables||'‚Äî'}</td>
      <td>‚Äî</td>
      <td>‚Äî</td>
      <td>‚Äî</td>
      <td style="font-weight:600;color:var(--blue)">${fmtMoney(camp.value)}</td>
      <td>${statusBadge(camp.status)}</td>
    </tr>`;

  // Creators detail tab
  document.getElementById('reportCreatorsDetail').innerHTML = creator ? `
    <div class="card">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
        <div class="creator-avatar" style="background:${avatarColor(creator.id)};width:48px;height:48px;font-size:20px">${avatarLetter(creator.name)}</div>
        <div>
          <div style="font-size:18px;font-weight:700;margin-bottom:2px">${creator.name}</div>
          <div style="font-size:13px;color:var(--gray-400)">${creator.niche} ¬∑ ${creator.location}</div>
        </div>
        ${statusBadge(creator.status)}
      </div>
      ${ob ? `
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:10px">
          ${ob.tiktok?`<div style="background:var(--gray-50);border-radius:8px;padding:10px"><div style="font-size:10px;color:var(--gray-400);margin-bottom:2px">TikTok</div><div style="font-size:12px;font-weight:600">${ob.tiktok}</div></div>`:''}
          ${ob.instagram?`<div style="background:var(--gray-50);border-radius:8px;padding:10px"><div style="font-size:10px;color:var(--gray-400);margin-bottom:2px">Instagram</div><div style="font-size:12px;font-weight:600">${ob.instagram}</div></div>`:''}
          ${ob.rates?Object.entries(ob.rates).filter(([,v])=>v).map(([k,v])=>`
            <div style="background:var(--blue-light);border-radius:8px;padding:10px">
              <div style="font-size:10px;color:var(--blue);margin-bottom:2px">${k}</div>
              <div style="font-size:15px;font-weight:700;color:var(--blue)">¬£${v}</div>
            </div>`).join(''):''}
        </div>` :
        '<div style="font-size:13px;color:var(--gray-400)">Creator hasn\'t completed onboarding ‚Äî no rate data yet.</div>'}
    </div>` : '<div class="card"><div style="font-size:13px;color:var(--gray-400)">Creator not found in roster.</div></div>';

  // Content tab
  document.getElementById('reportContentDetail').innerHTML = `
    <div style="display:flex;flex-direction:column;gap:10px">
      <div style="padding:14px;background:var(--gray-50);border-radius:10px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--gray-400);margin-bottom:4px">DELIVERABLES</div>
        <div style="font-size:14px;font-weight:600">${camp.deliverables||'Not specified'}</div>
      </div>
      <div style="padding:14px;background:var(--gray-50);border-radius:10px">
        <div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--gray-400);margin-bottom:8px">PROGRESS</div>
        <div class="progress-bar" style="margin-bottom:6px"><div class="progress-fill ${camp.status==='Live'?'green':''}" style="width:${camp.progress||0}%"></div></div>
        <div style="font-size:13px;font-weight:600">${camp.progress||0}% complete</div>
      </div>
      ${camp.notes?`<div style="padding:14px;background:var(--gray-50);border-radius:10px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--gray-400);margin-bottom:4px">BRIEF / NOTES</div><div style="font-size:13px">${camp.notes}</div></div>`:''}
    </div>`;

  // Audience tab
  document.getElementById('reportAudienceDetail').innerHTML = ob ? `
    <div style="display:flex;flex-direction:column;gap:10px">
      ${ob.bio?`<div style="padding:14px;background:var(--gray-50);border-radius:10px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--gray-400);margin-bottom:4px">BIO</div><div style="font-size:13px">${ob.bio}</div></div>`:''}
      ${ob.niche?`<div style="padding:14px;background:var(--gray-50);border-radius:10px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--gray-400);margin-bottom:4px">NICHE / CONTENT</div><div style="font-size:14px;font-weight:600">${ob.niche}</div></div>`:''}
      ${ob.restrictions?`<div style="padding:14px;background:var(--red-light);border-radius:10px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--red);margin-bottom:4px">BRAND RESTRICTIONS</div><div style="font-size:13px;color:var(--red)">${ob.restrictions}</div></div>`:''}
      ${ob.preferences?`<div style="padding:14px;background:var(--green-light);border-radius:10px"><div style="font-size:10px;font-weight:700;text-transform:uppercase;color:var(--green);margin-bottom:4px">PREFERENCES</div><div style="font-size:13px">${ob.preferences}</div></div>`:''}
    </div>` : '<div style="font-size:13px;color:var(--gray-400)">Audience data requires creator onboarding. Send them their onboarding link.</div>';
}

function exportReportPDF() {
  showToast('Opening print dialog ‚Äî choose "Save as PDF"');
  setTimeout(() => window.print(), 400);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ INVOICE GENERATOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

let _invoiceInitDone = false;
function initInvoice() {
  if (_invoiceInitDone) return;
  _invoiceInitDone = true;
  const today = new Date().toISOString().split('T')[0];
  const due30 = new Date(Date.now() + 30*864e5).toISOString().split('T')[0];
  const set = (id, val) => { const el=document.getElementById(id); if(el&&!el.value) el.value=val; };
  set('inv-issue', today); set('inv-due', due30); set('inv-sigdate', today);
  set('inv-number', 'INV-' + Date.now().toString().slice(-4));
  set('inv-payto', 'blustu‚Ñ¢ Talent Agency\ncontact@blustu.agency');

  // Wire up live preview
  document.querySelectorAll('#page-invoice input, #page-invoice textarea').forEach(el => {
    el.addEventListener('input', updateInvoicePreview);
  });
  updateInvoicePreview();
}

function addInvItem() {
  const container = document.getElementById('inv-items');
  if (!container) return;
  const row = document.createElement('div');
  row.className = 'inv-item-row';
  row.style.cssText = 'display:grid;grid-template-columns:1fr 80px 90px 32px;gap:8px;margin-bottom:8px';
  row.innerHTML = `
    <input class="form-input" placeholder="Description" oninput="updateInvoicePreview()">
    <input class="form-input" type="number" placeholder="Qty" value="1" oninput="updateInvoicePreview()">
    <input class="form-input" type="number" placeholder="Rate ¬£" oninput="updateInvoicePreview()">
    <button class="btn btn-ghost btn-sm" onclick="removeInvItem(this)" style="padding:4px 8px;font-size:14px">‚úï</button>`;
  container.appendChild(row);
  updateInvoicePreview();
}

function removeInvItem(btn) { btn.parentElement.remove(); updateInvoicePreview(); }

function updateInvoicePreview() {
  const g = id => document.getElementById(id)?.value || '';
  const title   = g('inv-title') || 'Invoice';
  const number  = g('inv-number');
  const issue   = g('inv-issue');
  const due     = g('inv-due');
  const billto  = g('inv-billto');
  const payto   = g('inv-payto');
  const payment = g('inv-payment');
  const tax     = parseFloat(g('inv-tax')) || 0;
  const notes   = g('inv-notes');
  const sig     = g('inv-signature');
  const sigdate = g('inv-sigdate');

  const p = (id, val) => { const el=document.getElementById(id); if(el) el.textContent=val||''; };
  p('prev-title', title); p('prev-number', number);
  p('prev-billto', billto); p('prev-payto', payto);
  p('prev-signature', sig); p('prev-sigdate', sigdate);

  const datesEl = document.getElementById('prev-dates');
  if (datesEl) datesEl.innerHTML = `<div>Issued: ${issue||'‚Äî'}</div><div>Due: ${due||'‚Äî'}</div>`;

  const rows = document.querySelectorAll('.inv-item-row');
  let subtotal = 0;
  const tbody = document.getElementById('prev-items');
  if (tbody) {
    tbody.innerHTML = '';
    rows.forEach(row => {
      const inputs = row.querySelectorAll('input');
      const desc = inputs[0]?.value || '';
      const qty  = parseFloat(inputs[1]?.value || 1);
      const rate = parseFloat(inputs[2]?.value || 0);
      if (!desc && !rate) return;
      const amount = qty * rate;
      subtotal += amount;
      tbody.innerHTML += `<tr>
        <td style="padding:5px 8px;border-bottom:1px solid var(--gray-100)">${desc}</td>
        <td style="padding:5px 8px;border-bottom:1px solid var(--gray-100);text-align:right">${qty}</td>
        <td style="padding:5px 8px;border-bottom:1px solid var(--gray-100);text-align:right">¬£${rate.toFixed(2)}</td>
        <td style="padding:5px 8px;border-bottom:1px solid var(--gray-100);text-align:right;font-weight:600">¬£${amount.toFixed(2)}</td>
      </tr>`;
    });
  }

  const taxAmt = subtotal * (tax/100);
  const total = subtotal + taxAmt;
  const totalsEl = document.getElementById('prev-totals');
  if (totalsEl) totalsEl.innerHTML = `
    <div style="font-size:11px;color:var(--gray-400);margin-bottom:3px">Subtotal: ¬£${subtotal.toFixed(2)}</div>
    ${tax>0?`<div style="font-size:11px;color:var(--gray-400);margin-bottom:3px">Tax (${tax}%): ¬£${taxAmt.toFixed(2)}</div>`:''}
    <div style="font-size:20px;font-weight:700;border-top:2px solid var(--gray-900);padding-top:6px;margin-top:6px">Total: ¬£${total.toFixed(2)}</div>`;

  const footerEl = document.getElementById('prev-footer');
  if (footerEl) footerEl.innerHTML =
    (payment ? `<div>Payment method: ${payment}</div>` : '') +
    (notes   ? `<div style="margin-top:4px">${notes}</div>` : '');
}

function clearInvoice() {
  ['inv-title','inv-number','inv-issue','inv-due','inv-billto','inv-payto',
   'inv-payment','inv-tax','inv-notes','inv-signature','inv-sigdate'].forEach(id=>{
    const el=document.getElementById(id); if(el) el.value='';
  });
  const items = document.getElementById('inv-items');
  if (items) items.innerHTML='';
  _invoiceInitDone = false;
  initInvoice();
}

function exportInvoicePDF() {
  const preview = document.getElementById('invoicePreview');
  if (!preview) { showToast('No invoice to export'); return; }
  const win = window.open('', '_blank', 'width=800,height=1100');
  if (!win) { showToast('Allow popups to export PDF'); return; }
  win.document.write(`<!DOCTYPE html><html><head>
    <meta charset="UTF-8">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <style>
      *{margin:0;padding:0;box-sizing:border-box}
      body{font-family:'DM Sans',sans-serif;padding:48px;max-width:680px;margin:0 auto;font-size:13px;color:#0f1120;line-height:1.6}
      table{width:100%;border-collapse:collapse}
      @media print{body{padding:28px}button{display:none!important}}
    </style>
    </head><body>${preview.innerHTML}
    <script>window.onload=()=>{setTimeout(()=>window.print(),600)}<\/script>
    </body></html>`);
  win.document.close();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ PROFILE SOCIALS: Full dual-layer display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function renderProfileSocials(c) {
  const el = document.getElementById('profile-socials-body');
  if (!el) return;
  const ob = c.onboarding || {};
  const ao = adminOverrides[c.id] || {};

  if (!ob && !Object.keys(ob).length && !c.onboarding) {
    el.innerHTML = `<div class="card">
      <div style="background:var(--blue-light);border-radius:10px;padding:16px;font-size:13px;color:var(--blue);line-height:1.6">
        ‚ÑπÔ∏è This creator hasn't completed onboarding yet.
        <br><br><button class="btn btn-ghost btn-sm" onclick="openModal('inviteCreatorModal')">Send Onboarding Link</button>
      </div>
    </div>`;
    return;
  }

  // Format a rate-grid section (self-reported or admin)
  function rateGrid(rateObj, label, color) {
    if (!rateObj || !Object.keys(rateObj).length) return `<div style="font-size:12px;color:var(--gray-400);padding:8px 0">No ${label} submitted</div>`;
    return `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">${
      Object.entries(rateObj).map(([k,v]) =>
        `<div style="background:${color};border-radius:8px;padding:10px">
          <div style="font-size:11px;color:var(--gray-400)">${k}</div>
          <div style="font-size:15px;font-weight:600;font-family:'DM Serif Display',serif">${v?'¬£'+v:'‚Äî'}</div>
        </div>`
      ).join('')
    }</div>`;
  }

  const socials = [
    ob.tiktok    ? {icon:'üéµ',name:'TikTok',    url:ob.tiktok}    : null,
    ob.instagram ? {icon:'üì∏',name:'Instagram', url:ob.instagram} : null,
    ob.youtube   ? {icon:'‚ñ∂Ô∏è', name:'YouTube',   url:ob.youtube}   : null,
    ob.other     ? {icon:'üîó',name:'Other',     url:ob.other}     : null,
  ].filter(Boolean);

  const srRates   = ob.rates  || {};
  const srUsage   = ob.usage  || {};
  const aoRates   = ao.rates  || null;
  const aoUsage   = ao.usage  || null;

  el.innerHTML = `
    <!-- Socials -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title" style="margin-bottom:12px">Social Platforms</div>
      ${socials.length ? `<div style="display:flex;flex-direction:column;gap:8px">${
        socials.map(s => `<div style="display:flex;align-items:center;gap:10px;padding:10px;background:var(--gray-50);border-radius:10px">
          <span style="font-size:18px">${s.icon}</span>
          <div>
            <div style="font-size:13px;font-weight:600">${s.name}</div>
            <a href="${s.url}" target="_blank" style="font-size:11px;color:var(--blue)">${s.url}</a>
          </div>
        </div>`).join('')
      }</div>` : `<div style="font-size:12px;color:var(--gray-400)">No social links provided</div>`}
    </div>

    <!-- Stats row -->
    <div class="card" style="margin-bottom:14px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="card-title">Stats</div>
        <button class="btn btn-ghost btn-sm" onclick="openAdminStatsModal(${c.id})">‚úèÔ∏è Edit Admin Stats</button>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
        ${[
          ['Followers',   ao.followers  || ob.followers  || '‚Äî', !!ao.followers],
          ['Eng. Rate',   (ao.engagementRate != null ? ao.engagementRate : (ob.engagementRate||'‚Äî'))+(ao.engagementRate||ob.engagementRate?'%':''), !!(ao.engagementRate!=null)],
          ['Avg. Views',  ao.avgViews   || ob.avgViews   || '‚Äî', !!ao.avgViews],
          ['Audience',    ao.audience   || ob.audience   || '‚Äî', !!ao.audience],
        ].map(([label, val, isAdminSet]) => `
          <div style="background:var(--gray-50);border-radius:10px;padding:12px;text-align:center;position:relative">
            ${isAdminSet ? `<div style="position:absolute;top:6px;right:6px;font-size:9px;background:var(--blue);color:white;border-radius:4px;padding:1px 4px">admin</div>` : ''}
            <div style="font-family:'DM Serif Display',serif;font-size:20px;color:var(--blue)">${val}</div>
            <div style="font-size:11px;color:var(--gray-400)">${label}</div>
          </div>
        `).join('')}
      </div>
    </div>

    <!-- Self-reported rates + usage -->
    <div class="card" style="margin-bottom:14px">
      <div class="card-title" style="margin-bottom:4px">Self-Reported Rates</div>
      <div style="font-size:11px;color:var(--gray-400);margin-bottom:12px">Submitted by creator during onboarding ‚Äî read only</div>
      ${rateGrid(srRates, 'rates', 'var(--gray-50)')}
      ${Object.keys(srUsage).length ? `
        <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin:14px 0 10px">Usage / Licensing (self-reported)</div>
        ${rateGrid(srUsage, 'usage', 'var(--gray-50)')}
      ` : `<div style="font-size:12px;color:var(--gray-400);margin-top:10px">No usage rates submitted</div>`}
      ${ob.extraFees ? `<div style="margin-top:10px;font-size:12px;color:var(--gray-600)"><strong>Additional fees:</strong> ${ob.extraFees}</div>` : ''}
    </div>

    <!-- Admin override rates -->
    <div class="card" style="margin-bottom:14px;border-left:3px solid var(--blue)">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div>
          <div class="card-title">BluStu Admin Rates</div>
          <div style="font-size:11px;color:var(--gray-400)">Used in kits and rate cards ‚Äî overrides self-reported</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openAdminRatesModal(${c.id})">‚úèÔ∏è Edit Admin Rates</button>
      </div>
      ${aoRates ? rateGrid(aoRates, 'admin rates', 'var(--blue-light)') : `<div style="font-size:12px;color:var(--gray-400)">No admin rates set ‚Äî kits use self-reported values</div>`}
      ${aoUsage ? `
        <div style="font-size:12px;font-weight:600;color:var(--gray-600);margin:14px 0 10px">Admin Usage / Licensing</div>
        ${rateGrid(aoUsage, 'admin usage', 'var(--blue-light)')}
      ` : (aoRates ? `<div style="font-size:12px;color:var(--gray-400);margin-top:10px">No admin usage rates set</div>` : '')}
    </div>

    <!-- Bio and restrictions -->
    ${ob.bio ? `<div class="card" style="margin-bottom:14px"><div class="card-title" style="margin-bottom:6px">Bio</div><div style="font-size:13px;color:var(--gray-600)">${ob.bio}</div></div>` : ''}
    ${ob.restrictions ? `<div class="card"><div style="font-size:12px;font-weight:600;color:var(--red);margin-bottom:4px">‚ö†Ô∏è Brand Restrictions</div><div style="font-size:12px;color:var(--gray-600)">${ob.restrictions}</div></div>` : ''}
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ADMIN RATES MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openAdminRatesModal(creatorId) {
  const c = creators.find(x => x.id === creatorId);
  if (!c) return;
  currentCreatorId = creatorId;
  const ao = adminOverrides[creatorId] || {};
  const ob = c.onboarding || {};
  const srRates = ob.rates || {};
  const srUsage = ob.usage || {};
  const aoRates = ao.rates || {};
  const aoUsage = ao.usage || {};

  const RATE_TYPES = ['TikTok Video','Instagram Reel','Instagram Story','YouTube','Long-form'];
  const USAGE_TYPES = ['30 days','60 days','90 days','Perpetual'];

  const modal = document.getElementById('adminRatesModal');
  document.getElementById('adminRatesModalTitle').textContent = `Admin Rates ‚Äî ${c.name}`;

  document.getElementById('adminRatesBody').innerHTML = `
    <div style="font-size:12px;color:var(--blue);background:var(--blue-light);border-radius:8px;padding:10px;margin-bottom:16px">
      ‚ÑπÔ∏è These values override self-reported rates in media kits and rate cards. Self-reported values remain unchanged.
    </div>
    <div style="font-weight:600;font-size:13px;margin-bottom:10px">Deliverable Rates</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px">
      ${RATE_TYPES.map(k => `
        <div class="form-group">
          <label class="form-label">${k}</label>
          <div style="font-size:11px;color:var(--gray-400);margin-bottom:4px">Self-reported: ${srRates[k] ? '¬£'+srRates[k] : 'Not provided'}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="color:var(--gray-400);font-size:13px">¬£</span>
            <input class="form-input admin-rate-input" data-key="${k}" placeholder="${srRates[k]||'0'}" value="${aoRates[k]||''}" type="number" min="0">
          </div>
        </div>
      `).join('')}
    </div>
    <div style="font-weight:600;font-size:13px;margin-bottom:10px">Usage / Licensing</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
      ${USAGE_TYPES.map(k => `
        <div class="form-group">
          <label class="form-label">${k} usage</label>
          <div style="font-size:11px;color:var(--gray-400);margin-bottom:4px">Self-reported: ${srUsage[k] ? '¬£'+srUsage[k] : 'Not provided'}</div>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="color:var(--gray-400);font-size:13px">¬£</span>
            <input class="form-input admin-usage-input" data-key="${k}" placeholder="${srUsage[k]||'0'}" value="${aoUsage[k]||''}" type="number" min="0">
          </div>
        </div>
      `).join('')}
    </div>
  `;
  openModal('adminRatesModal');
}

async function saveAdminRates() {
  const id = currentCreatorId;
  if (!id) return;
  if (!adminOverrides[id]) adminOverrides[id] = {};

  const rates = {};
  document.querySelectorAll('.admin-rate-input').forEach(el => {
    if (el.value !== '') rates[el.dataset.key] = el.value;
  });
  const usage = {};
  document.querySelectorAll('.admin-usage-input').forEach(el => {
    if (el.value !== '') usage[el.dataset.key] = el.value;
  });

  adminOverrides[id].rates = Object.keys(rates).length ? rates : null;
  adminOverrides[id].usage = Object.keys(usage).length ? usage : null;
  adminOverrides[id].updatedBy = currentUser ? currentUser.name : 'admin';
  adminOverrides[id].updatedAt = new Date().toISOString();

  await saveAdminOverrides();
  closeModal('adminRatesModal');
  showToast('‚úÖ Admin rates saved!');
  // Re-render socials tab
  const c = creators.find(x => x.id === id);
  if (c) renderProfileSocials(c);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ADMIN STATS MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openAdminStatsModal(creatorId) {
  const c = creators.find(x => x.id === creatorId);
  if (!c) return;
  currentCreatorId = creatorId;
  const ao = adminOverrides[creatorId] || {};
  const ob = c.onboarding || {};

  document.getElementById('adminStatsModalTitle').textContent = `Admin Stats ‚Äî ${c.name}`;
  document.getElementById('adminStatsBody').innerHTML = `
    <div style="font-size:12px;color:var(--blue);background:var(--blue-light);border-radius:8px;padding:10px;margin-bottom:16px">
      ‚ÑπÔ∏è Set verified stats for this creator. Used in media kits, rate cards, and campaign grid.
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Followers</label>
        <div style="font-size:11px;color:var(--gray-400);margin-bottom:4px">Self-reported: ${ob.followers||'Not provided'}</div>
        <input class="form-input" id="as-followers" placeholder="e.g. 45.2K" value="${ao.followers||''}">
      </div>
      <div class="form-group">
        <label class="form-label">Avg. Views</label>
        <div style="font-size:11px;color:var(--gray-400);margin-bottom:4px">Self-reported: ${ob.avgViews||'Not provided'}</div>
        <input class="form-input" id="as-avgviews" placeholder="e.g. 12K" value="${ao.avgViews||''}">
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">Engagement Rate (%)</label>
        <div style="font-size:11px;color:var(--gray-400);margin-bottom:4px">Self-reported: ${ob.engagementRate!=null?ob.engagementRate+'%':'Not provided'}</div>
        <input class="form-input" id="as-engrate" type="number" step="0.1" placeholder="e.g. 4.2" value="${ao.engagementRate!=null?ao.engagementRate:''}">
      </div>
      <div class="form-group">
        <label class="form-label">Audience</label>
        <div style="font-size:11px;color:var(--gray-400);margin-bottom:4px">Self-reported: ${ob.audience||'Not provided'}</div>
        <input class="form-input" id="as-audience" placeholder="e.g. 18-24 UK Female" value="${ao.audience||''}">
      </div>
    </div>
    <div class="form-group">
      <label class="form-label">Niche override</label>
      <div style="font-size:11px;color:var(--gray-400);margin-bottom:4px">Current: ${c.niche||'‚Äî'}</div>
      <input class="form-input" id="as-niche" placeholder="Leave blank to use profile niche" value="${ao.niche||''}">
    </div>
  `;
  openModal('adminStatsModal');
}

async function saveAdminStats() {
  const id = currentCreatorId;
  if (!id) return;
  if (!adminOverrides[id]) adminOverrides[id] = {};

  const ao = adminOverrides[id];
  const followers = document.getElementById('as-followers').value.trim();
  const avgViews  = document.getElementById('as-avgviews').value.trim();
  const engRate   = document.getElementById('as-engrate').value;
  const audience  = document.getElementById('as-audience').value.trim();
  const niche     = document.getElementById('as-niche').value.trim();

  if (followers) ao.followers = followers; else delete ao.followers;
  if (avgViews)  ao.avgViews  = avgViews;  else delete ao.avgViews;
  if (engRate !== '') ao.engagementRate = parseFloat(engRate); else delete ao.engagementRate;
  if (audience)  ao.audience  = audience;  else delete ao.audience;
  if (niche)     ao.niche     = niche;     else delete ao.niche;
  ao.updatedBy = currentUser ? currentUser.name : 'admin';
  ao.updatedAt = new Date().toISOString();

  await saveAdminOverrides();
  closeModal('adminStatsModal');
  showToast('‚úÖ Admin stats saved!');
  const c = creators.find(x => x.id === id);
  if (c) renderProfileSocials(c);
  updateDashStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ MEDIA KIT: Tab switch + admin data + rate kit ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function switchMKTab(name, btn) {
  // Only target mktab-* divs inside the media kit page
  const mkPage = document.getElementById('page-mediakit');
  if (mkPage) mkPage.querySelectorAll('[id^="mktab-"]').forEach(t => t.classList.remove('active'));
  const el = document.getElementById('mktab-'+name);
  if (el) el.classList.add('active');
  // Only deactivate tabs inside media kit page
  if (mkPage) mkPage.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
}

// ‚îÄ‚îÄ Export Kit as PNG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function exportKitAsPng(targetId, filename) {
  if (typeof html2canvas === 'undefined') {
    showToast('Export library loading, please wait and try again‚Ä¶');
    return;
  }

  // Determine the source element to capture
  // For media kit: capture the preview card itself
  // For rate kit: capture the rateKitPreview element
  // For analytics: capture the analytics card
  let sourceEl;
  if (targetId === 'media-kit-export-target') {
    sourceEl = document.querySelector('.media-kit-preview');
  } else if (targetId === 'rateKitExportTarget') {
    sourceEl = document.getElementById('rateKitPreview');
  } else if (targetId === 'analytics-export-target') {
    sourceEl = document.getElementById('kit-analytics-display');
  } else {
    sourceEl = document.getElementById(targetId);
  }

  if (!sourceEl) { showToast('Nothing to export yet ‚Äî generate a kit first'); return; }

  showToast('Generating PNG‚Ä¶');
  try {
    // Force white background on the element temporarily for clean export
    const prevBg = sourceEl.style.backgroundColor;
    sourceEl.style.backgroundColor = '#ffffff';
    const canvas = await html2canvas(sourceEl, {
      scale: 2,             // 2√ó for retina/high-res
      useCORS: true,        // allow cross-origin images (profile pics)
      backgroundColor: '#ffffff',  // solid white ‚Äî no transparency
      logging: false,
      onclone: (doc, clone) => {
        // Ensure cloned element also has white background
        clone.style.backgroundColor = '#ffffff';
        clone.style.padding = clone.style.padding || '16px';
      }
    });
    sourceEl.style.backgroundColor = prevBg;
    const dataUrl = canvas.toDataURL('image/png');
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = (filename || 'blustu-kit') + '-' + new Date().toISOString().slice(0,10) + '.png';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    showToast('‚úÖ PNG exported!');
  } catch(e) {
    console.error('Export error:', e);
    showToast('Export failed ‚Äî try again');
  }
}

function updateKitPreview(){
  const name  = document.getElementById('mk-name').textContent;
  const c     = creators.find(x => x.name === name);
  const bio   = document.getElementById('mk-edit-bio').value;
  const p1    = document.getElementById('mk-edit-p1').value;
  const p2    = document.getElementById('mk-edit-p2').value;
  const foll  = document.getElementById('mk-edit-followers').value;
  const eng   = document.getElementById('mk-edit-eng').value;
  const reach = document.getElementById('mk-edit-reach').value;
  if (bio)   document.getElementById('mk-niche').textContent = bio;
  const engEl    = document.getElementById('mk-stat-eng');
  const reachEl  = document.getElementById('mk-stat-reach');
  const stat1El  = document.getElementById('mk-stat1');
  if (foll   && stat1El)  stat1El.textContent  = foll;
  if (eng    && engEl)    engEl.textContent    = eng+'%';
  if (reach  && reachEl)  reachEl.textContent  = reach;
  document.getElementById('mk-platforms').innerHTML=[p1,p2].filter(Boolean).map(p=>`<div class="mk-platform">${p}</div>`).join('');
}

function saveKitAdminData() {
  const name = document.getElementById('mk-name').textContent;
  const c = creators.find(x => x.name === name);
  if (!c) { showToast('Select a creator first'); return; }

  if (!adminOverrides[c.id]) adminOverrides[c.id] = {};
  const ao = adminOverrides[c.id];

  const followers = document.getElementById('mk-edit-followers').value.trim();
  const engRate   = document.getElementById('mk-edit-eng').value;
  const avgViews  = document.getElementById('mk-edit-reach').value.trim();
  const audience  = document.getElementById('mk-edit-audience').value.trim();

  if (followers) ao.followers = followers; else delete ao.followers;
  if (engRate !== '') ao.engagementRate = parseFloat(engRate); else delete ao.engagementRate;
  if (avgViews)  ao.avgViews  = avgViews;  else delete ao.avgViews;
  if (audience)  ao.audience  = audience;  else delete ao.audience;
  ao.updatedBy = currentUser ? currentUser.name : 'admin';
  ao.updatedAt = new Date().toISOString();

  saveAdminOverrides();
  showToast('‚úÖ Admin kit data saved!');
  updateDashStats();
}

function selectKitPreview(id){
  const c=creators.find(x=>x.id===id);
  if(!c) return;
  onKitCreatorChange(c.name);
  document.getElementById('mk-edit-bio').value = c.onboarding?.bio || c.niche || '';
  // Pre-fill admin fields from resolved values
  const r = resolveCreator(c);
  document.getElementById('mk-edit-followers').value = r.followers || '';
  document.getElementById('mk-edit-eng').value       = r.engRate   != null ? r.engRate : '';
  document.getElementById('mk-edit-reach').value     = r.avgViews  || '';
  const aoAud = (adminOverrides[id]||{}).audience || '';
  document.getElementById('mk-edit-audience').value  = aoAud;
  // Update preview stats
  const stat1El = document.getElementById('mk-stat1');
  const engEl   = document.getElementById('mk-stat-eng');
  const reachEl = document.getElementById('mk-stat-reach');
  if (stat1El)  stat1El.textContent  = r.followers || '‚Äî';
  if (engEl)    engEl.textContent    = r.engRate   != null ? r.engRate+'%' : '‚Äî';
  if (reachEl)  reachEl.textContent  = r.avgViews  || '‚Äî';
  renderKitAnalytics(id);
}

function populateRateKitSelector() {
  const sel = document.getElementById('rateKitSelector');
  if (!sel) return;
  sel.innerHTML = '<option value="">Select creator‚Ä¶</option>' +
    creators.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
}

function renderRateKit(creatorIdStr) {
  const id = parseInt(creatorIdStr);
  const preview = document.getElementById('rateKitPreview');
  const editBody = document.getElementById('rateKitEditBody');
  if (!id || !preview) return;

  const c = creators.find(x => x.id === id);
  if (!c) return;

  const r = resolveCreator(c);
  const ao = adminOverrides[id] || {};
  const ob = c.onboarding || {};

  // Rate kit preview (brand-facing)
  const RATE_TYPES  = ['TikTok Video','Instagram Reel','Instagram Story','YouTube','Long-form'];
  const USAGE_TYPES = ['30 days','60 days','90 days','Perpetual'];

  const filteredRates = RATE_TYPES.filter(k => r.rates[k]);
  const filteredUsage = USAGE_TYPES.filter(k => r.usage[k]);

  preview.innerHTML = `
    <div style="border:1px solid var(--gray-100);border-radius:12px;overflow:hidden">
      <div style="background:var(--blue);color:white;padding:16px 20px">
        <div style="font-size:14px;font-weight:700">${c.name}</div>
        <div style="font-size:11px;opacity:0.8">${r.niche} ¬∑ ${c.location || '‚Äî'}</div>
        <div style="display:flex;gap:16px;margin-top:10px">
          ${r.followers ? `<div><div style="font-size:16px;font-weight:700">${r.followers}</div><div style="font-size:10px;opacity:0.7">Followers</div></div>` : ''}
          ${r.engRate != null ? `<div><div style="font-size:16px;font-weight:700">${r.engRate}%</div><div style="font-size:10px;opacity:0.7">Engagement</div></div>` : ''}
          ${r.audience ? `<div><div style="font-size:13px;font-weight:600">${r.audience}</div><div style="font-size:10px;opacity:0.7">Audience</div></div>` : ''}
        </div>
      </div>
      ${filteredRates.length ? `
        <div style="padding:16px 20px">
          <div style="font-size:11px;font-weight:700;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px">Deliverable Rates</div>
          ${filteredRates.map(k => `
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--gray-100);font-size:13px">
              <span style="color:var(--gray-600)">${k}</span>
              <span style="font-weight:600">¬£${r.rates[k]}</span>
            </div>
          `).join('')}
        </div>
      ` : '<div style="padding:16px 20px;font-size:12px;color:var(--gray-400)">No rates set ‚Äî add admin rates to generate rate kit.</div>'}
      ${filteredUsage.length ? `
        <div style="padding:0 20px 16px">
          <div style="font-size:11px;font-weight:700;color:var(--gray-400);text-transform:uppercase;letter-spacing:.5px;margin:12px 0 10px">Usage / Licensing</div>
          ${filteredUsage.map(k => `
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--gray-100);font-size:13px">
              <span style="color:var(--gray-600)">${k}</span>
              <span style="font-weight:600">¬£${r.usage[k]}</span>
            </div>
          `).join('')}
        </div>
      ` : ''}
      ${ao.updatedBy ? `<div style="padding:8px 20px 12px;font-size:11px;color:var(--gray-400)">Last updated by ${ao.updatedBy}</div>` : ''}
    </div>
    <div style="margin-top:8px;font-size:11px;color:var(--gray-400)">
      ${ao.rates ? '‚úì Using admin rates' : '‚ö†Ô∏è Using self-reported rates ‚Äî admin rates not set for this creator'}
    </div>
  `;

  // Edit panel (admin)
  const RATE_TYPES_ALL  = ['TikTok Video','Instagram Reel','Instagram Story','YouTube','Long-form'];
  const USAGE_TYPES_ALL = ['30 days','60 days','90 days','Perpetual'];
  const aoRates = ao.rates || {};
  const aoUsage = ao.usage || {};
  const srRates = ob.rates || {};
  const srUsage = ob.usage || {};

  editBody.innerHTML = `
    <div style="font-size:12px;color:var(--blue);background:var(--blue-light);border-radius:8px;padding:10px;margin-bottom:16px">
      Admin rates appear on kits and rate cards. Self-reported values are never changed.
    </div>
    <div style="font-weight:600;font-size:13px;margin-bottom:10px">Deliverable Rates</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">
      ${RATE_TYPES_ALL.map(k => `
        <div class="form-group">
          <label class="form-label">${k}</label>
          <div style="font-size:10px;color:var(--gray-400);margin-bottom:3px">SR: ${srRates[k]?'¬£'+srRates[k]:'‚Äî'}</div>
          <div style="display:flex;gap:4px"><span style="color:var(--gray-400);font-size:13px;padding-top:8px">¬£</span>
          <input class="form-input rk-rate-input" data-key="${k}" data-creator="${id}" value="${aoRates[k]||''}" placeholder="${srRates[k]||'0'}" type="number" min="0"></div>
        </div>
      `).join('')}
    </div>
    <div style="font-weight:600;font-size:13px;margin-bottom:10px">Usage / Licensing</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:16px">
      ${USAGE_TYPES_ALL.map(k => `
        <div class="form-group">
          <label class="form-label">${k}</label>
          <div style="font-size:10px;color:var(--gray-400);margin-bottom:3px">SR: ${srUsage[k]?'¬£'+srUsage[k]:'‚Äî'}</div>
          <div style="display:flex;gap:4px"><span style="color:var(--gray-400);font-size:13px;padding-top:8px">¬£</span>
          <input class="form-input rk-usage-input" data-key="${k}" data-creator="${id}" value="${aoUsage[k]||''}" placeholder="${srUsage[k]||'0'}" type="number" min="0"></div>
        </div>
      `).join('')}
    </div>
    <button class="btn btn-primary" onclick="saveRateKitAdmin(${id})">üíæ Save Rate Kit</button>
  `;
}

function saveRateKitAdmin(id) {
  if (!adminOverrides[id]) adminOverrides[id] = {};
  const rates = {};
  document.querySelectorAll('.rk-rate-input').forEach(el => { if (el.value !== '') rates[el.dataset.key] = el.value; });
  const usage = {};
  document.querySelectorAll('.rk-usage-input').forEach(el => { if (el.value !== '') usage[el.dataset.key] = el.value; });
  adminOverrides[id].rates = Object.keys(rates).length ? rates : null;
  adminOverrides[id].usage = Object.keys(usage).length ? usage : null;
  adminOverrides[id].updatedBy = currentUser ? currentUser.name : 'admin';
  adminOverrides[id].updatedAt = new Date().toISOString();
  saveAdminOverrides();
  showToast('‚úÖ Rate kit saved!');
  renderRateKit(String(id)); // refresh preview
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ CAMPAIGN INFLUENCER GRID ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function openCreatorGrid(callbackFn) {
  gridSelectionIds.clear();
  gridCallbackFn = callbackFn || null;
  // Populate niche filter
  const niches = [...new Set(creators.map(c => resolveCreator(c).niche).filter(Boolean))].sort();
  const nicheFilter = document.getElementById('gridNicheFilter');
  if (nicheFilter) {
    nicheFilter.innerHTML = '<option value="">All Niches</option>' + niches.map(n=>`<option>${n}</option>`).join('');
  }
  document.getElementById('gridSearch').value = '';
  renderCreatorGrid(creators);
  showPage('creatorgrid', null);
  document.getElementById('topbarTitle').textContent = 'Select Creators';
}

function closeCreatorGrid() {
  history.back();
  showPage('campaigns', document.querySelector('[onclick*="campaigns"]'));
}

function filterCreatorGrid(q) {
  const search = (document.getElementById('gridSearch').value || '').toLowerCase();
  const niche  = document.getElementById('gridNicheFilter').value;
  const follRange = document.getElementById('gridFollowerFilter').value;

  let list = creators.filter(c => {
    const r = resolveCreator(c);
    const matchSearch = !search || c.name.toLowerCase().includes(search) || (r.niche||'').toLowerCase().includes(search);
    const matchNiche  = !niche  || r.niche === niche;
    let matchFoll = true;
    if (follRange && r.followers) {
      const numFoll = parseFollowers(r.followers);
      if (follRange === '0-10k')    matchFoll = numFoll < 10000;
      if (follRange === '10k-50k')  matchFoll = numFoll >= 10000 && numFoll < 50000;
      if (follRange === '50k-100k') matchFoll = numFoll >= 50000 && numFoll < 100000;
      if (follRange === '100k+')    matchFoll = numFoll >= 100000;
    }
    return matchSearch && matchNiche && matchFoll;
  });
  renderCreatorGrid(list);
}

function parseFollowers(str) {
  if (!str) return 0;
  const s = String(str).replace(/,/g,'').toLowerCase();
  if (s.includes('m')) return parseFloat(s)*1000000;
  if (s.includes('k')) return parseFloat(s)*1000;
  return parseFloat(s)||0;
}

function renderCreatorGrid(list) {
  const el = document.getElementById('creatorGridBody');
  if (!el) return;
  if (!list || !list.length) {
    el.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:var(--gray-400);padding:40px">No creators found</div>';
    return;
  }
  el.innerHTML = list.map(c => {
    const r = resolveCreator(c);
    const pic = profilePics[c.id];
    const avatarHtml = pic
      ? `<img src="${pic}" style="width:56px;height:56px;border-radius:50%;object-fit:cover">`
      : `<div style="width:56px;height:56px;border-radius:50%;background:${avatarColor(c.id)};display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:18px">${avatarLetter(c.name)}</div>`;
    const isSelected = gridSelectionIds.has(c.id);
    return `
      <div class="creator-grid-card${isSelected?' selected':''}" onclick="toggleGridSelect(${c.id})" id="grid-card-${c.id}" style="background:var(--white);border:2px solid ${isSelected?'var(--blue)':'var(--gray-100)'};border-radius:14px;padding:16px;cursor:pointer;transition:all .15s;position:relative">
        ${isSelected?`<div style="position:absolute;top:10px;right:10px;background:var(--blue);color:white;border-radius:50%;width:20px;height:20px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700">‚úì</div>`:''}
        <div style="display:flex;flex-direction:column;align-items:center;text-align:center;gap:8px">
          ${avatarHtml}
          <div style="font-weight:600;font-size:14px">${c.name}</div>
          <div style="font-size:11px;color:var(--blue);background:var(--blue-light);padding:3px 10px;border-radius:20px">${r.niche}</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:12px">
          <div style="background:var(--gray-50);border-radius:8px;padding:8px;text-align:center">
            <div style="font-size:14px;font-weight:700;color:var(--gray-900)">${r.followers||'‚Äî'}</div>
            <div style="font-size:10px;color:var(--gray-400)">Followers</div>
          </div>
          <div style="background:var(--gray-50);border-radius:8px;padding:8px;text-align:center">
            <div style="font-size:14px;font-weight:700;color:var(--green)">${r.engRate!=null?r.engRate+'%':'‚Äî'}</div>
            <div style="font-size:10px;color:var(--gray-400)">Engagement</div>
          </div>
          ${r.audience?`<div style="background:var(--gray-50);border-radius:8px;padding:8px;text-align:center;grid-column:1/-1">
            <div style="font-size:12px;font-weight:600;color:var(--gray-900)">${r.audience}</div>
            <div style="font-size:10px;color:var(--gray-400)">Audience</div>
          </div>`:''}
        </div>
        ${c.onboarding?'':'<div style="margin-top:8px;font-size:10px;color:var(--amber);text-align:center">‚ö†Ô∏è No onboarding data</div>'}
      </div>
    `;
  }).join('');
}

function toggleGridSelect(creatorId) {
  if (gridSelectionIds.has(creatorId)) {
    gridSelectionIds.delete(creatorId);
  } else {
    gridSelectionIds.add(creatorId);
  }
  // Update card border
  const card = document.getElementById('grid-card-'+creatorId);
  const isNowSelected = gridSelectionIds.has(creatorId);
  if (card) {
    card.style.borderColor = isNowSelected ? 'var(--blue)' : 'var(--gray-100)';
    card.innerHTML = card.innerHTML; // re-render via renderCreatorGrid
  }
  // Re-render to update checkmarks properly
  const search = document.getElementById('gridSearch').value;
  filterCreatorGrid(search);
  // Update confirm button
  const btn = document.getElementById('gridConfirmBtn');
  if (btn) {
    btn.disabled = gridSelectionIds.size === 0;
    btn.textContent = gridSelectionIds.size > 0 ? `Add Selected (${gridSelectionIds.size})` : 'Add Selected (0)';
  }
}

function confirmGridSelection() {
  const selected = [...gridSelectionIds].map(id => creators.find(c => c.id === id)).filter(Boolean);
  if (gridCallbackFn) gridCallbackFn(selected);
  showToast(`${selected.length} creator${selected.length>1?'s':''} selected`);
  showPage('campaigns', document.querySelector('[onclick*="campaigns"]'));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SAVE HELPER: adminOverrides to Supabase ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// renderAll is already defined above ‚Äî this hook ensures ratekit stays in sync.
// Since JS function declarations hoist, the second definition wins.
// We already call populateRateKitSelector() in the primary renderAll above,
// so we just remove this duplicate wrapper to avoid infinite recursion.
// (No-op: renderAll is the canonical definition in renderAll() above)

// generateKit override removed ‚Äî logic folded into the main generateKit function above
// (was causing "stuck on Generating‚Ä¶" due to modal-hidden button state mutation)

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ ONBOARDING: Add stats step to portal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTE: We add optional stat fields to collectPortalData so creators
// can submit followers/eng rate directly (still self-reported).
// collectPortalData override removed in v11 ‚Äî stats fields merged into main collectPortalData()

</script>

<!-- Admin Rates Modal -->
<div class="modal-overlay" id="adminRatesModal">
  <div class="modal" style="max-width:620px">
    <div class="modal-header">
      <div class="modal-title" id="adminRatesModalTitle">Admin Rates</div>
      <button class="modal-close" onclick="closeModal('adminRatesModal')">‚úï</button>
    </div>
    <div class="modal-body" id="adminRatesBody"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('adminRatesModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAdminRates()">üíæ Save Admin Rates</button>
    </div>
  </div>
</div>

<!-- Admin Stats Modal -->
<div class="modal-overlay" id="adminStatsModal">
  <div class="modal" style="max-width:560px">
    <div class="modal-header">
      <div class="modal-title" id="adminStatsModalTitle">Admin Stats</div>
      <button class="modal-close" onclick="closeModal('adminStatsModal')">‚úï</button>
    </div>
    <div class="modal-body" id="adminStatsBody"></div>
    <div class="modal-footer">
      <button class="btn btn-ghost" onclick="closeModal('adminStatsModal')">Cancel</button>
      <button class="btn btn-primary" onclick="saveAdminStats()">üíæ Save Stats</button>
    </div>
  </div>
</div>

</body>
</html>
